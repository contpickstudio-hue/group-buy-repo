<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Korean Community Commerce platform for group buying and local errands in Canada">
    <meta name="keywords" content="Korean, community, group buy, errands, Canada, 한인, 커뮤니티, 공동구매">
    <title>Korean Community Commerce | 한인 커뮤니티 커머스</title>
    <!-- 
        ===========================================
        GOOGLE SIGN-IN SETUP INSTRUCTIONS:
        ============================================
        
        1. Go to https://console.cloud.google.com/
        2. Create a new project or select an existing one
        3. Enable Google Identity Services API
        4. Go to "Credentials" > "Create Credentials" > "OAuth client ID"
        5. Choose "Web application"
        6. Add authorized JavaScript origins (e.g., http://localhost)
        7. Copy the Client ID and replace the value below in initializeGoogleSignIn()
        8. Serve this file via a local server for Google OAuth to work properly
    -->
    <style>
        /* ============================================
           RESET & BASE STYLES
           ============================================ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
            min-height: 100vh;
        }

        /* ============================================
           NAVIGATION BAR
           ============================================ */
        .navbar {
            background-color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 200;
        }

        .navbar-container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 0 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .navbar-brand {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1d4ed8;
            text-decoration: none;
        }

        .navbar-links {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .nav-link {
            color: #475569;
            text-decoration: none;
            font-weight: 500;
            font-size: 0.95rem;
            transition: color 0.2s ease;
        }

        .nav-link:hover {
            color: #1d4ed8;
        }

        .nav-link.active {
            color: #1d4ed8;
            font-weight: 600;
        }

        .navbar-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* Version Info */
        .version-info {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-family: monospace;
            z-index: 1000;
            user-select: none;
            pointer-events: none;
        }

        /* ============================================
           MOBILE BOTTOM NAVIGATION
           ============================================ */
        .bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e5e7eb;
            padding: 8px 0 calc(8px + env(safe-area-inset-bottom));
            z-index: 300;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        .bottom-nav-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            max-width: 100%;
            margin: 0 auto;
        }

        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 12px;
            text-decoration: none;
            color: #6b7280;
            font-size: 0.75rem;
            font-weight: 500;
            transition: color 0.2s ease;
            cursor: pointer;
            min-width: 60px;
        }

        .bottom-nav-item.active {
            color: #3b82f6;
        }

        .bottom-nav-item:hover {
            color: #3b82f6;
        }

        .bottom-nav-icon {
            font-size: 1.25rem;
            margin-bottom: 2px;
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: #3b82f6;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            cursor: pointer;
            z-index: 250;
            transition: all 0.3s ease;
            border: none;
            color: white;
            font-size: 1.5rem;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.5);
        }

        .fab:active {
            transform: scale(0.95);
        }

        .fab-menu {
            position: fixed;
            bottom: 160px;
            right: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            padding: 8px;
            z-index: 999;
            display: none;
            min-width: 200px;
        }

        .fab-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
            padding: 12px 16px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            text-align: left;
        }

        .fab-menu-item:hover {
            background-color: #f3f4f6;
        }

        .fab-menu-icon {
            font-size: 1.25rem;
            width: 24px;
            text-align: center;
        }

        .fab-menu-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
        }

        /* Profile Page Styles */
        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 24px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border-radius: 12px;
            color: white;
            margin-bottom: 24px;
        }

        .profile-avatar {
            flex-shrink: 0;
        }

        .avatar-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: 600;
            color: white;
        }

        .profile-info h3 {
            margin: 0 0 8px 0;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .profile-email {
            margin: 0 0 12px 0;
            opacity: 0.9;
            font-size: 0.95rem;
        }

        .profile-roles {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .role-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .role-badge.role-customer {
            background: rgba(16, 185, 129, 0.2);
            color: #059669;
        }

        .role-badge.role-vendor {
            background: rgba(245, 158, 11, 0.2);
            color: #d97706;
        }

        .role-badge.role-helper {
            background: rgba(139, 92, 246, 0.2);
            color: #7c3aed;
        }

        .verification-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            background: rgba(34, 197, 94, 0.2);
            color: #16a34a;
        }

        .settings-list {
            display: flex;
            flex-direction: column;
            gap: 1px;
            background: #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
        }

        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: white;
            gap: 16px;
        }

        .setting-info {
            flex: 1;
        }

        .setting-title {
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
        }

        .setting-description {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .helper-profile-card {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
        }

        .helper-status {
            margin-bottom: 16px;
        }

        .status-indicator {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-indicator.verified {
            background: #dcfce7;
            color: #166534;
        }

        .status-indicator.pending {
            background: #fef3c7;
            color: #92400e;
        }

        .helper-details {
            margin-bottom: 16px;
        }

        .helper-details p {
            margin: 8px 0;
            color: #374151;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .profile-header {
                flex-direction: column;
                text-align: center;
                gap: 16px;
            }

            .avatar-circle {
                width: 60px;
                height: 60px;
                font-size: 1.5rem;
            }

            .profile-info h3 {
                font-size: 1.25rem;
            }

            .setting-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .action-buttons {
                flex-direction: column;
            }
        }

        /* Touch-friendly form elements */
        .form-input,
        .form-select,
        select,
        input[type="text"],
        input[type="email"],
        input[type="password"],
        input[type="number"],
        input[type="date"],
        input[type="datetime-local"],
        textarea {
            min-height: 44px;
            font-size: 16px; /* Prevents zoom on iOS */
            padding: 12px 16px;
        }

        .btn,
        button {
            min-height: 44px;
            padding: 12px 20px;
            font-size: 16px;
        }

        .primary-cta {
            min-height: 48px;
            font-size: 16px;
            font-weight: 600;
        }

        /* Touch-friendly checkboxes and radio buttons */
        .role-option {
            min-height: 60px;
            padding: 16px;
        }

        .role-icon {
            width: 3rem;
            height: 3rem;
            font-size: 1.75rem;
        }

        /* Mobile-specific adjustments */
        @media (max-width: 768px) {
            /* Show bottom navigation */
            .bottom-nav {
                display: block;
            }

            /* Hide desktop navigation on mobile */
            .navbar-links {
                display: none;
            }

            /* Add bottom padding to main content */
            main {
                padding-bottom: 80px;
            }

            /* Adjust version info position */
            .version-info {
                bottom: 90px;
                right: 20px;
                z-index: 200;
            }

            /* Make dropdowns touch-friendly */
            select {
                appearance: none;
                background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
                background-repeat: no-repeat;
                background-position: right 12px center;
                background-size: 16px;
                padding-right: 40px;
            }

            /* Larger touch targets for list items */
            .list-card,
            .product-card,
            .errand-card {
                padding: 20px;
                margin-bottom: 12px;
            }

            /* Sticky primary actions */
            .screen-actions {
                position: sticky;
                bottom: 20px;
                background: white;
                padding: 16px 0;
                margin-top: 20px;
                border-top: 1px solid #e5e7eb;
            }

            /* Form improvements */
            .form-group {
                margin-bottom: 20px;
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            /* Modal adjustments */
            .modal-content {
                margin: 20px;
                max-height: calc(100vh - 40px);
                overflow-y: auto;
            }

            /* Card grid responsive */
            .card-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            /* Navigation adjustments */
            .navbar {
                padding: 12px 0;
            }

            .navbar-container {
                padding: 0 20px;
            }

            /* Thumb-friendly spacing */
            .stacked-list .list-item {
                padding: 16px 20px;
            }

            /* Better button spacing */
            .btn + .btn {
                margin-left: 12px;
            }
        }

        @media (max-width: 480px) {
            /* Extra small screens */
            .fab {
                bottom: 100px;
                right: 16px;
                width: 52px;
                height: 52px;
            }

            .bottom-nav-item {
                padding: 6px 8px;
                min-width: 50px;
            }

            .bottom-nav-icon {
                font-size: 1.1rem;
            }

            /* Compact form elements */
            .form-input,
            .btn {
                min-height: 42px;
            }

            .primary-cta {
                min-height: 46px;
            }
        }

        /* ============================================
           ACCESSIBILITY & LANGUAGE SUPPORT
           ============================================ */
        
        /* High Contrast & Accessible Colors */
        :root {
            --primary-blue: #1d4ed8;
            --primary-blue-hover: #1e40af;
            --primary-blue-light: #dbeafe;
            --success-green: #059669;
            --success-green-light: #d1fae5;
            --warning-orange: #d97706;
            --warning-orange-light: #fed7aa;
            --error-red: #dc2626;
            --error-red-light: #fecaca;
            --neutral-50: #f9fafb;
            --neutral-100: #f3f4f6;
            --neutral-200: #e5e7eb;
            --neutral-300: #d1d5db;
            --neutral-400: #9ca3af;
            --neutral-500: #6b7280;
            --neutral-600: #4b5563;
            --neutral-700: #374151;
            --neutral-800: #1f2937;
            --neutral-900: #111827;
        }

        /* Language Toggle */
        .language-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: white;
            border: 2px solid var(--neutral-200);
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .language-btn {
            background: none;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            color: var(--neutral-600);
        }

        .language-btn:hover {
            background: var(--neutral-100);
            color: var(--neutral-800);
        }

        .language-btn.active {
            background: var(--primary-blue);
            color: white;
        }

        .language-btn:focus {
            outline: 2px solid var(--primary-blue);
            outline-offset: 2px;
        }

        /* Screen Reader Only Content */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Skip Links */
        .skip-links {
            position: absolute;
            top: -40px;
            left: 6px;
            background: var(--primary-blue);
            color: white;
            padding: 8px;
            text-decoration: none;
            border-radius: 0 0 4px 4px;
            z-index: 1000;
            transition: top 0.3s;
        }

        .skip-links:focus {
            top: 0;
        }

        /* Focus Indicators */
        *:focus {
            outline: 2px solid var(--primary-blue);
            outline-offset: 2px;
        }

        button:focus,
        input:focus,
        select:focus,
        textarea:focus,
        a:focus {
            outline: 2px solid var(--primary-blue);
            outline-offset: 2px;
        }

        /* High Contrast Mode Support */
        @media (prefers-contrast: high) {
            :root {
                --primary-blue: #0000ff;
                --success-green: #008000;
                --warning-orange: #ff8c00;
                --error-red: #ff0000;
                --neutral-800: #000000;
                --neutral-600: #333333;
            }
            
            .btn, .primary-cta {
                border: 2px solid currentColor;
            }
        }

        /* Reduced Motion Support */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }

        /* Dark Mode Support */
        @media (prefers-color-scheme: dark) {
            :root {
                --neutral-50: #1f2937;
                --neutral-100: #374151;
                --neutral-200: #4b5563;
                --neutral-800: #f9fafb;
                --neutral-900: #ffffff;
            }
            
            body {
                background-color: var(--neutral-50);
                color: var(--neutral-900);
            }
            
            .navbar, .search-filters, .modal-content {
                background-color: var(--neutral-100);
                border-color: var(--neutral-200);
            }
        }

        /* Improved Color Contrast */
        .primary-cta {
            background-color: var(--primary-blue);
            color: white;
            border: none;
        }

        .primary-cta:hover {
            background-color: var(--primary-blue-hover);
        }

        .btn-secondary {
            background-color: white;
            color: var(--neutral-700);
            border: 2px solid var(--neutral-300);
        }

        .btn-secondary:hover {
            background-color: var(--neutral-50);
            border-color: var(--neutral-400);
        }

        .success-message {
            background-color: var(--success-green-light);
            color: var(--success-green);
            border: 1px solid var(--success-green);
        }

        .warning-message {
            background-color: var(--warning-orange-light);
            color: var(--warning-orange);
            border: 1px solid var(--warning-orange);
        }

        .error-message {
            background-color: var(--error-red-light);
            color: var(--error-red);
            border: 1px solid var(--error-red);
        }

        /* Accessible Form Elements */
        .form-input:invalid {
            border-color: var(--error-red);
            box-shadow: 0 0 0 3px var(--error-red-light);
        }

        .form-input:valid {
            border-color: var(--success-green);
        }

        .form-label {
            font-weight: 600;
            color: var(--neutral-700);
            margin-bottom: 6px;
            display: block;
        }

        .form-error {
            color: var(--error-red);
            font-size: 0.875rem;
            margin-top: 4px;
            display: block;
        }

        /* Accessible Navigation */
        .navbar-links a[aria-current="page"] {
            background-color: var(--primary-blue-light);
            color: var(--primary-blue);
            font-weight: 600;
        }

        .bottom-nav-item[aria-current="page"] {
            color: var(--primary-blue);
            background-color: var(--primary-blue-light);
        }

        /* Accessible Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: slideInRight 0.3s ease;
        }

        .toast-info {
            background-color: var(--primary-blue);
        }

        .toast-success {
            background-color: var(--success-green);
        }

        .toast-warning {
            background-color: var(--warning-orange);
        }

        .toast-error {
            background-color: var(--error-red);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Improved fieldset styling */
        fieldset {
            border: 2px solid var(--neutral-200);
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }

        legend {
            padding: 0 8px;
            font-weight: 600;
            color: var(--neutral-700);
        }

        /* ============================================
           ANALYTICS & INSIGHTS DASHBOARDS
           ============================================ */
        
        .analytics-dashboard {
            display: grid;
            gap: 24px;
            margin-bottom: 32px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .metric-card {
            background: white;
            border: 1px solid var(--neutral-200);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .metric-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-blue);
            margin-bottom: 4px;
            display: block;
        }

        .metric-label {
            font-size: 0.875rem;
            color: var(--neutral-600);
            font-weight: 500;
        }

        .metric-change {
            font-size: 0.75rem;
            margin-top: 4px;
            font-weight: 500;
        }

        .metric-change.positive {
            color: var(--success-green);
        }

        .metric-change.negative {
            color: var(--error-red);
        }

        .metric-change.neutral {
            color: var(--neutral-500);
        }

        .chart-container {
            background: white;
            border: 1px solid var(--neutral-200);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--neutral-800);
        }

        .chart-period {
            font-size: 0.875rem;
            color: var(--neutral-500);
        }

        .simple-bar-chart {
            display: flex;
            align-items: end;
            gap: 8px;
            height: 200px;
            padding: 20px 0;
        }

        .bar {
            flex: 1;
            background: linear-gradient(to top, var(--primary-blue), var(--primary-blue-light));
            border-radius: 4px 4px 0 0;
            min-height: 4px;
            position: relative;
            transition: all 0.3s ease;
        }

        .bar:hover {
            filter: brightness(1.1);
        }

        .bar-label {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            color: var(--neutral-600);
            white-space: nowrap;
        }

        .bar-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--neutral-700);
            background: white;
            padding: 2px 6px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .bar:hover .bar-value {
            opacity: 1;
        }

        .category-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }

        .category-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--neutral-50);
            border-radius: 8px;
        }

        .category-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .category-name {
            font-size: 0.875rem;
            color: var(--neutral-700);
            flex: 1;
        }

        .category-value {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--neutral-800);
        }

        .insights-list {
            background: white;
            border: 1px solid var(--neutral-200);
            border-radius: 12px;
            padding: 24px;
        }

        .insight-item {
            display: flex;
            align-items: start;
            gap: 12px;
            padding: 16px 0;
            border-bottom: 1px solid var(--neutral-100);
        }

        .insight-item:last-child {
            border-bottom: none;
        }

        .insight-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .insight-icon.success {
            background: var(--success-green-light);
            color: var(--success-green);
        }

        .insight-icon.warning {
            background: var(--warning-orange-light);
            color: var(--warning-orange);
        }

        .insight-icon.info {
            background: var(--primary-blue-light);
            color: var(--primary-blue);
        }

        .insight-content {
            flex: 1;
        }

        .insight-title {
            font-weight: 600;
            color: var(--neutral-800);
            margin-bottom: 4px;
        }

        .insight-description {
            font-size: 0.875rem;
            color: var(--neutral-600);
            line-height: 1.4;
        }

        .top-items-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .top-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--neutral-50);
            border-radius: 8px;
        }

        .top-item-rank {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary-blue);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .top-item-info {
            flex: 1;
        }

        .top-item-name {
            font-weight: 500;
            color: var(--neutral-800);
            margin-bottom: 2px;
        }

        .top-item-meta {
            font-size: 0.75rem;
            color: var(--neutral-500);
        }

        .top-item-value {
            font-weight: 600;
            color: var(--primary-blue);
        }

        @media (max-width: 768px) {
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .metric-card {
                padding: 16px;
            }

            .metric-value {
                font-size: 1.5rem;
            }

            .chart-container {
                padding: 16px;
            }

            .simple-bar-chart {
                height: 150px;
            }

            .category-breakdown {
                grid-template-columns: 1fr;
            }
        }

        /* ============================================
           ENHANCED SEARCH & FILTERS
           ============================================ */
        .search-filters {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }

        .search-bar {
            position: relative;
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px 12px 44px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
            font-size: 1.1rem;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
        }

        .filter-select {
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: border-color 0.2s ease;
        }

        .filter-select:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .filter-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .filter-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #eff6ff;
            color: #1d4ed8;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-chip:hover {
            background: #dbeafe;
        }

        .filter-chip.active {
            background: #3b82f6;
            color: white;
        }

        .filter-chip .remove-icon {
            font-size: 0.75rem;
            opacity: 0.7;
        }

        .filter-chip .remove-icon:hover {
            opacity: 1;
        }

        .quick-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }

        .quick-filter {
            padding: 8px 16px;
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 20px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quick-filter:hover {
            background: #e5e7eb;
        }

        .quick-filter.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .results-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding: 12px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .results-count {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .sort-dropdown {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.875rem;
        }

        .category-icon {
            font-size: 1.1rem;
            margin-right: 6px;
        }

        .popularity-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.75rem;
            color: #f59e0b;
            font-weight: 500;
        }

        .trending-badge {
            background: linear-gradient(45deg, #f59e0b, #d97706);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .filter-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .search-filters {
                padding: 16px;
                margin-bottom: 16px;
            }

            .quick-filters {
                justify-content: center;
            }

            .results-summary {
                flex-direction: column;
                gap: 8px;
                align-items: flex-start;
            }
        }

        .profile-pill {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.35rem 0.85rem;
            background: #eef2ff;
            border-radius: 999px;
            font-size: 0.9rem;
        }

        .profile-pill img {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #c7d2fe;
        }

        .role-badge {
            padding: 0.2rem 0.6rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
            background-color: #4f46e5;
        }

        .role-badge.helper {
            background-color: #059669;
        }

        .verification-badge {
            font-size: 0.75rem;
            color: #059669;
            font-weight: 600;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        .btn:hover {
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #7f8c8d;
        }

        .user-greeting {
            color: #333;
            font-size: 0.9rem;
        }

        /* ============================================
           LAYOUT / SCREENS
           ============================================ */
        .app-shell {
            max-width: 960px;
            margin: 0 auto;
            padding: 3rem 1.5rem 4rem;
        }

        .screen {
            display: none;
            background: white;
            border-radius: 16px;
            padding: 2.5rem;
            box-shadow: 0 15px 40px rgba(15, 23, 42, 0.08);
        }

        .screen.active {
            display: block;
            animation: fadeIn 0.35s ease;
        }

        .screen-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .screen-heading {
            font-size: 2.25rem;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 0.5rem;
        }

        .screen-subtitle {
            color: #64748b;
            font-size: 1rem;
        }

        .auth-options {
            max-width: 420px;
            margin: 0 auto;
        }

        /* Streamlined Form Layout */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .optional-text {
            font-size: 0.85rem;
            color: #6b7280;
            font-weight: normal;
        }

        /* Compact Role Selection */
        .role-selection-compact {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-top: 0.5rem;
        }

        .role-checkbox {
            cursor: pointer;
            display: block;
        }

        .role-checkbox input[type="checkbox"] {
            display: none;
        }

        .role-option {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            transition: all 0.2s ease;
            background: white;
        }

        .role-checkbox:hover .role-option {
            border-color: #3b82f6;
            background: #f8faff;
        }

        .role-checkbox input[type="checkbox"]:checked + .role-option {
            border-color: #3b82f6;
            background: #eff6ff;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .role-icon {
            font-size: 1.5rem;
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f3f4f6;
            border-radius: 6px;
            flex-shrink: 0;
        }

        .role-checkbox input[type="checkbox"]:checked + .role-option .role-icon {
            background: #dbeafe;
        }

        .role-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .role-info strong {
            font-weight: 600;
            color: #111827;
        }

        .role-info span {
            font-size: 0.875rem;
            color: #6b7280;
        }

        @media (max-width: 480px) {
            .form-row {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
        }

        .view-content {
            background: white;
            border-radius: 14px;
            padding: 1.75rem;
            box-shadow: 0 6px 20px rgba(15, 23, 42, 0.06);
        }

        .browse-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .dashboard-content > .view-content + .view-content {
            margin-top: 1.25rem;
        }

        .divider span {
            padding: 0 0.5rem;
        }

        .list-card {
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1rem 1.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            margin-top: 1rem;
            background: #f8fafc;
        }

        .list-card strong {
            color: #0f172a;
        }

        .list-card p {
            margin: 0.25rem 0 0;
            color: #475569;
            font-size: 0.9rem;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.2rem 0.65rem;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .badge.success {
            background: #dcfce7;
            color: #15803d;
        }

        .badge.info {
            background: #e0f2fe;
            color: #0369a1;
        }

        .primary-cta {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.9rem 2.5rem;
            border-radius: 999px;
            background: linear-gradient(135deg, #2563eb, #7c3aed);
            color: white;
            font-size: 1.05rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s;
            box-shadow: 0 20px 35px rgba(37, 99, 235, 0.25);
        }

        .primary-cta:hover {
            transform: translateY(-2px);
            box-shadow: 0 25px 45px rgba(37, 99, 235, 0.3);
        }

        /* Reusable cards */
        .card {
            background: white;
            border-radius: 18px;
            border: 1px solid #e2e8f0;
            padding: 1.5rem;
            box-shadow: 0 15px 35px rgba(15, 23, 42, 0.06);
            transition: transform 0.25s ease, box-shadow 0.25s ease;
            cursor: pointer;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 25px 45px rgba(15, 23, 42, 0.09);
        }

        .card h4 {
            margin-bottom: 0.5rem;
            color: #0f172a;
        }

        .card-cover {
            width: 100%;
            height: 140px;
            border-radius: 12px;
            margin-bottom: 1rem;
            object-fit: cover;
            background: #e2e8f0;
        }

        .card-meta {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 0.75rem;
            font-size: 0.9rem;
            color: #475569;
            margin-top: 0.75rem;
        }

        .pill {
            display: inline-flex;
            align-items: center;
            padding: 0.2rem 0.75rem;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 600;
            background: #e2e8f0;
            color: #0f172a;
        }

        .pill.info {
            background: #dbeafe;
            color: #1d4ed8;
        }

        .pill.success {
            background: #dcfce7;
            color: #15803d;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            border-radius: 999px;
            background: #e2e8f0;
            margin-top: 0.75rem;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 999px;
            background: linear-gradient(90deg, #2563eb, #7c3aed);
            width: 0%;
            transition: width 0.3s ease;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.2rem 0.65rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        .status-open { background:#dbeafe; color:#1d4ed8; }
        .status-closed { background:#e2e8f0; color:#475569; }
        .status-succeeded { background:#dcfce7; color:#15803d; }
        .status-failed { background:#fee2e2; color:#b91c1c; }
        .status-cancelled { background:#fef3c7; color:#92400e; }
        .status-matched { background:#ede9fe; color:#6d28d9; }
        .status-in_progress { background:#fef3c7; color:#b45309; }
        .status-completed { background:#d1fae5; color:#047857; }
        .status-confirmed { background:#ddd6fe; color:#5b21b6; }
        .status-accepted { background:#dcfce7; color:#15803d; }
        .status-declined { background:#fee2e2; color:#b91c1c; }
        .status-withdrawn { background:#e5e7eb; color:#4b5563; }
        .status-pending { background:#e0f2fe; color:#0369a1; }
        .status-prepared { background:#ede9fe; color:#5b21b6; }
        .status-delivered { background:#d1fae5; color:#047857; }

        .toast-container {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            z-index: 600;
        }

        .toast {
            min-width: 260px;
            padding: 0.85rem 1.25rem;
            border-radius: 12px;
            color: white;
            box-shadow: 0 20px 35px rgba(15, 23, 42, 0.2);
            opacity: 0;
            transform: translateY(-10px);
            animation: toastIn 0.3s forwards;
        }

        .toast.success { background: linear-gradient(135deg,#34d399,#059669); }
        .toast.info { background: linear-gradient(135deg,#60a5fa,#2563eb); }
        .toast.warning { background: linear-gradient(135deg,#fbbf24,#f97316); }
        .toast.error { background: linear-gradient(135deg,#f87171,#ef4444); }

        .success-pulse {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            width: 90px;
            height: 90px;
            border-radius: 999px;
            background: rgba(34,197,94,0.15);
            border: 2px solid #34d399;
            display: none;
            align-items: center;
            justify-content: center;
            color: #047857;
            font-size: 2rem;
            z-index: 601;
            animation: pulseFade 0.8s ease;
        }

        .success-pulse.show {
            display: flex;
        }

        .form-error {
            color: #dc2626;
            font-size: 0.85rem;
            margin-top: 0.35rem;
        }

        .svg-template-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.75rem;
            color: #475569;
        }

        .svg-template-btn:hover {
            border-color: #6366f1;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
        }

        .svg-template-btn.selected {
            border-color: #6366f1;
            background: #eef2ff;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .svg-template-btn:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        @keyframes toastIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulseFade {
            from { opacity: 1; transform: translate(-50%, -10px) scale(0.95); }
            to { opacity: 0; transform: translate(-50%, -30px) scale(1.2); }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .filter-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
            align-items: center;
        }

        .filter-bar .form-input,
        .filter-bar .form-select {
            flex: 1;
            min-width: 180px;
        }

        .hover-link {
            color: #2563eb;
            font-weight: 600;
            text-decoration: none;
        }

        .hover-link:hover {
            text-decoration: underline;
        }

        /* Modal styling */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.55);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 500;
        }

        .modal-overlay.active {
            display: flex;
            animation: fadeIn 0.25s ease;
        }

        .modal-panel {
            background: white;
            border-radius: 24px;
            padding: 2rem;
            width: min(640px, 100%);
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 35px 60px rgba(15, 23, 42, 0.25);
            animation: slideUp 0.25s ease;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            border: none;
            background: transparent;
            font-size: 1.5rem;
            cursor: pointer;
            color: #94a3b8;
        }

        .modal-title {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: #0f172a;
        }

        .modal-subtitle {
            color: #475569;
            margin-bottom: 1.5rem;
        }

        .modal-footer {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-top: 1.75rem;
            justify-content: flex-end;
        }

        .btn-ghost {
            background: transparent;
            color: #2563eb;
            border: 1px solid rgba(37, 99, 235, 0.3);
        }

        .btn-ghost:hover {
            background: rgba(37, 99, 235, 0.08);
        }

        .view-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .view-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .stacked-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .reset-btn {
            background: #f87171;
            color: white;
        }

        .reset-btn:hover {
            background: #ef4444;
        }

        /* ============================================
           CARDS / FORMS / COMPONENTS
           ============================================ */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.25rem;
        }

        .role-card {
            border: 1px solid #e2e8f0;
            border-radius: 14px;
            padding: 1.5rem;
            cursor: pointer;
            transition: border-color 0.2s ease, transform 0.2s;
            background: #f8fafc;
        }

        .role-card:hover {
            border-color: #6366f1;
            transform: translateY(-2px);
        }

        .role-card.active {
            border-color: #4338ca;
            background: #eef2ff;
        }

        .role-card h3 {
            margin-bottom: 0.5rem;
            color: #0f172a;
        }

        .role-card p {
            color: #475569;
            font-size: 0.95rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.45rem;
            font-weight: 600;
            color: #0f172a;
            font-size: 0.9rem;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 0.8rem 0.9rem;
            border-radius: 10px;
            border: 1.5px solid #e2e8f0;
            font-size: 0.95rem;
            transition: border-color 0.2s ease, box-shadow 0.2s;
            background: #f8fafc;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
            background: white;
        }

        .helper-progress {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
        }

        .progress-dot {
            flex: 1;
            height: 6px;
            border-radius: 999px;
            background: #e2e8f0;
        }

        .progress-dot.active {
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ============================================
           RESPONSIVE DESIGN
           ============================================ */
        @media (max-width: 768px) {
            .navbar-container {
                flex-direction: column;
                align-items: flex-start;
            }

            .navbar-links {
                width: 100%;
                justify-content: space-between;
            }

            .auth-section {
                width: 100%;
            }

            .login-form {
                width: 100%;
            }

            .login-input {
                flex: 1;
            }

            .welcome-title {
                font-size: 2rem;
            }

            .welcome-description {
                font-size: 1rem;
            }

            .homepage {
                padding: 2rem 1rem;
            }
        }

        @media (max-width: 480px) {
            .navbar-brand {
                font-size: 1rem;
            }

            .nav-link {
                font-size: 0.85rem;
            }

            .welcome-title {
                font-size: 1.75rem;
            }

            .svg-graphic {
                max-width: 300px;
            }

            .modal-content {
                padding: 1.5rem;
                max-width: 95%;
            }

            .modal-title {
                font-size: 1.25rem;
            }
        }
    </style>
</head>
<body>
    <!-- Skip Links for Accessibility -->
    <a href="#main-content" class="skip-links">Skip to main content</a>
    
    <!-- Language Toggle -->
    <div class="language-toggle" role="group" aria-label="Language selection">
        <button class="language-btn active" onclick="setLanguage('en')" aria-label="Switch to English">
            EN
        </button>
        <button class="language-btn" onclick="setLanguage('ko')" aria-label="한국어로 변경">
            한국어
        </button>
    </div>

    <!-- Navigation Bar -->
    <nav class="navbar" role="navigation" aria-label="Main navigation">
        <div class="navbar-container">
            <a href="#" class="navbar-brand" onclick="goToScreen('start'); return false;" data-i18n="nav.brand">Korean Community Commerce</a>
            <div class="navbar-links" id="navbar-links" role="menubar"></div>
            <div class="navbar-actions" id="navbar-actions">
                <!-- Populated by JS -->
            </div>
        </div>
    </nav>

    <!-- Mobile Bottom Navigation -->
    <nav class="bottom-nav" id="bottom-nav" role="navigation" aria-label="Mobile navigation">
        <div class="bottom-nav-container">
            <a href="#" class="bottom-nav-item" onclick="goToScreen('browse'); return false;" 
               data-screen="browse" role="menuitem" aria-label="Go to home page">
                <div class="bottom-nav-icon" aria-hidden="true">🏠</div>
                <span data-i18n="nav.home">Home</span>
            </a>
            <a href="#" class="bottom-nav-item" onclick="goToScreen('groupbuys'); return false;" 
               data-screen="groupbuys" role="menuitem" aria-label="Go to group buys">
                <div class="bottom-nav-icon" aria-hidden="true">🛒</div>
                <span data-i18n="nav.groupbuys">Group Buys</span>
            </a>
            <a href="#" class="bottom-nav-item" onclick="goToScreen('errands'); return false;" 
               data-screen="errands" role="menuitem" aria-label="Go to errands">
                <div class="bottom-nav-icon" aria-hidden="true">🤝</div>
                <span data-i18n="nav.errands">Errands</span>
            </a>
            <a href="#" class="bottom-nav-item" onclick="goToScreen('profile'); return false;" 
               data-screen="profile" role="menuitem" aria-label="Go to profile">
                <div class="bottom-nav-icon" aria-hidden="true">👤</div>
                <span data-i18n="nav.profile">Profile</span>
            </a>
        </div>
    </nav>

    <!-- Floating Action Button -->
    <button class="fab" id="fab" onclick="handleFabClick()" 
            data-i18n-title="common.create" title="Quick Action"
            aria-label="Quick action button">
        <span aria-hidden="true">➕</span>
    </button>

    <!-- Version Info -->
    <div class="version-info" title="Multi-User Platform v3.0.0 - Complete Feature Set with Analytics & Mobile Optimization">
        v3.0.0
    </div>

    <main class="app-shell">
        <!-- Screen: Get Started -->
        <section class="screen active" id="screen-start">
            <div class="screen-header">
                <p class="screen-subtitle">Community-powered commerce for Koreans in Canada</p>
                <h1 class="screen-heading">Join local group buys & errands together</h1>
            </div>
            <div style="text-align: center;">
                <button class="primary-cta" onclick="goToScreen('auth')">
                    Get Started
                </button>
                <div style="margin-top:1rem;">
                    <button class="btn btn-secondary" onclick="skipLoginForTesting()">Skip login (test)</button>
                </div>
            </div>
        </section>

        <!-- Screen: Authentication -->
        <section class="screen" id="screen-auth">
            <div class="screen-header">
                <h2 class="screen-heading">Join Korean Community Commerce</h2>
                <p class="screen-subtitle">Connect with your community through group buys and local errands</p>
            </div>
            
            <!-- Quick Sign-in Options -->
            <div class="auth-options">
                <div class="google-signin-container" style="text-align:center; margin-bottom: 1.5rem;">
                    <div id="google-signin-button"></div>
                </div>
                <div class="divider"><span>or continue with email</span></div>
                
                <!-- Streamlined Form -->
                <form id="email-auth-form" onsubmit="handleStreamlinedSignUp(event)">
                    <div class="form-row">
                        <div class="form-group" id="full-name-group">
                            <label class="form-label" for="full-name">Name</label>
                            <input id="full-name" class="form-input" type="text" placeholder="Your name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="email-address">Email</label>
                            <input id="email-address" class="form-input" type="email" placeholder="your@email.com" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="password-input">Password</label>
                        <input id="password-input" class="form-input" type="password" placeholder="6+ characters" minlength="6" required>
                    </div>
                    
                    <!-- Integrated Role Selection -->
                    <div class="form-group">
                        <label class="form-label">How will you participate? <span class="optional-text">(Select all that apply)</span></label>
                        <div class="role-selection-compact">
                            <label class="role-checkbox">
                                <input type="checkbox" name="roles" value="customer" id="role-customer">
                                <div class="role-option">
                                    <div class="role-icon">🛒</div>
                                    <div class="role-info">
                                        <strong>Customer</strong>
                                        <span>Join group buys & request errands</span>
                                    </div>
                                </div>
                            </label>
                            <label class="role-checkbox">
                                <input type="checkbox" name="roles" value="vendor" id="role-vendor">
                                <div class="role-option">
                                    <div class="role-icon">🏪</div>
                                    <div class="role-info">
                                        <strong>Vendor</strong>
                                        <span>Create group buys & sell products</span>
                                    </div>
                                </div>
                            </label>
                            <label class="role-checkbox">
                                <input type="checkbox" name="roles" value="helper" id="role-helper">
                                <div class="role-option">
                                    <div class="role-icon">🤝</div>
                                    <div class="role-info">
                                        <strong>Helper</strong>
                                        <span>Run errands & earn money</span>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div id="verification-message" class="screen-subtitle" style="display:none; margin-bottom: 1rem; color:#059669;">
                        We sent you a verification email. Please check your inbox.
                    </div>
                    
                    <button type="submit" class="primary-cta" style="width:100%;" id="auth-submit-btn">
                        Get Started
                    </button>
                    
                    <div style="text-align: center; margin-top: 1rem;">
                        <button type="button" class="btn btn-secondary" onclick="toggleAuthMode()" id="auth-mode-toggle">
                            Already have an account? Sign in
                        </button>
                    </div>
                </form>
            </div>
        </section>

        <!-- Screen: Choose Role -->
        <section class="screen" id="screen-role">
            <div class="screen-header">
                <p class="screen-subtitle">Step 2 of 3</p>
                <h2 class="screen-heading">How will you use the platform?</h2>
                <p class="screen-subtitle">Pick one to customize your experience.</p>
            </div>
            <div class="card-grid" id="role-card-container">
                <div class="role-card" data-role="customer" onclick="toggleRole('customer')">
                    <h3>Customer</h3>
                    <p>Join local group buys, request errands, and track your orders.</p>
                </div>
                <div class="role-card" data-role="vendor" onclick="toggleRole('vendor')">
                    <h3>Vendor</h3>
                    <p>Launch community group buys, manage products, and oversee fulfillment.</p>
                </div>
                <div class="role-card" data-role="helper" onclick="toggleRole('helper')">
                    <h3>Helper</h3>
                    <p>Run errands, support group-buy logistics, and earn more with your time.</p>
                </div>
            </div>
            <div style="margin-top:2rem; text-align:right;">
                <button class="primary-cta" onclick="continueAfterRole()" id="role-continue-btn" disabled>Continue</button>
            </div>
        </section>

        <!-- Screen: Helper Verification -->
        <section class="screen" id="screen-helper">
            <div class="screen-header">
                <p class="screen-subtitle">Final step • Helper verification</p>
                <h2 class="screen-heading">Build community trust</h2>
                <p class="screen-subtitle">Complete the steps so customers feel confident booking you.</p>
            </div>
            <div class="helper-progress" id="helper-progress"></div>
            <div id="helper-step-container"><!-- JS renders forms here --></div>
        </section>

        <!-- Screen: Browse Marketplace -->
        <section class="screen" id="screen-browse">
            <div class="screen-header">
                <p class="screen-subtitle">Live marketplace</p>
                <h2 class="screen-heading">Browse group buys & errands</h2>
                <p class="screen-subtitle">Discover what the community is organizing right now.</p>
            </div>
            <div class="browse-grid">
                <div class="view-content">
                    <div class="view-header">
                        <h3>Featured Group Buys</h3>
                        <button class="btn btn-primary" onclick="goToScreen('groupbuys')">View more group buys</button>
                    </div>
                    <div class="stacked-list" id="featured-groupbuys"></div>
                </div>
                <div class="view-content">
                    <div class="view-header">
                        <h3>Open Errands</h3>
                        <button class="btn btn-primary" onclick="goToScreen('errands')">View all errands</button>
                    </div>
                    <div class="stacked-list" id="featured-errands"></div>
                </div>
            </div>
        </section>

        <!-- Screen: Group Buy List -->
        <section class="screen" id="screen-groupbuys">
            <div class="screen-header">
                <p class="screen-subtitle">Community bulk orders</p>
                <h2 class="screen-heading">Group Buy Marketplace</h2>
                <p class="screen-subtitle">Find deals by category, price, and popularity</p>
            </div>
            
            <!-- Enhanced Search & Filters -->
            <div class="search-filters">
                <div class="search-bar">
                    <div class="search-icon">🔍</div>
                    <input id="groupbuy-search" class="search-input" type="text" placeholder="Search products, brands, or descriptions..." oninput="handleGroupBuySearch(event)">
                </div>
                
                <!-- Quick Category Filters -->
                <div class="quick-filters">
                    <div class="quick-filter active" onclick="handleCategoryFilter('all')">
                        📦 All Categories
                    </div>
                    <div class="quick-filter" onclick="handleCategoryFilter('food')">
                        🍜 Food & Beverages
                    </div>
                    <div class="quick-filter" onclick="handleCategoryFilter('household')">
                        🏠 Household
                    </div>
                    <div class="quick-filter" onclick="handleCategoryFilter('beauty')">
                        💄 Beauty
                    </div>
                    <div class="quick-filter" onclick="handleCategoryFilter('electronics')">
                        📱 Electronics
                    </div>
                </div>
                
                <!-- Detailed Filters -->
                <div class="filter-grid">
                    <div class="filter-group">
                        <label class="filter-label">Category</label>
                        <select id="groupbuy-category" class="filter-select" onchange="handleGroupBuyCategory(event)">
                            <option value="all">All Categories</option>
                            <option value="food">🍜 Food & Beverages</option>
                            <option value="household">🏠 Household Items</option>
                            <option value="beauty">💄 Beauty & Personal Care</option>
                            <option value="electronics">📱 Electronics</option>
                            <option value="clothing">👕 Clothing & Accessories</option>
                            <option value="books">📚 Books & Media</option>
                            <option value="health">💊 Health & Wellness</option>
                            <option value="baby">🍼 Baby & Kids</option>
                            <option value="sports">⚽ Sports & Outdoors</option>
                            <option value="other">📦 Other</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Price Range</label>
                        <select id="groupbuy-price" class="filter-select" onchange="handleGroupBuyPrice(event)">
                            <option value="all">Any Price</option>
                            <option value="under-25">Under $25</option>
                            <option value="25-50">$25 - $50</option>
                            <option value="50-100">$50 - $100</option>
                            <option value="100-200">$100 - $200</option>
                            <option value="over-200">Over $200</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Region</label>
                        <select id="groupbuy-region" class="filter-select" onchange="handleGroupBuyRegion(event)">
                    <option value="All">All Regions</option>
                    <option value="Toronto">Toronto</option>
                    <option value="Hamilton">Hamilton</option>
                    <option value="Niagara">Niagara</option>
                </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Status</label>
                        <select id="groupbuy-status" class="filter-select" onchange="handleGroupBuyStatus(event)">
                            <option value="all">All Status</option>
                            <option value="open">🟢 Open</option>
                            <option value="closing-soon">⏰ Closing Soon</option>
                            <option value="almost-full">🔥 Almost Full</option>
                            <option value="new">✨ New This Week</option>
                </select>
                    </div>
                </div>
            </div>
            
            <!-- Results Summary & Sort -->
            <div class="results-summary">
                <div class="results-count" id="groupbuy-results-count">
                    Loading products...
                </div>
                <div class="sort-dropdown">
                    <label>Sort by:</label>
                    <select id="groupbuy-sort" class="filter-select" onchange="handleGroupBuySort(event)">
                        <option value="popularity">🔥 Popularity</option>
                        <option value="deadline">⏰ Deadline</option>
                        <option value="priceLow">💰 Price: Low to High</option>
                        <option value="priceHigh">💰 Price: High to Low</option>
                        <option value="progress">📊 Progress</option>
                        <option value="newest">✨ Newest</option>
                </select>
            </div>
            </div>
            
            <div class="card-grid" id="groupbuy-list"></div>
        </section>

        <!-- Screen: Errands List -->
        <section class="screen" id="screen-errands">
            <div class="screen-header">
                <p class="screen-subtitle">Need a hand?</p>
                <h2 class="screen-heading">Community Errands Hub</h2>
                <p class="screen-subtitle">Create errands, apply to help, and match faster.</p>
            </div>
            <div class="view-content" style="margin-bottom:1.5rem;">
                <div class="view-header">
                    <h3>Create a new errand</h3>
                    <span class="screen-subtitle">Share details and helpers will apply.</span>
                </div>
                <form id="create-errand-form" onsubmit="handleCreateErrand(event)">
                    <div class="form-group">
                        <label class="form-label">Title</label>
                        <input class="form-input" id="errand-title" required placeholder="e.g., Costco pickup in Etobicoke">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Region</label>
                        <select class="form-select" id="errand-region" required>
                            <option value="Toronto">Toronto</option>
                            <option value="Hamilton">Hamilton</option>
                            <option value="Niagara">Niagara</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-textarea" id="errand-description" rows="3" required placeholder="What do you need help with?"></textarea>
                    </div>
                    <div class="form-group" style="display:flex; gap:1rem; flex-wrap:wrap;">
                        <div style="flex:1; min-width:180px;">
                            <label class="form-label">Budget Min ($)</label>
                            <input type="number" class="form-input" id="errand-budget-min" required min="0">
                        </div>
                        <div style="flex:1; min-width:180px;">
                            <label class="form-label">Budget Max ($)</label>
                            <input type="number" class="form-input" id="errand-budget-max" required min="0">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Preferred Time</label>
                        <input type="datetime-local" class="form-input" id="errand-time" required>
                    </div>
                    <button class="primary-cta" style="width:100%;">Post Errand</button>
                </form>
            </div>
            <!-- Enhanced Errand Filters -->
            <div class="search-filters">
                <div class="search-bar">
                    <div class="search-icon">🔍</div>
                    <input id="errand-search" class="search-input" type="text" placeholder="Search errands, locations, or descriptions..." oninput="handleErrandSearch(event)">
                </div>
                
                <!-- Quick Category Filters -->
                <div class="quick-filters">
                    <div class="quick-filter active" onclick="handleErrandCategoryFilter('all')">
                        🤝 All Tasks
                    </div>
                    <div class="quick-filter" onclick="handleErrandCategoryFilter('shopping')">
                        🛒 Shopping
                    </div>
                    <div class="quick-filter" onclick="handleErrandCategoryFilter('delivery')">
                        🚚 Delivery
                    </div>
                    <div class="quick-filter" onclick="handleErrandCategoryFilter('cleaning')">
                        🧹 Cleaning
                    </div>
                    <div class="quick-filter" onclick="handleErrandCategoryFilter('tech')">
                        💻 Tech Help
                    </div>
                </div>
                
                <!-- Detailed Filters -->
                <div class="filter-grid">
                    <div class="filter-group">
                        <label class="filter-label">Category</label>
                        <select id="errand-category" class="filter-select" onchange="handleErrandCategory(event)">
                            <option value="all">All Categories</option>
                            <option value="shopping">🛒 Shopping & Pickup</option>
                            <option value="delivery">🚚 Delivery</option>
                            <option value="cleaning">🧹 Cleaning</option>
                            <option value="moving">📦 Moving & Transport</option>
                            <option value="pet">🐕 Pet Care</option>
                            <option value="tech">💻 Tech Support</option>
                            <option value="handyman">🔧 Handyman</option>
                            <option value="tutoring">📖 Tutoring & Teaching</option>
                            <option value="other">🤝 Other</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Budget Range</label>
                        <select id="errand-price" class="filter-select" onchange="handleErrandPrice(event)">
                            <option value="all">Any Budget</option>
                            <option value="under-25">Under $25</option>
                            <option value="25-50">$25 - $50</option>
                            <option value="50-100">$50 - $100</option>
                            <option value="100-200">$100 - $200</option>
                            <option value="over-200">Over $200</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Region</label>
                        <select id="errand-region-filter" class="filter-select" onchange="handleErrandRegion(event)">
                            <option value="All">All Regions</option>
                            <option value="Toronto">Toronto</option>
                            <option value="Hamilton">Hamilton</option>
                            <option value="Niagara">Niagara</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Status</label>
                        <select id="errand-status-filter" class="filter-select" onchange="handleErrandStatus(event)">
                            <option value="open">🟢 Open</option>
                            <option value="matched">🤝 Matched</option>
                            <option value="in_progress">⏳ In Progress</option>
                            <option value="completed">✅ Completed</option>
                            <option value="all">📋 All Statuses</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Results Summary & Sort -->
            <div class="results-summary">
                <div class="results-count" id="errand-results-count">
                    Loading errands...
                </div>
                <div class="sort-dropdown">
                    <label>Sort by:</label>
                    <select id="errand-sort" class="filter-select" onchange="handleErrandSort(event)">
                        <option value="newest">✨ Newest First</option>
                        <option value="budgetHigh">💰 Budget: High to Low</option>
                        <option value="budgetLow">💰 Budget: Low to High</option>
                        <option value="deadline">⏰ Deadline</option>
                        <option value="popularity">🔥 Most Applications</option>
                    </select>
                </div>
            </div>
            <div class="card-grid" id="errand-list"></div>
        </section>

        <!-- Screen: Dashboard -->
        <section class="screen" id="screen-dashboard">
            <div class="screen-header">
                <h2 class="screen-heading" id="dashboard-title">Welcome back!</h2>
                <p class="screen-subtitle" id="dashboard-subtitle">Your personalized community hub.</p>
            </div>
            <div id="dashboard-content" class="dashboard-content">
                <!-- Populated by JS -->
            </div>
        </section>

        <!-- Screen: Profile -->
        <section class="screen" id="screen-profile">
            <div class="screen-header">
                <h2 class="screen-heading">My Profile</h2>
                <p class="screen-subtitle">Manage your account and preferences</p>
            </div>
            <div id="profile-content" class="profile-content">
                <!-- Populated by JS -->
            </div>
        </section>
    </main>

    <div class="modal-overlay" id="modal-root">
        <div class="modal-panel" id="modal-panel"></div>
    </div>

    <div id="toast-root" class="toast-container"></div>
    <div id="success-pulse" class="success-pulse">✓</div>
    <div id="loading-overlay" class="modal-overlay" style="background:rgba(15,23,42,0.7); display:none;">
        <div class="modal-panel" style="max-width:220px; text-align:center;">
            <div class="spinner" style="margin:0 auto 1rem; width:32px; height:32px; border-radius:999px; border:3px solid #e5e7eb; border-top-color:#6366f1; animation:spin 0.6s linear infinite;"></div>
            <p class="screen-subtitle">Loading data…</p>
        </div>
    </div>

    <!-- Supabase client (for cloud persistence and auth). -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        /**
         * App State & Persistence
         */
        const StorageKeys = {
            user: 'userProfile',
            helper: 'helperData',
            loginMethod: 'loginMethod',
            products: 'products',
            orders: 'orders',
            errands: 'errands',
            applications: 'applications',
            messages: 'messages'
        };

        /**
         * Cloud persistence (Supabase) with localStorage fallback for development.
         * This keeps the rest of the app unchanged while swapping the storage layer.
         */
        const SUPABASE_URL = 'https://hvahurhyuqfieczyqvgr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh2YWh1cmh5dXFmaWVjenlxdmdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMTIyOTMsImV4cCI6MjA3ODc4ODI5M30.QLBovRZLU1q7vfImZjx8zMFoZzz9CGpZOg_Mj5uC9xs';
        let supabaseClient = null;
        if (window.supabase && SUPABASE_URL && SUPABASE_ANON_KEY) {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        }
        const DB_TABLE = 'app_state';

        async function dbSaveSlice(key, value) {
            try {
                if (supabaseClient) {
                    await supabaseClient
                        .from(DB_TABLE)
                        .upsert({ key, value }, { onConflict: 'key' });
                } else {
                    // Fallback to localStorage so the app still works without Supabase configuration.
                    if (value === null || value === undefined) {
                        localStorage.removeItem(key);
                    } else {
                        localStorage.setItem(key, JSON.stringify(value));
                    }
                }
            } catch (e) {
                console.error('dbSaveSlice error', e);
            }
        }

        async function dbLoadSlice(key, fallback) {
            try {
                if (supabaseClient) {
                    const { data, error } = await supabaseClient
                        .from(DB_TABLE)
                        .select('value')
                        .eq('key', key)
                        .maybeSingle();
                    if (error || !data) return fallback;
                    return data.value;
                } else {
                    const raw = localStorage.getItem(key);
                    return raw ? JSON.parse(raw) : fallback;
                }
            } catch (e) {
                console.error('dbLoadSlice error', e);
                return fallback;
            }
        }

        async function dbClearAll() {
            try {
                if (supabaseClient) {
                    await supabaseClient.from(DB_TABLE).delete().neq('key', '');
                } else {
                    localStorage.clear();
                }
            } catch (e) {
                console.error('dbClearAll error', e);
            }
        }

        const HelperDefaults = {
                firstName: '',
                lastName: '',
                photoDataUrl: '',
                street: '',
                city: '',
                province: '',
                postal: '',
                phone: '',
                generatedCode: '',
                enteredCode: '',
                smsVerified: false
        };

        const FilterDefaults = () => ({
            groupbuys: {
                search: '',
                region: 'All',
                sort: 'deadline',
                vendor: 'All',
                category: 'all',
                priceRange: 'all',
                status: 'all'
            },
            errands: {
                region: 'All',
                status: 'open',
                sort: 'newest',
                priceRange: 'all',
                category: 'all',
                search: ''
            },
            vendorOrders: {
                status: 'all',
                search: ''
            }
        });

        const ProductCategories = {
            'food': { name: 'Food & Beverages', icon: '🍜' },
            'household': { name: 'Household Items', icon: '🏠' },
            'beauty': { name: 'Beauty & Personal Care', icon: '💄' },
            'electronics': { name: 'Electronics', icon: '📱' },
            'clothing': { name: 'Clothing & Accessories', icon: '👕' },
            'books': { name: 'Books & Media', icon: '📚' },
            'health': { name: 'Health & Wellness', icon: '💊' },
            'baby': { name: 'Baby & Kids', icon: '🍼' },
            'sports': { name: 'Sports & Outdoors', icon: '⚽' },
            'other': { name: 'Other', icon: '📦' }
        };

        const ErrandCategories = {
            'shopping': { name: 'Shopping & Pickup', icon: '🛒' },
            'delivery': { name: 'Delivery', icon: '🚚' },
            'cleaning': { name: 'Cleaning', icon: '🧹' },
            'moving': { name: 'Moving & Transport', icon: '📦' },
            'pet': { name: 'Pet Care', icon: '🐕' },
            'tech': { name: 'Tech Support', icon: '💻' },
            'handyman': { name: 'Handyman', icon: '🔧' },
            'tutoring': { name: 'Tutoring & Teaching', icon: '📖' },
            'other': { name: 'Other', icon: '🤝' }
        };

        const PriceRanges = {
            'under-25': { name: 'Under $25', min: 0, max: 25 },
            '25-50': { name: '$25 - $50', min: 25, max: 50 },
            '50-100': { name: '$50 - $100', min: 50, max: 100 },
            '100-200': { name: '$100 - $200', min: 100, max: 200 },
            'over-200': { name: 'Over $200', min: 200, max: Infinity }
        };

        // Language Support
        let currentLanguage = localStorage.getItem('preferred-language') || 'en';

        const translations = {
            en: {
                // Navigation
                'nav.brand': 'Korean Community Commerce',
                'nav.home': 'Home',
                'nav.groupbuys': 'Group Buys',
                'nav.errands': 'Errands',
                'nav.dashboard': 'Dashboard',
                'nav.profile': 'Profile',
                
                // Authentication
                'auth.title': 'Join Korean Community Commerce',
                'auth.subtitle': 'Connect with your community through group buys and local errands',
                'auth.google': 'Continue with Google',
                'auth.or': 'or continue with email',
                'auth.name': 'Name',
                'auth.email': 'Email',
                'auth.password': 'Password',
                'auth.signup': 'Get Started',
                'auth.signin': 'Sign In',
                'auth.toggle.signin': 'Already have an account? Sign in',
                'auth.toggle.signup': "Don't have an account? Sign up",
                'auth.roles.title': 'How will you participate?',
                'auth.roles.subtitle': '(Select all that apply)',
                
                // Roles
                'role.customer': 'Customer',
                'role.customer.desc': 'Join group buys & request errands',
                'role.vendor': 'Vendor',
                'role.vendor.desc': 'Create group buys & sell products',
                'role.helper': 'Helper',
                'role.helper.desc': 'Run errands & earn money',
                
                // Categories
                'category.food': 'Food & Beverages',
                'category.household': 'Household Items',
                'category.beauty': 'Beauty & Personal Care',
                'category.electronics': 'Electronics',
                'category.clothing': 'Clothing & Accessories',
                'category.books': 'Books & Media',
                'category.health': 'Health & Wellness',
                'category.baby': 'Baby & Kids',
                'category.sports': 'Sports & Outdoors',
                'category.other': 'Other',
                
                // Errand Categories
                'errand.shopping': 'Shopping & Pickup',
                'errand.delivery': 'Delivery',
                'errand.cleaning': 'Cleaning',
                'errand.moving': 'Moving & Transport',
                'errand.pet': 'Pet Care',
                'errand.tech': 'Tech Support',
                'errand.handyman': 'Handyman',
                'errand.tutoring': 'Tutoring & Teaching',
                
                // Common
                'common.search': 'Search',
                'common.filter': 'Filter',
                'common.sort': 'Sort by',
                'common.all': 'All',
                'common.loading': 'Loading...',
                'common.cancel': 'Cancel',
                'common.save': 'Save',
                'common.delete': 'Delete',
                'common.edit': 'Edit',
                'common.view': 'View',
                'common.create': 'Create',
                'common.join': 'Join',
                'common.apply': 'Apply',
                'common.close': 'Close',
                
                // Accessibility
                'a11y.menu': 'Main menu',
                'a11y.search': 'Search products and errands',
                'a11y.filter': 'Filter results',
                'a11y.sort': 'Sort results',
                'a11y.language': 'Change language',
                'a11y.profile': 'User profile menu',
                'a11y.close': 'Close dialog',
                'a11y.expand': 'Expand section',
                'a11y.collapse': 'Collapse section'
            },
            ko: {
                // Navigation
                'nav.brand': '한인 커뮤니티 커머스',
                'nav.home': '홈',
                'nav.groupbuys': '공동구매',
                'nav.errands': '심부름',
                'nav.dashboard': '대시보드',
                'nav.profile': '프로필',
                
                // Authentication
                'auth.title': '한인 커뮤니티 커머스 가입',
                'auth.subtitle': '공동구매와 지역 심부름을 통해 커뮤니티와 연결하세요',
                'auth.google': 'Google로 계속하기',
                'auth.or': '또는 이메일로 계속하기',
                'auth.name': '이름',
                'auth.email': '이메일',
                'auth.password': '비밀번호',
                'auth.signup': '시작하기',
                'auth.signin': '로그인',
                'auth.toggle.signin': '이미 계정이 있으신가요? 로그인',
                'auth.toggle.signup': '계정이 없으신가요? 가입하기',
                'auth.roles.title': '어떻게 참여하시겠어요?',
                'auth.roles.subtitle': '(해당하는 모든 항목 선택)',
                
                // Roles
                'role.customer': '구매자',
                'role.customer.desc': '공동구매 참여 & 심부름 요청',
                'role.vendor': '판매자',
                'role.vendor.desc': '공동구매 생성 & 상품 판매',
                'role.helper': '도우미',
                'role.helper.desc': '심부름 수행 & 수익 창출',
                
                // Categories
                'category.food': '식품 & 음료',
                'category.household': '생활용품',
                'category.beauty': '뷰티 & 개인관리',
                'category.electronics': '전자제품',
                'category.clothing': '의류 & 액세서리',
                'category.books': '도서 & 미디어',
                'category.health': '건강 & 웰니스',
                'category.baby': '유아 & 아동',
                'category.sports': '스포츠 & 아웃도어',
                'category.other': '기타',
                
                // Errand Categories
                'errand.shopping': '쇼핑 & 픽업',
                'errand.delivery': '배달',
                'errand.cleaning': '청소',
                'errand.moving': '이사 & 운송',
                'errand.pet': '펫케어',
                'errand.tech': '기술 지원',
                'errand.handyman': '수리',
                'errand.tutoring': '과외 & 교육',
                
                // Common
                'common.search': '검색',
                'common.filter': '필터',
                'common.sort': '정렬',
                'common.all': '전체',
                'common.loading': '로딩 중...',
                'common.cancel': '취소',
                'common.save': '저장',
                'common.delete': '삭제',
                'common.edit': '수정',
                'common.view': '보기',
                'common.create': '생성',
                'common.join': '참여',
                'common.apply': '신청',
                'common.close': '닫기',
                
                // Accessibility
                'a11y.menu': '메인 메뉴',
                'a11y.search': '상품 및 심부름 검색',
                'a11y.filter': '결과 필터링',
                'a11y.sort': '결과 정렬',
                'a11y.language': '언어 변경',
                'a11y.profile': '사용자 프로필 메뉴',
                'a11y.close': '대화상자 닫기',
                'a11y.expand': '섹션 펼치기',
                'a11y.collapse': '섹션 접기'
            }
        };

        function t(key, fallback = key) {
            return translations[currentLanguage]?.[key] || translations.en[key] || fallback;
        }

        function setLanguage(lang) {
            if (translations[lang]) {
                currentLanguage = lang;
                localStorage.setItem('preferred-language', lang);
                document.documentElement.lang = lang;
                updateUILanguage();
            }
        }

        function updateUILanguage() {
            // Update all elements with data-i18n attribute
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                element.textContent = t(key);
            });
            
            // Update placeholders
            document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
                const key = element.getAttribute('data-i18n-placeholder');
                element.placeholder = t(key);
            });
            
            // Update aria-labels
            document.querySelectorAll('[data-i18n-aria]').forEach(element => {
                const key = element.getAttribute('data-i18n-aria');
                element.setAttribute('aria-label', t(key));
            });
            
            // Update titles
            document.querySelectorAll('[data-i18n-title]').forEach(element => {
                const key = element.getAttribute('data-i18n-title');
                element.title = t(key);
            });
        }

        // Analytics & Insights System
        const AnalyticsEngine = {
            // Vendor Analytics
            getVendorMetrics(vendorEmail) {
                const vendorProducts = AppState.products.filter(p => p.ownerEmail === vendorEmail);
                const vendorOrders = AppState.orders.filter(o => {
                    const product = AppState.products.find(p => p.id === o.productId);
                    return product && product.ownerEmail === vendorEmail;
                });
                
                const totalRevenue = vendorOrders.reduce((sum, order) => sum + (order.totalPrice || order.total || 0), 0);
                const totalProducts = vendorProducts.length;
                const totalOrders = vendorOrders.length;
                const avgOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;
                
                // Conversion metrics
                const productViews = vendorProducts.reduce((sum, p) => sum + (p.views || 0), 0);
                const conversionRate = productViews > 0 ? (totalOrders / productViews) * 100 : 0;
                
                // Success rate (products that reached target)
                const successfulProducts = vendorProducts.filter(p => {
                    const progress = (p.currentQuantity / p.targetQuantity) * 100;
                    return progress >= 100;
                }).length;
                const successRate = totalProducts > 0 ? (successfulProducts / totalProducts) * 100 : 0;
                
                // Time-based metrics
                const last30Days = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
                const recentOrders = vendorOrders.filter(o => new Date(o.createdAt) > last30Days);
                const monthlyRevenue = recentOrders.reduce((sum, order) => sum + (order.totalPrice || order.total || 0), 0);
                
                return {
                    totalRevenue,
                    monthlyRevenue,
                    totalProducts,
                    totalOrders,
                    avgOrderValue,
                    conversionRate,
                    successRate,
                    recentOrders: recentOrders.length,
                    topProducts: this.getTopProducts(vendorProducts),
                    revenueByCategory: this.getRevenueByCategory(vendorProducts, vendorOrders),
                    monthlyTrend: this.getMonthlyTrend(vendorOrders)
                };
            },
            
            // Helper Analytics
            getHelperMetrics(helperEmail) {
                const helperApplications = AppState.applications.filter(a => a.helperEmail === helperEmail);
                const acceptedApplications = helperApplications.filter(a => a.status === 'accepted');
                const completedErrands = AppState.errands.filter(e => 
                    e.assignedHelperEmail === helperEmail && e.status === 'completed'
                );
                
                const totalEarnings = completedErrands.reduce((sum, errand) => {
                    const application = helperApplications.find(a => a.errandId === errand.id);
                    return sum + (application?.offerAmount || errand.budget || 0);
                }, 0);
                
                const totalApplications = helperApplications.length;
                const acceptanceRate = totalApplications > 0 ? (acceptedApplications.length / totalApplications) * 100 : 0;
                const completionRate = acceptedApplications.length > 0 ? (completedErrands.length / acceptedApplications.length) * 100 : 0;
                
                // Time-based metrics
                const last30Days = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
                const recentErrands = completedErrands.filter(e => new Date(e.createdAt) > last30Days);
                const monthlyEarnings = recentErrands.reduce((sum, errand) => {
                    const application = helperApplications.find(a => a.errandId === errand.id);
                    return sum + (application?.offerAmount || errand.budget || 0);
                }, 0);
                
                const avgEarningsPerErrand = completedErrands.length > 0 ? totalEarnings / completedErrands.length : 0;
                
                return {
                    totalEarnings,
                    monthlyEarnings,
                    totalApplications,
                    acceptedApplications: acceptedApplications.length,
                    completedErrands: completedErrands.length,
                    acceptanceRate,
                    completionRate,
                    avgEarningsPerErrand,
                    categoryBreakdown: this.getHelperCategoryBreakdown(completedErrands),
                    earningsTrend: this.getHelperEarningsTrend(completedErrands, helperApplications)
                };
            },
            
            // Customer Analytics
            getCustomerMetrics(customerEmail) {
                const customerOrders = AppState.orders.filter(o => o.customerEmail === customerEmail);
                const customerErrands = AppState.errands.filter(e => e.requesterEmail === customerEmail);
                
                const totalSpent = customerOrders.reduce((sum, order) => sum + (order.totalPrice || order.total || 0), 0);
                const totalSavings = this.calculateGroupBuySavings(customerOrders);
                const totalOrders = customerOrders.length;
                const totalErrands = customerErrands.length;
                
                // Group buy participation
                const groupBuyOrders = customerOrders.filter(o => {
                    const product = AppState.products.find(p => p.id === o.productId);
                    return product && product.currentQuantity > 1;
                });
                const groupBuyParticipation = totalOrders > 0 ? (groupBuyOrders.length / totalOrders) * 100 : 0;
                
                // Time-based metrics
                const last30Days = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
                const recentOrders = customerOrders.filter(o => new Date(o.createdAt) > last30Days);
                const monthlySpent = recentOrders.reduce((sum, order) => sum + (order.totalPrice || order.total || 0), 0);
                
                return {
                    totalSpent,
                    totalSavings,
                    monthlySpent,
                    totalOrders,
                    totalErrands,
                    groupBuyParticipation,
                    avgOrderValue: totalOrders > 0 ? totalSpent / totalOrders : 0,
                    savingsRate: totalSpent > 0 ? (totalSavings / (totalSpent + totalSavings)) * 100 : 0,
                    categorySpending: this.getCustomerCategorySpending(customerOrders),
                    spendingTrend: this.getCustomerSpendingTrend(customerOrders)
                };
            },
            
            // Helper methods
            getTopProducts(products) {
                return products
                    .map(p => ({
                        ...p,
                        orderCount: AppState.orders.filter(o => o.productId === p.id).length,
                        revenue: AppState.orders
                            .filter(o => o.productId === p.id)
                            .reduce((sum, o) => sum + (o.totalPrice || o.total || 0), 0)
                    }))
                    .sort((a, b) => b.revenue - a.revenue)
                    .slice(0, 5);
            },
            
            getRevenueByCategory(products, orders) {
                const categoryRevenue = {};
                orders.forEach(order => {
                    const product = products.find(p => p.id === order.productId);
                    if (product) {
                        const category = product.category || 'other';
                        categoryRevenue[category] = (categoryRevenue[category] || 0) + (order.totalPrice || order.total || 0);
                    }
                });
                return categoryRevenue;
            },
            
            getMonthlyTrend(orders) {
                const monthlyData = {};
                orders.forEach(order => {
                    const month = new Date(order.createdAt).toISOString().slice(0, 7); // YYYY-MM
                    monthlyData[month] = (monthlyData[month] || 0) + (order.totalPrice || order.total || 0);
                });
                return Object.entries(monthlyData)
                    .sort(([a], [b]) => a.localeCompare(b))
                    .slice(-6); // Last 6 months
            },
            
            calculateGroupBuySavings(orders) {
                // Estimate savings based on group buy participation
                // Assume 10-20% savings on group buys vs individual purchases
                return orders.reduce((savings, order) => {
                    const product = AppState.products.find(p => p.id === order.productId);
                    if (product && product.currentQuantity > 1) {
                        const estimatedSavings = (order.totalPrice || order.total || 0) * 0.15; // 15% avg savings
                        return savings + estimatedSavings;
                    }
                    return savings;
                }, 0);
            },
            
            getHelperCategoryBreakdown(errands) {
                const categoryCount = {};
                errands.forEach(errand => {
                    const category = errand.category || 'other';
                    categoryCount[category] = (categoryCount[category] || 0) + 1;
                });
                return categoryCount;
            },
            
            getHelperEarningsTrend(errands, applications) {
                const monthlyEarnings = {};
                errands.forEach(errand => {
                    const application = applications.find(a => a.errandId === errand.id);
                    const earnings = application?.offerAmount || errand.budget || 0;
                    const month = new Date(errand.createdAt).toISOString().slice(0, 7);
                    monthlyEarnings[month] = (monthlyEarnings[month] || 0) + earnings;
                });
                return Object.entries(monthlyEarnings)
                    .sort(([a], [b]) => a.localeCompare(b))
                    .slice(-6);
            },
            
            getCustomerCategorySpending(orders) {
                const categorySpending = {};
                orders.forEach(order => {
                    const product = AppState.products.find(p => p.id === order.productId);
                    if (product) {
                        const category = product.category || 'other';
                        categorySpending[category] = (categorySpending[category] || 0) + (order.totalPrice || order.total || 0);
                    }
                });
                return categorySpending;
            },
            
            getCustomerSpendingTrend(orders) {
                const monthlySpending = {};
                orders.forEach(order => {
                    const month = new Date(order.createdAt).toISOString().slice(0, 7);
                    monthlySpending[month] = (monthlySpending[month] || 0) + (order.totalPrice || order.total || 0);
                });
                return Object.entries(monthlySpending)
                    .sort(([a], [b]) => a.localeCompare(b))
                    .slice(-6);
            }
        };

        // Chart rendering functions for analytics
        function renderRevenueChart(monthlyTrend) {
            if (!monthlyTrend || monthlyTrend.length === 0) {
                return `
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Revenue Trend</h3>
                            <span class="chart-period">Last 6 months</span>
                        </div>
                        <p class="screen-subtitle">No revenue data available yet.</p>
                    </div>
                `;
            }

            const maxValue = Math.max(...monthlyTrend.map(([, value]) => value));
            const bars = monthlyTrend.map(([month, value]) => {
                const height = maxValue > 0 ? (value / maxValue) * 100 : 0;
                return `
                    <div class="bar" style="height: ${height}%">
                        <div class="bar-label">${month.slice(-2)}</div>
                        <div class="bar-value">$${value.toFixed(0)}</div>
                    </div>
                `;
            }).join('');

            return `
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">Revenue Trend</h3>
                        <span class="chart-period">Last 6 months</span>
                    </div>
                    <div class="simple-bar-chart">
                        ${bars}
                    </div>
                </div>
            `;
        }

        function renderTopProductsChart(topProducts) {
            if (!topProducts || topProducts.length === 0) {
                return `
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Top Products</h3>
                        </div>
                        <p class="screen-subtitle">No products available yet.</p>
                    </div>
                `;
            }

            const topItems = topProducts.slice(0, 5).map((product, index) => `
                <div class="top-item">
                    <div class="top-item-rank">${index + 1}</div>
                    <div class="top-item-info">
                        <div class="top-item-name">${product.title}</div>
                        <div class="top-item-meta">${product.orderCount} orders</div>
                    </div>
                    <div class="top-item-value">$${product.revenue.toFixed(2)}</div>
                </div>
            `).join('');

            return `
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">Top Products</h3>
                        <span class="chart-period">By revenue</span>
                    </div>
                    <div class="top-items-list">
                        ${topItems}
                    </div>
                </div>
            `;
        }

        function renderVendorInsights(metrics) {
            const insights = [];
            
            if (metrics.conversionRate > 15) {
                insights.push({
                    type: 'success',
                    icon: '✓',
                    title: 'Great Conversion Rate',
                    description: `Your ${metrics.conversionRate.toFixed(1)}% conversion rate is above average. Keep up the great work!`
                });
            } else if (metrics.conversionRate < 5) {
                insights.push({
                    type: 'warning',
                    icon: '⚠',
                    title: 'Low Conversion Rate',
                    description: 'Consider improving product descriptions and images to boost conversions.'
                });
            }

            if (metrics.successRate > 80) {
                insights.push({
                    type: 'success',
                    icon: '🎯',
                    title: 'High Success Rate',
                    description: `${metrics.successRate.toFixed(1)}% of your products reach their target. Excellent planning!`
                });
            }

            if (metrics.monthlyRevenue > metrics.totalRevenue * 0.3) {
                insights.push({
                    type: 'info',
                    icon: '📈',
                    title: 'Strong Recent Performance',
                    description: 'Your recent sales are trending upward. Consider launching more products.'
                });
            }

            if (insights.length === 0) {
                insights.push({
                    type: 'info',
                    icon: 'ℹ',
                    title: 'Getting Started',
                    description: 'Create more products and gather orders to see personalized insights here.'
                });
            }

            const insightItems = insights.map(insight => `
                <div class="insight-item">
                    <div class="insight-icon ${insight.type}">
                        ${insight.icon}
                    </div>
                    <div class="insight-content">
                        <div class="insight-title">${insight.title}</div>
                        <div class="insight-description">${insight.description}</div>
                    </div>
                </div>
            `).join('');

            return `
                <div class="insights-list">
                    <h3 class="chart-title" style="margin-bottom: 16px;">Insights & Recommendations</h3>
                    ${insightItems}
                </div>
            `;
        }

        function renderHelperEarningsChart(earningsTrend) {
            if (!earningsTrend || earningsTrend.length === 0) {
                return `
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Earnings Trend</h3>
                            <span class="chart-period">Last 6 months</span>
                        </div>
                        <p class="screen-subtitle">No earnings data available yet.</p>
                    </div>
                `;
            }

            const maxValue = Math.max(...earningsTrend.map(([, value]) => value));
            const bars = earningsTrend.map(([month, value]) => {
                const height = maxValue > 0 ? (value / maxValue) * 100 : 0;
                return `
                    <div class="bar" style="height: ${height}%">
                        <div class="bar-label">${month.slice(-2)}</div>
                        <div class="bar-value">$${value.toFixed(0)}</div>
                    </div>
                `;
            }).join('');

            return `
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">Earnings Trend</h3>
                        <span class="chart-period">Last 6 months</span>
                    </div>
                    <div class="simple-bar-chart">
                        ${bars}
                    </div>
                </div>
            `;
        }

        function renderHelperCategoryChart(categoryBreakdown) {
            if (!categoryBreakdown || Object.keys(categoryBreakdown).length === 0) {
                return `
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Category Breakdown</h3>
                        </div>
                        <p class="screen-subtitle">Complete more errands to see category insights.</p>
                    </div>
                `;
            }

            const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4'];
            const categories = Object.entries(categoryBreakdown).map(([category, count], index) => `
                <div class="category-item">
                    <div class="category-color" style="background-color: ${colors[index % colors.length]}"></div>
                    <div class="category-name">${category.charAt(0).toUpperCase() + category.slice(1)}</div>
                    <div class="category-value">${count}</div>
                </div>
            `).join('');

            return `
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">Category Breakdown</h3>
                        <span class="chart-period">Completed errands</span>
                    </div>
                    <div class="category-breakdown">
                        ${categories}
                    </div>
                </div>
            `;
        }

        function renderHelperInsights(metrics) {
            const insights = [];
            
            if (metrics.acceptanceRate > 70) {
                insights.push({
                    type: 'success',
                    icon: '✓',
                    title: 'High Acceptance Rate',
                    description: `${metrics.acceptanceRate.toFixed(1)}% of your applications are accepted. Great profile!`
                });
            } else if (metrics.acceptanceRate < 30) {
                insights.push({
                    type: 'warning',
                    icon: '⚠',
                    title: 'Low Acceptance Rate',
                    description: 'Consider improving your profile and application messages to increase acceptance.'
                });
            }

            if (metrics.completionRate === 100 && metrics.completedErrands > 0) {
                insights.push({
                    type: 'success',
                    icon: '🏆',
                    title: 'Perfect Completion Rate',
                    description: 'You complete all accepted tasks. Customers love reliable helpers!'
                });
            }

            if (metrics.avgEarningsPerErrand > 25) {
                insights.push({
                    type: 'info',
                    icon: '💰',
                    title: 'Above Average Earnings',
                    description: `You earn $${metrics.avgEarningsPerErrand.toFixed(2)} per errand on average. Well done!`
                });
            }

            if (insights.length === 0) {
                insights.push({
                    type: 'info',
                    icon: 'ℹ',
                    title: 'Getting Started',
                    description: 'Apply to more errands and complete tasks to see personalized insights here.'
                });
            }

            const insightItems = insights.map(insight => `
                <div class="insight-item">
                    <div class="insight-icon ${insight.type}">
                        ${insight.icon}
                    </div>
                    <div class="insight-content">
                        <div class="insight-title">${insight.title}</div>
                        <div class="insight-description">${insight.description}</div>
                    </div>
                </div>
            `).join('');

            return `
                <div class="insights-list">
                    <h3 class="chart-title" style="margin-bottom: 16px;">Insights & Recommendations</h3>
                    ${insightItems}
                </div>
            `;
        }

        function renderCustomerSpendingChart(spendingTrend) {
            if (!spendingTrend || spendingTrend.length === 0) {
                return `
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Spending Trend</h3>
                            <span class="chart-period">Last 6 months</span>
                        </div>
                        <p class="screen-subtitle">No spending data available yet.</p>
                    </div>
                `;
            }

            const maxValue = Math.max(...spendingTrend.map(([, value]) => value));
            const bars = spendingTrend.map(([month, value]) => {
                const height = maxValue > 0 ? (value / maxValue) * 100 : 0;
                return `
                    <div class="bar" style="height: ${height}%">
                        <div class="bar-label">${month.slice(-2)}</div>
                        <div class="bar-value">$${value.toFixed(0)}</div>
                    </div>
                `;
            }).join('');

            return `
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">Spending Trend</h3>
                        <span class="chart-period">Last 6 months</span>
                    </div>
                    <div class="simple-bar-chart">
                        ${bars}
                    </div>
                </div>
            `;
        }

        function renderCustomerCategoryChart(categorySpending) {
            if (!categorySpending || Object.keys(categorySpending).length === 0) {
                return `
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Spending by Category</h3>
                        </div>
                        <p class="screen-subtitle">Make some purchases to see category breakdown.</p>
                    </div>
                `;
            }

            const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4'];
            const categories = Object.entries(categorySpending).map(([category, amount], index) => `
                <div class="category-item">
                    <div class="category-color" style="background-color: ${colors[index % colors.length]}"></div>
                    <div class="category-name">${category.charAt(0).toUpperCase() + category.slice(1)}</div>
                    <div class="category-value">$${amount.toFixed(2)}</div>
                </div>
            `).join('');

            return `
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">Spending by Category</h3>
                        <span class="chart-period">All time</span>
                    </div>
                    <div class="category-breakdown">
                        ${categories}
                    </div>
                </div>
            `;
        }

        function renderCustomerInsights(metrics) {
            const insights = [];
            
            if (metrics.savingsRate > 20) {
                insights.push({
                    type: 'success',
                    icon: '💰',
                    title: 'Great Savings!',
                    description: `You're saving ${metrics.savingsRate.toFixed(1)}% through group buys. Keep it up!`
                });
            }

            if (metrics.groupBuyParticipation > 80) {
                insights.push({
                    type: 'success',
                    icon: '👥',
                    title: 'Group Buy Champion',
                    description: `${metrics.groupBuyParticipation.toFixed(1)}% of your purchases are group buys. You're maximizing savings!`
                });
            } else if (metrics.groupBuyParticipation < 30) {
                insights.push({
                    type: 'info',
                    icon: '💡',
                    title: 'More Savings Available',
                    description: 'Join more group buys to increase your savings potential.'
                });
            }

            if (metrics.totalSavings > 100) {
                insights.push({
                    type: 'success',
                    icon: '🎉',
                    title: 'Savings Milestone',
                    description: `You've saved over $${metrics.totalSavings.toFixed(2)} through group buying!`
                });
            }

            if (insights.length === 0) {
                insights.push({
                    type: 'info',
                    icon: 'ℹ',
                    title: 'Start Saving',
                    description: 'Join group buys and complete errands to see personalized insights here.'
                });
            }

            const insightItems = insights.map(insight => `
                <div class="insight-item">
                    <div class="insight-icon ${insight.type}">
                        ${insight.icon}
                    </div>
                    <div class="insight-content">
                        <div class="insight-title">${insight.title}</div>
                        <div class="insight-description">${insight.description}</div>
                    </div>
                </div>
            `).join('');

            return `
                <div class="insights-list">
                    <h3 class="chart-title" style="margin-bottom: 16px;">Insights & Recommendations</h3>
                    ${insightItems}
                </div>
            `;
        }

        function createHelperData() {
            return { ...HelperDefaults };
        }

        const AppState = {
            user: null,
            loginMethod: null,
            currentScreen: 'start',
            selectedRoles: new Set(),
            helperStepIndex: 0,
            helperData: createHelperData(),
            products: [],
            orders: [],
            errands: [],
            applications: [],
            messages: [],
            filters: FilterDefaults()
        };

        const SeedData = {
            products: [
                {
                    id: 1,
                    title: 'Premium Korean Strawberries',
                    region: 'Toronto',
                    price: 38,
                    description: 'Sweet-picked winter strawberries flown in twice a week.',
                    deadline: '2025-02-01',
                    deliveryDate: '2025-02-05',
                    vendor: 'Soo Fresh Imports',
                    targetQuantity: 50,
                    currentQuantity: 32,
                    imageColor: '#f87171',
                    ownerEmail: 'vendor@soofresh.ca'
                },
                {
                    id: 2,
                    title: 'Hanwoo Beef Sharing',
                    region: 'Hamilton',
                    price: 120,
                    description: 'Family packs of marbled Grade A hanwoo beef.',
                    deadline: '2025-02-10',
                    deliveryDate: '2025-02-15',
                    vendor: 'Han Market',
                    targetQuantity: 25,
                    currentQuantity: 18,
                    imageColor: '#facc15',
                    ownerEmail: 'orders@hanmarket.ca'
                },
                {
                    id: 3,
                    title: 'Jeju Tangerine Crates',
                    region: 'Niagara',
                    price: 45,
                    description: '10kg crates of Jeju tangerines, direct from the island.',
                    deadline: '2025-02-05',
                    deliveryDate: '2025-02-09',
                    vendor: 'Island Co-op',
                    targetQuantity: 40,
                    currentQuantity: 12,
                    imageColor: '#fb923c',
                    ownerEmail: 'hello@islandcoop.ca'
                },
                {
                    id: 4,
                    title: 'Busan Fish Cake Party Pack',
                    region: 'Toronto',
                    price: 52,
                    description: 'Mix-and-match odeng assortment with spicy dipping sauces.',
                    deadline: '2025-02-12',
                    deliveryDate: '2025-02-17',
                    vendor: 'Harbor Foods',
                    targetQuantity: 60,
                    currentQuantity: 22,
                    imageColor: '#38bdf8',
                    ownerEmail: 'sales@harborfoods.ca'
                },
                {
                    id: 5,
                    title: 'Korean Pantry Essentials Kit',
                    region: 'Hamilton',
                    price: 85,
                    description: 'Bundle includes gochujang, doenjang, sesame oil, and seaweed.',
                    deadline: '2025-02-08',
                    deliveryDate: '2025-02-11',
                    vendor: 'Taste of Seou',
                    targetQuantity: 35,
                    currentQuantity: 14,
                    imageColor: '#a5b4fc',
                    ownerEmail: 'wholesale@tasteofseou.ca'
                }
            ],
            errands: [
                {
                    id: 1,
                    title: 'Weekly H-Mart Grocery Run',
                    region: 'Toronto',
                    description: 'Need kimchi, rice, and fresh tofu delivered to my apartment.',
                    budgetMin: 20,
                    budgetMax: 40,
                    preferredTime: '2025-01-28T10:00',
                    status: 'open',
                    requesterName: 'Emily Kim',
                    requesterEmail: 'emily@example.com',
                    createdAt: '2025-01-25'
                },
                {
                    id: 2,
                    title: 'Pharmacy Pickup for Mom',
                    region: 'Hamilton',
                    description: 'Pickup prescription from Shoppers and drop off near King St.',
                    budgetMin: 15,
                    budgetMax: 25,
                    preferredTime: '2025-01-27T15:00',
                    status: 'open',
                    requesterName: 'Daniel Lee',
                    requesterEmail: 'daniel@example.com',
                    createdAt: '2025-01-25'
                },
                {
                    id: 3,
                    title: 'Airport Drop-off Ride',
                    region: 'Niagara',
                    description: 'Need a ride to YYZ with 2 suitcases, leaving Saturday morning.',
                    budgetMin: 60,
                    budgetMax: 80,
                    preferredTime: '2025-02-01T07:00',
                    status: 'open',
                    requesterName: 'Grace Park',
                    requesterEmail: 'grace@example.com',
                    createdAt: '2025-01-24'
                },
                {
                    id: 4,
                    title: 'Document translation drop-off',
                    region: 'Toronto',
                    description: 'Need someone to collect translated docs near Yonge & Finch.',
                    budgetMin: 30,
                    budgetMax: 45,
                    preferredTime: '2025-01-29T12:30',
                    status: 'open',
                    requesterName: 'Heidi Cho',
                    requesterEmail: 'heidi@example.com',
                    createdAt: '2025-01-26'
                }
            ]
        };

        function normalizeProducts(list = []) {
            return list.map((product, index) => ({
                ...product,
                id: product.id ?? Date.now() + index,
                targetQuantity: product.targetQuantity ?? product.target_quantity ?? 1,
                currentQuantity: product.currentQuantity ?? product.current_quantity ?? 0,
                ownerEmail: product.ownerEmail ?? product.owner_email ?? null,
                createdAt: product.createdAt || product.created_at || new Date().toISOString()
            }));
        }

        function normalizeErrands(list = []) {
            return list.map((errand, index) => ({
                ...errand,
                id: errand.id ?? Date.now() + index,
                requesterEmail: errand.requesterEmail ?? errand.requester_email ?? '',
                requesterName: errand.requesterName ?? errand.requester_name ?? '',
                budgetMin: errand.budgetMin ?? errand.budget_min ?? 0,
                budgetMax: errand.budgetMax ?? errand.budget_max ?? 0,
                preferredTime: errand.preferredTime ?? errand.preferred_time ?? '',
                status: errand.status || 'open',
                assignedHelperEmail: errand.assignedHelperEmail ?? errand.assigned_helper_email ?? null,
                assignedHelperName: errand.assignedHelperName ?? errand.assigned_helper_name ?? null,
                acceptedHelperId: errand.acceptedHelperId ?? errand.accepted_helper_id ?? null,
                createdAt: errand.createdAt || errand.created_at || new Date().toISOString()
            }));
        }

        function normalizeApplications(list = []) {
            return list.map(app => ({
                ...app,
                status: app.status || 'pending'
            }));
        }

        async function loadErrandsFromBackend() {
            if (!supabaseClient) {
                // Fallback: use existing key–value store / seeds
                const storedErrands = await dbLoadSlice(StorageKeys.errands, SeedData.errands);
                AppState.errands = normalizeErrands(storedErrands);
                const storedApps = await dbLoadSlice(StorageKeys.applications, []);
                AppState.applications = normalizeApplications(storedApps);
                const storedMessages = await dbLoadSlice(StorageKeys.messages, []);
                AppState.messages = storedMessages || [];
                return;
            }

            const { data: errandsData, error: errErr } = await supabaseClient
                .from('errands')
                .select('*')
                .order('created_at', { ascending: false });
            if (errErr) {
                console.error('Error loading errands', errErr);
                AppState.errands = normalizeErrands(SeedData.errands);
            } else {
                // Transform database format to app format
                const transformedErrands = (errandsData || []).map(e => ({
                    id: e.id,
                    title: e.title,
                    description: e.description,
                    region: e.region,
                    budget: parseFloat(e.budget || 0),
                    deadline: e.deadline,
                    status: e.status,
                    requesterEmail: e.requester_email,
                    assignedHelperEmail: e.assigned_helper_email,
                    assignedHelperName: e.assigned_helper_name,
                    acceptedHelperId: e.accepted_helper_id,
                    createdAt: e.created_at
                }));
                AppState.errands = normalizeErrands(transformedErrands);
            }

            const { data: appsData, error: appErr } = await supabaseClient
                .from('applications')
                .select('*')
                .order('created_at', { ascending: false });
            if (appErr) {
                console.error('Error loading applications', appErr);
                AppState.applications = normalizeApplications([]);
            } else {
                // Transform database format to app format
                const transformedApps = (appsData || []).map(a => ({
                    id: a.id,
                    errandId: a.errand_id,
                    helperEmail: a.helper_email,
                    helperName: a.helper_name,
                    offerAmount: parseFloat(a.offer_amount || 0),
                    message: a.message,
                    status: a.status,
                    createdAt: a.created_at
                }));
                AppState.applications = normalizeApplications(transformedApps);
            }

            const { data: msgData, error: msgErr } = await supabaseClient
                .from('messages')
                .select('*')
                .order('created_at', { ascending: false });
            if (msgErr) {
                console.error('Error loading messages', msgErr);
                AppState.messages = [];
            } else {
                // Transform database format to app format
                const transformedMessages = (msgData || []).map(m => ({
                    id: m.id,
                    senderEmail: m.sender_email,
                    senderName: m.sender_name,
                    recipientEmail: m.recipient_email,
                    productId: m.product_id,
                    errandId: m.errand_id,
                    body: m.body,
                    createdAt: m.created_at
                }));
                AppState.messages = transformedMessages;
            }
        }

        async function saveErrandsToBackend() {
            if (!supabaseClient || !AppState.user?.id) {
                // Fallback to existing key–value behavior
                dbSaveSlice(StorageKeys.errands, AppState.errands);
                dbSaveSlice(StorageKeys.applications, AppState.applications);
                dbSaveSlice(StorageKeys.messages, AppState.messages);
                return;
            }

            const errandsPayload = AppState.errands.map(e => ({
                id: e.id,
                requester_id: AppState.user.id,
                requester_email: e.requesterEmail,
                title: e.title,
                description: e.description,
                region: e.region,
                budget: e.budget || e.budgetMin || 0,
                deadline: e.deadline,
                status: e.status,
                assigned_helper_id: e.acceptedHelperId || null,
                assigned_helper_email: e.assignedHelperEmail,
                assigned_helper_name: e.assignedHelperName,
                accepted_helper_id: e.acceptedHelperId || null,
                created_at: e.createdAt
            }));
            const { error: errErr } = await supabaseClient
                .from('errands')
                .upsert(errandsPayload, { onConflict: 'id' });
            if (errErr) {
                console.error('Error saving errands', errErr);
            }

            const appsPayload = AppState.applications.map(a => ({
                id: a.id,
                errand_id: a.errandId,
                helper_id: AppState.user.id,
                helper_email: a.helperEmail,
                helper_name: a.helperName,
                offer_amount: a.offerAmount,
                message: a.message,
                status: a.status,
                created_at: a.createdAt
            }));
            const { error: appErr } = await supabaseClient
                .from('applications')
                .upsert(appsPayload, { onConflict: 'id' });
            if (appErr) {
                console.error('Error saving applications', appErr);
            }

            const msgsPayload = AppState.messages.map(m => ({
                id: m.id,
                sender_id: AppState.user.id,
                sender_email: m.senderEmail,
                sender_name: m.senderName,
                recipient_email: m.recipientEmail,
                product_id: m.productId,
                errand_id: m.errandId,
                body: m.body,
                created_at: m.createdAt
            }));
            const { error: msgErr } = await supabaseClient
                .from('messages')
                .upsert(msgsPayload, { onConflict: 'id' });
            if (msgErr) {
                console.error('Error saving messages', msgErr);
            }
        }

        async function loadProductsFromBackend() {
            if (!supabaseClient) {
                const storedProducts = await dbLoadSlice(StorageKeys.products, SeedData.products);
                AppState.products = normalizeProducts(storedProducts);
                return;
            }
            const { data, error } = await supabaseClient
                .from('products')
                .select('*')
                .order('created_at', { ascending: false });
            if (error) {
                console.error('Error loading products', error);
                AppState.products = normalizeProducts(SeedData.products);
            } else {
                // Transform database format to app format
                const transformedProducts = (data || []).map(p => ({
                    id: p.id,
                    title: p.title,
                    region: p.region,
                    price: parseFloat(p.price),
                    description: p.description,
                    deadline: p.deadline,
                    deliveryDate: p.delivery_date,
                    vendor: p.vendor,
                    targetQuantity: p.target_quantity,
                    currentQuantity: p.current_quantity,
                    imageColor: p.image_color,
                    imageDataUrl: p.image_data_url,
                    ownerEmail: p.owner_email,
                    createdAt: p.created_at
                }));
                AppState.products = normalizeProducts(transformedProducts);
            }
        }

        async function saveProductsToBackend() {
            if (!supabaseClient || !AppState.user?.id) {
                dbSaveSlice(StorageKeys.products, AppState.products);
                return;
            }
            const payload = AppState.products.map(p => ({
                id: p.id,
                owner_id: AppState.user.id,
                owner_email: p.ownerEmail,
                title: p.title,
                description: p.description,
                region: p.region,
                price: p.price,
                deadline: p.deadline,
                delivery_date: p.deliveryDate,
                target_quantity: p.targetQuantity,
                current_quantity: p.currentQuantity,
                vendor: p.vendor,
                image_color: p.imageColor,
                image_data_url: p.imageDataUrl,
                created_at: p.createdAt
            }));
            const { error } = await supabaseClient
                .from('products')
                .upsert(payload, { onConflict: 'id' });
            if (error) {
                console.error('Error saving products', error);
            }
        }

        async function loadOrdersFromBackend() {
            if (!supabaseClient) {
                const storedOrders = await dbLoadSlice(StorageKeys.orders, []);
                AppState.orders = normalizeOrders(storedOrders);
                return;
            }
            const { data, error } = await supabaseClient
                .from('orders')
                .select('*')
                .order('created_at', { ascending: false });
            if (error) {
                console.error('Error loading orders', error);
                AppState.orders = normalizeOrders([]);
            } else {
                // Transform database format to app format
                const transformedOrders = (data || []).map(o => ({
                    id: o.id,
                    productId: o.product_id,
                    customerEmail: o.customer_email,
                    vendorEmail: o.vendor_email,
                    quantity: o.quantity,
                    totalPrice: parseFloat(o.total_price),
                    fulfillmentStatus: o.fulfillment_status,
                    cancelled: o.cancelled,
                    createdAt: o.created_at
                }));
                AppState.orders = normalizeOrders(transformedOrders);
            }
        }

        // Realtime subscriptions for live updates
        let realtimeSubscriptions = [];

        function setupRealtimeSubscriptions() {
            if (!supabaseClient) return;

            // Clean up existing subscriptions
            realtimeSubscriptions.forEach(sub => {
                supabaseClient.removeChannel(sub);
            });
            realtimeSubscriptions = [];

            // Subscribe to products changes
            const productsChannel = supabaseClient
                .channel('products-changes')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'products'
                }, (payload) => {
                    console.log('Products change detected:', payload);
                    loadProductsFromBackend();
                    if (AppState.currentScreen === 'browse') {
                        renderProductList();
                    }
                })
                .subscribe();
            realtimeSubscriptions.push(productsChannel);

            // Subscribe to orders changes
            const ordersChannel = supabaseClient
                .channel('orders-changes')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'orders'
                }, (payload) => {
                    console.log('Orders change detected:', payload);
                    loadOrdersFromBackend();
                    if (AppState.currentScreen === 'dashboard') {
                        renderDashboard();
                    }
                })
                .subscribe();
            realtimeSubscriptions.push(ordersChannel);

            // Subscribe to errands changes
            const errandsChannel = supabaseClient
                .channel('errands-changes')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'errands'
                }, (payload) => {
                    console.log('Errands change detected:', payload);
                    loadErrandsFromBackend();
                    if (AppState.currentScreen === 'errands') {
                        renderErrandList();
                    }
                })
                .subscribe();
            realtimeSubscriptions.push(errandsChannel);

            // Subscribe to applications changes
            const applicationsChannel = supabaseClient
                .channel('applications-changes')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'applications'
                }, (payload) => {
                    console.log('Applications change detected:', payload);
                    loadErrandsFromBackend(); // This loads applications too
                    if (AppState.currentScreen === 'dashboard') {
                        renderDashboard();
                    }
                })
                .subscribe();
            realtimeSubscriptions.push(applicationsChannel);

            // Subscribe to messages changes
            const messagesChannel = supabaseClient
                .channel('messages-changes')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'messages'
                }, (payload) => {
                    console.log('Messages change detected:', payload);
                    loadErrandsFromBackend(); // This loads messages too
                    // Refresh any open product or errand detail views
                    if (AppState.currentScreen === 'product-detail' || AppState.currentScreen === 'errand-detail') {
                        // The detail views will be refreshed by the message loading
                    }
                })
                .subscribe();
            realtimeSubscriptions.push(messagesChannel);
        }

        async function saveOrdersToBackend() {
            if (!supabaseClient || !AppState.user?.id) {
                dbSaveSlice(StorageKeys.orders, AppState.orders);
                return;
            }
            const payload = AppState.orders.map(o => ({
                id: o.id,
                product_id: o.productId,
                customer_id: AppState.user.id,
                customer_email: o.customerEmail,
                vendor_email: o.vendorEmail,
                quantity: o.quantity,
                total_price: o.totalPrice || o.total || 0,
                fulfillment_status: o.fulfillmentStatus || 'pending',
                cancelled: o.cancelled || false,
                created_at: o.createdAt
            }));
            const { error } = await supabaseClient
                .from('orders')
                .upsert(payload, { onConflict: 'id' });
            if (error) {
                console.error('Error saving orders', error);
            }
        }

        function normalizeOrders(list = []) {
            return list.map(order => ({
                ...order,
                groupStatus: order.groupStatus || 'open',
                fulfillmentStatus: order.fulfillmentStatus || 'pending',
                createdAt: order.createdAt || new Date().toISOString(),
                updatedAt: order.updatedAt || order.createdAt || new Date().toISOString(),
                cancelled: Boolean(order.cancelled)
            }));
        }

        const FulfillmentStages = ['pending', 'confirmed', 'prepared', 'delivered'];
        const ErrandStatusFlow = ['open', 'matched', 'in_progress', 'completed'];

        function saveState() {
            // Fire-and-forget persistence to keep existing call sites synchronous.
            dbSaveSlice(StorageKeys.user, AppState.user || null);
            dbSaveSlice(StorageKeys.helper, AppState.helperData);
            dbSaveSlice(StorageKeys.products, AppState.products);
            dbSaveSlice(StorageKeys.orders, AppState.orders);
            dbSaveSlice(StorageKeys.errands, AppState.errands);
            dbSaveSlice(StorageKeys.applications, AppState.applications);
            dbSaveSlice(StorageKeys.messages, AppState.messages);
            dbSaveSlice(StorageKeys.loginMethod, AppState.loginMethod || null);
        }

        async function persistUser() {
            if (!supabaseClient || !AppState.user?.id) {
                // Fallback to localStorage for non-Supabase users
            saveState();
                return;
            }

            try {
                // Update user profile in Supabase
                const { error } = await supabaseClient
                    .from('user_profiles')
                    .upsert({
                        id: AppState.user.id,
                        email: AppState.user.email,
                        full_name: AppState.user.name,
                        photo_url: AppState.user.photoUrl || '',
                        roles: AppState.user.roles || [],
                        primary_role: AppState.user.role,
                        helper_verified: AppState.user.helperVerified || false,
                        helper_phone: AppState.helperData?.phone || null,
                        helper_address: AppState.helperData?.address || null,
                        helper_photo_url: AppState.helperData?.photoDataUrl || null,
                        updated_at: new Date().toISOString()
                    }, { onConflict: 'id' });

                if (error) {
                    console.error('Error updating user profile', error);
                    // Fallback to localStorage
                    saveState();
                }
            } catch (e) {
                console.error('Error persisting user', e);
                // Fallback to localStorage
                saveState();
            }
        }

        function persistHelperData() {
            saveState();
        }

        function persistOrders() {
            saveState();
            saveOrdersToBackend();
        }

        function persistErrands() {
            saveState();
            saveErrandsToBackend();
        }

        function persistApplications() {
            saveState();
            saveErrandsToBackend();
        }

        function handleVendorOrderStatus(event) {
            if (!AppState.filters.vendorOrders) {
                AppState.filters.vendorOrders = { status: 'all', search: '' };
            }
            AppState.filters.vendorOrders.status = event.target.value;
            renderDashboard();
        }

        function handleVendorOrderSearch(event) {
            if (!AppState.filters.vendorOrders) {
                AppState.filters.vendorOrders = { status: 'all', search: '' };
            }
            AppState.filters.vendorOrders.search = event.target.value;
            renderDashboard();
        }

        function resetState() {
            AppState.user = null;
            AppState.loginMethod = null;
            AppState.currentScreen = 'start';
            AppState.selectedRoles = new Set();
            AppState.helperStepIndex = 0;
            AppState.helperData = createHelperData();
            AppState.products = normalizeProducts(SeedData.products);
            AppState.orders = [];
            AppState.errands = normalizeErrands(SeedData.errands);
            AppState.applications = [];
            AppState.filters = FilterDefaults();
            saveState();
        }

        function resetApp() {
            const content = `
                <h3 class="modal-title">Reset App Data</h3>
                <p class="modal-subtitle">This action cannot be undone. The following will be deleted:</p>
                <ul style="margin:1rem 0; padding-left:1.5rem; color:#475569; line-height:1.8;">
                    <li>All orders and group buy commitments</li>
                    <li>All errands and helper applications</li>
                    <li>All created products (vendor products)</li>
                    <li>Your login session and profile</li>
                    <li>Helper verification data</li>
                </ul>
                <p style="margin-top:1rem; padding:0.75rem; background:#fee2e2; border-radius:8px; color:#991b1b; font-size:0.9rem;">
                    <strong>⚠️ Warning:</strong> You will need to sign up and verify again after reset.
                </p>
                <div class="modal-footer" style="margin-top:1.5rem;">
                    <button type="button" class="btn btn-ghost" onclick="closeModal()">Cancel</button>
                    <button type="button" class="btn reset-btn" onclick="confirmResetApp()">Reset Everything</button>
                </div>
            `;
            showModal(content);
        }

        function confirmResetApp() {
            resetState();
            dbClearAll();
            closeModal();
            updateNavbar();
            renderGroupBuyList();
            renderMarketplaceHighlights();
            renderErrandList();
            renderDashboard();
            showScreen('start');
            showToast('App reset to default state. All data cleared.', 'info');
        }

        async function loadState() {
            const profile = await dbLoadSlice(StorageKeys.user, null);
            if (profile) {
                AppState.user = profile;
                if (!Array.isArray(AppState.user.roles)) {
                    const legacyRole = AppState.user.role ? [AppState.user.role] : [];
                    AppState.user.roles = legacyRole;
                }
            }
            const helperData = await dbLoadSlice(StorageKeys.helper, null);
            if (helperData) {
                AppState.helperData = { ...AppState.helperData, ...helperData };
            }

            // If a Supabase auth session exists, prefer that user.
            if (supabaseClient) {
                try {
                    const { data, error } = await supabaseClient.auth.getUser();
                    if (!error && data?.user) {
                        const u = data.user;
                        
                        // Load user profile from database
                        const { data: profileData, error: profileError } = await supabaseClient
                            .from('user_profiles')
                            .select('*')
                            .eq('id', u.id)
                            .single();

                        if (!profileError && profileData) {
                        AppState.user = {
                                id: u.id,
                                name: profileData.full_name || u.user_metadata?.full_name || u.email,
                                email: u.email,
                                photoUrl: profileData.photo_url || u.user_metadata?.avatar_url || '',
                                roles: profileData.roles || [],
                                role: profileData.primary_role || null,
                                helperVerified: profileData.helper_verified || false
                            };
                            AppState.selectedRoles = new Set(AppState.user.roles);
                        } else {
                            // Fallback for users without profiles yet
                            AppState.user = {
                                id: u.id,
                                name: u.user_metadata?.full_name || u.email,
                                email: u.email,
                                photoUrl: u.user_metadata?.avatar_url || '',
                                roles: [],
                                role: null,
                                helperVerified: false
                            };
                        }
                        AppState.loginMethod = u.app_metadata?.provider === 'google' ? 'google' : 'supabase';
                    }
                } catch (e) {
                    console.error('Error getting Supabase auth user', e);
                }
            }

            await loadProductsFromBackend();
            await loadOrdersFromBackend();
            await loadErrandsFromBackend();

            AppState.loginMethod = await dbLoadSlice(StorageKeys.loginMethod, null);
            AppState.selectedRoles = new Set(AppState.user?.roles || []);
            if (!AppState.filters) {
                AppState.filters = FilterDefaults();
            }
        }

        /**
         * Initialization
         */
        async function initApp() {
            setLoading(true);
            
            // Initialize language and accessibility
            initializeAccessibility();
            
            await loadState();
            
            // Load data from backend
            await loadProductsFromBackend();
            await loadOrdersFromBackend();
            await loadErrandsFromBackend();
            
            // Setup realtime subscriptions for live updates
            setupRealtimeSubscriptions();
            
            refreshOrderStatuses();
            updateNavbar();
            determineInitialScreen();
            showScreen(AppState.currentScreen);
            renderMarketplaceHighlights();
            renderGroupBuyList();
            renderErrandList();
            if (AppState.user) {
                renderDashboard();
            }
            initializeModalRoot();
            enhanceDateTimeInputs();
            if (!AppState.user) {
                initializeGoogleSignIn();
            }
            setLoading(false);
        }

        function initializeAccessibility() {
            // Set initial language
            const savedLang = localStorage.getItem('preferred-language') || 'en';
            setLanguage(savedLang);
            
            // Add keyboard navigation support
            document.addEventListener('keydown', handleKeyboardNavigation);
            
            // Add focus management
            setupFocusManagement();
            
            // Add screen reader announcements
            setupScreenReaderSupport();
            
            // Update language toggle buttons
            updateLanguageToggle();
        }

        function handleKeyboardNavigation(event) {
            // Escape key closes modals
            if (event.key === 'Escape') {
                const modal = document.querySelector('.modal.active');
                if (modal) {
                    closeModal();
                    event.preventDefault();
                }
            }
            
            // Tab navigation for bottom nav on mobile
            if (event.key === 'Tab' && window.innerWidth <= 768) {
                const bottomNav = document.getElementById('bottom-nav');
                if (bottomNav && bottomNav.style.display !== 'none') {
                    const navItems = bottomNav.querySelectorAll('.bottom-nav-item');
                    const currentFocus = document.activeElement;
                    const currentIndex = Array.from(navItems).indexOf(currentFocus);
                    
                    if (event.shiftKey && currentIndex === 0) {
                        // Shift+Tab from first item, focus last item
                        navItems[navItems.length - 1].focus();
                        event.preventDefault();
                    } else if (!event.shiftKey && currentIndex === navItems.length - 1) {
                        // Tab from last item, focus first item
                        navItems[0].focus();
                        event.preventDefault();
                    }
                }
            }
        }

        function setupFocusManagement() {
            // Trap focus in modals
            document.addEventListener('focusin', (event) => {
                const modal = document.querySelector('.modal.active');
                if (modal && !modal.contains(event.target)) {
                    const focusableElements = modal.querySelectorAll(
                        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
                    );
                    if (focusableElements.length > 0) {
                        focusableElements[0].focus();
                    }
                }
            });
        }

        function setupScreenReaderSupport() {
            // Create live region for announcements
            const liveRegion = document.createElement('div');
            liveRegion.id = 'live-region';
            liveRegion.setAttribute('aria-live', 'polite');
            liveRegion.setAttribute('aria-atomic', 'true');
            liveRegion.className = 'sr-only';
            document.body.appendChild(liveRegion);
        }

        function announceToScreenReader(message) {
            const liveRegion = document.getElementById('live-region');
            if (liveRegion) {
                liveRegion.textContent = message;
                // Clear after announcement
                setTimeout(() => {
                    liveRegion.textContent = '';
                }, 1000);
            }
        }

        function updateLanguageToggle() {
            const buttons = document.querySelectorAll('.language-btn');
            buttons.forEach(btn => {
                btn.classList.remove('active');
                if ((btn.textContent.includes('EN') && currentLanguage === 'en') ||
                    (btn.textContent.includes('한국어') && currentLanguage === 'ko')) {
                    btn.classList.add('active');
                }
            });
        }

        // Enhanced showToast with accessibility
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.textContent = message;
            
            // Add to page
            document.body.appendChild(toast);
            
            // Announce to screen readers
            announceToScreenReader(message);
            
            // Auto-remove
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 5000);
        }

        // Enhanced form validation with accessibility
        function validateForm(formElement) {
            const inputs = formElement.querySelectorAll('input[required], select[required], textarea[required]');
            let isValid = true;
            let firstInvalidField = null;
            
            inputs.forEach(input => {
                const errorElement = document.getElementById(input.id + '-error');
                
                if (!input.value.trim()) {
                    isValid = false;
                    if (errorElement) {
                        errorElement.textContent = t('validation.required', 'This field is required');
                    }
                    input.setAttribute('aria-invalid', 'true');
                    if (!firstInvalidField) firstInvalidField = input;
                } else {
                    if (errorElement) {
                        errorElement.textContent = '';
                    }
                    input.setAttribute('aria-invalid', 'false');
                }
            });
            
            // Focus first invalid field
            if (firstInvalidField) {
                firstInvalidField.focus();
                announceToScreenReader(t('validation.errors', 'Please correct the errors in the form'));
            }
            
            return isValid;
        }

        function determineInitialScreen() {
            if (!AppState.user) {
                AppState.currentScreen = 'start';
                return;
            }
            const roles = AppState.user.roles || [];
            if (!roles.length) {
                AppState.currentScreen = 'role';
                return;
            }
            AppState.currentScreen = 'browse';
        }

        /**
         * Screen / Navbar helpers
         */
        function showScreen(name) {
            AppState.currentScreen = name;
            document.querySelectorAll('.screen').forEach(section => section.classList.remove('active'));
            const target = document.getElementById(`screen-${name}`);
            if (target) target.classList.add('active');

            if (name === 'auth') {
                setTimeout(renderGoogleSignInButton, 0);
            } else if (name === 'role') {
                AppState.selectedRoles = new Set(AppState.user?.roles || Array.from(AppState.selectedRoles));
                refreshRoleCards();
            } else if (name === 'helper') {
                renderHelperStep();
            } else if (name === 'dashboard') {
                renderDashboard();
            } else if (name === 'profile') {
                renderProfile();
            } else if (name === 'browse') {
                renderMarketplaceHighlights();
            } else if (name === 'groupbuys') {
                renderGroupBuyList();
            } else if (name === 'errands') {
                renderErrandList();
            }

            updateNavbar();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function goToScreen(name) {
            if (name === 'auth' && AppState.user) {
                advanceAfterAuthentication();
                return;
            }
            showScreen(name);
        }

        function updateNavbar() {
            const actions = document.getElementById('navbar-actions');
            const links = document.getElementById('navbar-links');
            if (links) {
                const labelMap = {
                    start: 'Home',
                    browse: 'Browse',
                    groupbuys: 'Group Buys',
                    errands: 'Errands',
                    dashboard: 'Dashboard'
                };
                const navItems = AppState.user
                    ? ['browse', 'groupbuys', 'errands', 'dashboard']
                    : ['start', 'groupbuys', 'errands'];
                links.innerHTML = navItems.map(screen => `
                    <a href="#" class="nav-link ${AppState.currentScreen === screen ? 'active' : ''}" onclick="goToScreen('${screen}'); return false;">
                        ${labelMap[screen]}
                    </a>
                `).join('');
            }

            if (!actions) return;

            const resetButton = `<button class="btn reset-btn" onclick="resetApp()">Reset App</button>`;

            if (!AppState.user) {
                actions.innerHTML = `
                    <button class="primary-cta" style="padding:0.5rem 1.5rem; box-shadow:none;" onclick="goToScreen('auth')">
                        Login / Sign Up
                    </button>
                    ${resetButton}
                `;
                updateBottomNav();
                return;
            }

            const initials = getInitials(AppState.user.name);
            const roles = AppState.user.roles || [];
            const roleBadges = roles.length
                ? roles.map(role => `<span class="role-badge ${role === 'helper' ? 'helper' : ''}">${role.toUpperCase()}</span>`).join(' ')
                : '<span class="role-badge">UNSET</span>';
            const verifiedBadge = roles.includes('helper') && AppState.user.helperVerified
                ? '<span class="verification-badge">Verified ✓</span>'
                : '';

            actions.innerHTML = `
                <div class="profile-pill">
                    ${AppState.user.photoUrl ? `<img src="${AppState.user.photoUrl}" alt="profile" />` : `<div class="role-badge">${initials}</div>`}
                    <div>
                        <div style="font-weight:600;">${AppState.user.name}</div>
                        <div style="display:flex; align-items:center; gap:0.4rem; flex-wrap:wrap;">
                            ${roleBadges}
                            ${verifiedBadge}
                        </div>
                    </div>
                </div>
                <div style="display:flex; gap:0.5rem; flex-wrap:wrap; justify-content:flex-end;">
                    ${resetButton}
                <button class="btn btn-secondary" onclick="logout()">Logout</button>
                </div>
            `;
            
            updateBottomNav();
            updateFab();
        }

        function updateBottomNav() {
            const bottomNav = document.getElementById('bottom-nav');
            const fab = document.getElementById('fab');
            
            if (!bottomNav) return;
            
            // Show/hide bottom nav based on user state
            if (AppState.user) {
                bottomNav.style.display = 'block';
                if (fab) fab.style.display = 'flex';
                
                // Update active state
                const navItems = bottomNav.querySelectorAll('.bottom-nav-item');
                navItems.forEach(item => {
                    const screen = item.dataset.screen;
                    if (screen === AppState.currentScreen || 
                        (screen === 'browse' && AppState.currentScreen === 'start') ||
                        (screen === 'groupbuys' && AppState.currentScreen === 'groupbuys') ||
                        (screen === 'profile' && AppState.currentScreen === 'profile')) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });
            } else {
                bottomNav.style.display = 'none';
                if (fab) fab.style.display = 'none';
            }
        }

        function updateFab() {
            const fab = document.getElementById('fab');
            if (!fab || !AppState.user) return;
            
            // Change FAB icon and action based on current screen and user roles
            const roles = AppState.user.roles || [];
            let icon = '➕';
            let title = 'Quick Action';
            
            if (AppState.currentScreen === 'errands' && roles.includes('customer')) {
                icon = '📝';
                title = 'Post Errand';
            } else if ((AppState.currentScreen === 'groupbuys' || AppState.currentScreen === 'browse') && roles.includes('vendor')) {
                icon = '🏪';
                title = 'Create Group Buy';
            } else if (AppState.currentScreen === 'browse') {
                if (roles.includes('vendor')) {
                    icon = '🏪';
                    title = 'Create Group Buy';
                } else if (roles.includes('customer')) {
                    icon = '📝';
                    title = 'Post Errand';
                }
            }
            
            fab.innerHTML = icon;
            fab.title = title;
        }

        function handleFabClick() {
            if (!AppState.user) return;
            
            const roles = AppState.user.roles || [];
            const fabMenu = document.getElementById('fab-menu');
            
            // Toggle menu visibility
            if (fabMenu && fabMenu.style.display === 'block') {
                hideFabMenu();
                return;
            }
            
            // Show context-sensitive actions
            showFabMenu();
        }

        function showFabMenu() {
            const roles = AppState.user.roles || [];
            let actions = [];
            
            // Add actions based on user roles
            if (roles.includes('vendor')) {
                actions.push({
                    icon: '🏪',
                    label: 'Create Group Buy',
                    action: () => {
                        goToScreen('dashboard');
                        setTimeout(() => {
                            const createForm = document.querySelector('[onsubmit="handleAddProduct(event)"]');
                            if (createForm) {
                                createForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                const titleInput = document.querySelector('[name="vendor-product-title"]');
                                if (titleInput) titleInput.focus();
                            }
                        }, 100);
                        hideFabMenu();
                    }
                });
            }
            
            if (roles.includes('customer')) {
                actions.push({
                    icon: '🤝',
                    label: 'Post Errand',
                    action: () => {
                        goToScreen('errands');
                        setTimeout(() => {
                            const createForm = document.getElementById('create-errand-form');
                            if (createForm) {
                                createForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                const titleInput = document.getElementById('errand-title');
                                if (titleInput) titleInput.focus();
                            }
                        }, 100);
                        hideFabMenu();
                    }
                });
            }
            
            if (roles.includes('helper')) {
                actions.push({
                    icon: '🔍',
                    label: 'Browse Errands',
                    action: () => {
                        goToScreen('errands');
                        hideFabMenu();
                    }
                });
            }
            
            // Always show browse option
            actions.push({
                icon: '🛒',
                label: 'Browse Group Buys',
                action: () => {
                    goToScreen('groupbuys');
                    hideFabMenu();
                }
            });
            
            // Create or update menu
            let fabMenu = document.getElementById('fab-menu');
            if (!fabMenu) {
                fabMenu = document.createElement('div');
                fabMenu.id = 'fab-menu';
                fabMenu.className = 'fab-menu';
                document.body.appendChild(fabMenu);
            }
            
            fabMenu.innerHTML = actions.map(action => `
                <button class="fab-menu-item" onclick="(${action.action.toString()})()">
                    <span class="fab-menu-icon">${action.icon}</span>
                    <span class="fab-menu-label">${action.label}</span>
                </button>
            `).join('');
            
            fabMenu.style.display = 'block';
            
            // Close menu when clicking outside
            setTimeout(() => {
                document.addEventListener('click', closeFabMenuOnOutsideClick, { once: true });
            }, 0);
        }

        function hideFabMenu() {
            const fabMenu = document.getElementById('fab-menu');
            if (fabMenu) {
                fabMenu.style.display = 'none';
            }
        }

        function closeFabMenuOnOutsideClick(event) {
            const fabMenu = document.getElementById('fab-menu');
            const fab = document.getElementById('fab');
            
            if (fabMenu && !fabMenu.contains(event.target) && !fab.contains(event.target)) {
                hideFabMenu();
            }
        }

        function getInitials(name = '') {
            return name.split(' ').map(part => part[0]?.toUpperCase() || '').slice(0, 2).join('');
        }

        /**
         * Authentication (Email)
         */
        async function handleEmailSignUp(event) {
            event.preventDefault();
            const fullName = document.getElementById('full-name').value.trim();
            const email = document.getElementById('email-address').value.trim();
            const password = document.getElementById('password-input').value;

            if (!email || password.length < 6) {
                showToast('Please provide a valid email and password (6+ chars).', 'warning');
                return;
            }

            if (!isSignInMode && !fullName) {
                showToast('Please provide your full name.', 'warning');
                return;
            }

            if (!supabaseClient) {
                showToast('Authentication service not available.', 'error');
                return;
            }

            try {
                if (isSignInMode) {
                    // Sign in existing user
                    const { data, error } = await supabaseClient.auth.signInWithPassword({
                email,
                        password
                    });

                    if (error) {
                        console.error('Supabase sign-in error', error);
                        showToast(error.message || 'Invalid email or password.', 'error');
                        return;
                    }

                    if (data?.user) {
                        await handleSuccessfulAuth(data.user);
                    }
                } else {
                    // Sign up new user
                    const { data, error } = await supabaseClient.auth.signUp({
                        email,
                        password,
                        options: {
                            data: {
                                full_name: fullName
                            }
                        }
                    });

                    if (error) {
                        console.error('Supabase sign-up error', error);
                        showToast(error.message || 'Failed to create account.', 'error');
                        return;
                    }

                    if (data?.user) {
                        if (data.user.email_confirmed_at) {
                            // User is immediately confirmed
                            await handleSuccessfulAuth(data.user, fullName);
                        } else {
                            // Email confirmation required
                            document.getElementById('verification-message').style.display = 'block';
                            showToast('Please check your email for verification link.', 'info');
                        }
                    }
                }
            } catch (e) {
                console.error('Authentication error', e);
                showToast('Authentication failed. Please try again.', 'error');
            }
        }

        // New streamlined sign-up handler with integrated role selection
        async function handleStreamlinedSignUp(event) {
            event.preventDefault();
            const fullName = document.getElementById('full-name').value.trim();
            const email = document.getElementById('email-address').value.trim();
            const password = document.getElementById('password-input').value;

            if (!email || password.length < 6) {
                showToast('Please provide a valid email and password (6+ chars).', 'warning');
                return;
            }

            if (!isSignInMode && !fullName) {
                showToast('Please provide your name.', 'warning');
                return;
            }

            // Get selected roles
            const selectedRoles = [];
            document.querySelectorAll('input[name="roles"]:checked').forEach(checkbox => {
                selectedRoles.push(checkbox.value);
            });

            if (!isSignInMode && selectedRoles.length === 0) {
                showToast('Please select at least one way to participate.', 'warning');
                return;
            }

            if (!supabaseClient) {
                showToast('Authentication service not available.', 'error');
                return;
            }

            try {
                if (isSignInMode) {
                    // Sign in existing user
                    const { data, error } = await supabaseClient.auth.signInWithPassword({
                        email,
                        password
                    });

                    if (error) {
                        console.error('Supabase sign-in error', error);
                        showToast(error.message || 'Invalid email or password.', 'error');
                        return;
                    }

                    if (data?.user) {
                        await handleSuccessfulAuth(data.user);
                    }
                } else {
                    // Sign up new user with roles
                    const { data, error } = await supabaseClient.auth.signUp({
                        email,
                        password,
                        options: {
                            data: {
                                full_name: fullName,
                                roles: selectedRoles
                            }
                        }
                    });

                    if (error) {
                        console.error('Supabase sign-up error', error);
                        showToast(error.message || 'Failed to create account.', 'error');
                        return;
                    }

                    if (data?.user) {
                        if (data.user.email_confirmed_at) {
                            // User is immediately confirmed - set roles and continue
                            await handleSuccessfulAuthWithRoles(data.user, fullName, selectedRoles);
                        } else {
                            // Email confirmation required
                            document.getElementById('verification-message').style.display = 'block';
                            showToast('Please check your email for verification link.', 'info');
                        }
                    }
                }
            } catch (e) {
                console.error('Authentication error', e);
                showToast('Authentication failed. Please try again.', 'error');
            }
        }

        async function handleSuccessfulAuthWithRoles(supabaseUser, displayName = null, roles = []) {
            // Create or update user profile in our users table
            const userData = {
                id: supabaseUser.id,
                email: supabaseUser.email,
                full_name: displayName || supabaseUser.user_metadata?.full_name || supabaseUser.email,
                photo_url: supabaseUser.user_metadata?.avatar_url || '',
                roles: roles,
                primary_role: roles[0] || null,
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };

            // Upsert user profile
            const { error: profileError } = await supabaseClient
                .from('user_profiles')
                .upsert(userData, { onConflict: 'id' });

            if (profileError) {
                console.error('Error creating user profile', profileError);
            }

            // Set AppState user
            AppState.user = {
                id: supabaseUser.id,
                name: userData.full_name,
                email: supabaseUser.email,
                photoUrl: userData.photo_url,
                roles: roles,
                role: roles[0] || null,
                helperVerified: false
            };
            AppState.loginMethod = 'supabase';
            AppState.selectedRoles = new Set(roles);
            
            updateNavbar();
            
            // Skip role selection and go directly to helper setup or browse
            if (roles.includes('helper')) {
                goToScreen('helper-setup');
            } else {
                renderDashboard();
                goToScreen('browse');
            }
            
            showToast(`Welcome, ${userData.full_name}!`, 'success');
        }

        async function handleSuccessfulAuth(supabaseUser, displayName = null) {
            // Create or update user profile in our users table
            const userData = {
                id: supabaseUser.id,
                email: supabaseUser.email,
                full_name: displayName || supabaseUser.user_metadata?.full_name || supabaseUser.email,
                photo_url: supabaseUser.user_metadata?.avatar_url || '',
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };

            // Upsert user profile
            const { error: profileError } = await supabaseClient
                .from('user_profiles')
                .upsert(userData, { onConflict: 'id' });

            if (profileError) {
                console.error('Error creating user profile', profileError);
            }

            // Set AppState user
            AppState.user = {
                id: supabaseUser.id,
                name: userData.full_name,
                email: supabaseUser.email,
                photoUrl: userData.photo_url,
                roles: [],
                role: null,
                helperVerified: false
            };
            AppState.loginMethod = 'supabase';

                updateNavbar();
                goToScreen('role');
            showToast(`Welcome, ${userData.full_name}!`, 'success');
        }

        let isSignInMode = false;

        function toggleAuthMode() {
            isSignInMode = !isSignInMode;
            const fullNameGroup = document.getElementById('full-name-group');
            const submitBtn = document.getElementById('auth-submit-btn');
            const toggleBtn = document.getElementById('auth-mode-toggle');
            const fullNameInput = document.getElementById('full-name');
            const roleSelection = document.querySelector('.role-selection-compact');
            const formRow = document.querySelector('.form-row');
            
            if (isSignInMode) {
                // Sign-in mode: hide name field and role selection
                if (fullNameGroup) fullNameGroup.style.display = 'none';
                if (fullNameInput) fullNameInput.required = false;
                if (roleSelection) roleSelection.style.display = 'none';
                if (formRow) formRow.style.gridTemplateColumns = '1fr';
                
                submitBtn.textContent = 'Sign In';
                toggleBtn.textContent = "Don't have an account? Sign up";
            } else {
                // Sign-up mode: show name field and role selection
                if (fullNameGroup) fullNameGroup.style.display = 'block';
                if (fullNameInput) fullNameInput.required = true;
                if (roleSelection) roleSelection.style.display = 'flex';
                if (formRow) formRow.style.gridTemplateColumns = '1fr 1fr';
                
                submitBtn.textContent = 'Get Started';
                toggleBtn.textContent = 'Already have an account? Sign in';
            }
        }

        function skipLoginForTesting() {
            AppState.user = {
                name: 'Demo Tester',
                email: 'demo+tester@example.com',
                photoUrl: '',
                roles: ['customer', 'vendor', 'helper'],
                role: 'customer',
                helperVerified: true
            };
            AppState.loginMethod = 'test';
            AppState.selectedRoles = new Set(AppState.user.roles);
            persistUser();
            updateNavbar();
            renderDashboard();
            goToScreen('browse');
            showToast('Signed in as demo tester.', 'info');
        }

        /**
         * Authentication (Google via Supabase)
         */
        function initializeGoogleSignIn() {
            // No-op for Supabase; button is rendered on demand.
        }

        function renderGoogleSignInButton() {
            const container = document.getElementById('google-signin-button');
            if (!container) return;
            container.innerHTML = `
                <button class="btn btn-primary" style="width:260px;" onclick="handleSupabaseGoogleSignIn()">
                    Continue with Google
                </button>
            `;
        }

        async function handleSupabaseGoogleSignIn() {
            if (!supabaseClient) {
                showToast('Google Sign-In is not configured.', 'error');
                return;
            }
            try {
                const redirectTo = window.location.href;
                const { error } = await supabaseClient.auth.signInWithOAuth({
                    provider: 'google',
                    options: { redirectTo }
                });
                if (error) {
                    console.error('Supabase Google sign-in error', error);
                    showToast('Failed to start Google Sign-In.', 'error');
                }
                // On success, Supabase redirects; when user comes back,
                // initApp() will pick up the session via refreshAuthFromSupabase.
            } catch (e) {
                console.error('Supabase Google sign-in error', e);
                showToast('Failed to start Google Sign-In.', 'error');
            }
        }

        /**
         * Role Selection
         */
        function refreshRoleCards() {
            const cards = document.querySelectorAll('.role-card');
            cards.forEach(card => {
                const role = card.dataset.role;
                if (AppState.selectedRoles.has(role)) {
                    card.classList.add('active');
                } else {
                    card.classList.remove('active');
                }
            });
            const continueBtn = document.getElementById('role-continue-btn');
            if (continueBtn) continueBtn.disabled = AppState.selectedRoles.size === 0;
        }

        function toggleRole(role) {
            if (AppState.selectedRoles.has(role)) {
                AppState.selectedRoles.delete(role);
            } else {
                AppState.selectedRoles.add(role);
            }
            refreshRoleCards();
        }

        async function continueAfterRole() {
            if (!AppState.user || AppState.selectedRoles.size === 0) return;
            AppState.user.roles = Array.from(AppState.selectedRoles);
            AppState.user.role = AppState.user.roles[0] || null; // legacy support
            await persistUser();
            updateNavbar();

            if (AppState.user.roles.includes('helper') && !AppState.user.helperVerified) {
                AppState.helperStepIndex = 0;
                goToScreen('helper');
                return;
            }
            goToScreen('browse');
        }

        function advanceAfterAuthentication() {
            if (!AppState.user) {
                goToScreen('auth');
                return;
            }
            const roles = AppState.user.roles || [];
            if (!roles.length) {
                goToScreen('role');
                return;
            }
            goToScreen('browse');
        }

        /**
         * Helper Verification Flow
         */
        const helperStepTitles = [
            'Your Legal Name',
            'Profile Photo',
            'Home Address',
            'SMS Verification',
            'Review & Submit'
        ];

        function renderHelperStep() {
            updateHelperProgress();
            const container = document.getElementById('helper-step-container');
            const step = AppState.helperStepIndex;
            const data = AppState.helperData;

            switch (step) {
                case 0:
                    container.innerHTML = `
                        <h3>${helperStepTitles[0]}</h3>
                        <p class="screen-subtitle">This name appears on your helper badge.</p>
                        <form onsubmit="saveHelperName(event)">
                            <div class="form-group">
                                <label class="form-label">First Name</label>
                                <input class="form-input" id="helper-first" value="${data.firstName}" required />
                            </div>
                            <div class="form-group">
                                <label class="form-label">Last Name</label>
                                <input class="form-input" id="helper-last" value="${data.lastName}" required />
                            </div>
                            <button class="primary-cta" style="width:100%;">Continue</button>
                        </form>
                    `;
                    break;
                case 1:
                    container.innerHTML = `
                        <h3>${helperStepTitles[1]}</h3>
                        <p class="screen-subtitle">Upload a clear photo so customers recognize you.</p>
                        <div class="form-group">
                            <label class="form-label">Profile Photo</label>
                            <input type="file" accept="image/*" class="form-input" onchange="handlePhotoUpload(event)" />
                        </div>
                        ${data.photoDataUrl ? `<img src="${data.photoDataUrl}" alt="Preview" style="max-width:180px;border-radius:12px;margin-bottom:1rem;" />` : ''}
                        <button class="primary-cta" style="width:100%;" onclick="goToNextHelperStep()" ${data.photoDataUrl || AppState.loginMethod === 'test' ? '' : 'disabled'}>Continue</button>
                    `;
                    break;
                case 2:
                    container.innerHTML = `
                        <h3>${helperStepTitles[2]}</h3>
                        <p class="screen-subtitle">We use this to match you with local tasks.</p>
                        <form onsubmit="saveHelperAddress(event)">
                            <div class="form-group">
                                <label class="form-label">Street</label>
                                <input class="form-input" id="helper-street" value="${data.street}" required />
                            </div>
                            <div class="form-group">
                                <label class="form-label">City</label>
                                <input class="form-input" id="helper-city" value="${data.city}" required />
                            </div>
                            <div class="form-group">
                                <label class="form-label">Province</label>
                                <input class="form-input" id="helper-province" value="${data.province}" required />
                            </div>
                            <div class="form-group">
                                <label class="form-label">Postal Code</label>
                                <input class="form-input" id="helper-postal" value="${data.postal}" required />
                            </div>
                            <button class="primary-cta" style="width:100%;">Continue</button>
                        </form>
                    `;
                    break;
                case 3:
                    container.innerHTML = `
                        <h3>${helperStepTitles[3]}</h3>
                        <p class="screen-subtitle">Secure your account with a quick SMS check.</p>
                        <div class="form-group">
                            <label class="form-label">Phone Number</label>
                            <input class="form-input" id="helper-phone" value="${data.phone}" placeholder="+1 416-555-1234" />
                        </div>
                        <button class="primary-cta" style="width:100%; margin-bottom:1rem;" onclick="sendVerificationCode()">Send Code</button>
                        <div id="sms-status" class="screen-subtitle" style="display:${data.generatedCode ? 'block' : 'none'}; margin-bottom:1rem;">
                            ${data.generatedCode ? 'We sent a 6-digit code. Enter it below.' : ''}
                        </div>
                        <div class="form-group">
                            <label class="form-label">Enter Code</label>
                            <input class="form-input" id="sms-code-input" value="${data.enteredCode}" maxlength="6" />
                        </div>
                        <button class="primary-cta" style="width:100%;" onclick="verifySmsCode()" ${data.generatedCode ? '' : 'disabled'}>
                            Verify Code
                        </button>
                    `;
                    break;
                case 4:
                    container.innerHTML = `
                        <h3>${helperStepTitles[4]}</h3>
                        <p class="screen-subtitle">Review your details before going live.</p>
                        <div class="view-content" style="padding:1.5rem; background:#f8fafc;">
                            <p><strong>Name:</strong> ${data.firstName} ${data.lastName}</p>
                            <p><strong>Address:</strong> ${data.street}, ${data.city}, ${data.province} ${data.postal}</p>
                            <p><strong>Phone:</strong> ${data.phone} ${data.smsVerified ? '(Verified)' : '(Pending)'}</p>
                        </div>
                        ${!data.smsVerified ? `<p class="screen-subtitle" style="margin-top:1rem; color:#dc2626;">Complete SMS verification to enable this button.</p>` : ''}
                        <button type="button" class="primary-cta" style="width:100%; margin-top:1.5rem;" onclick="completeHelperVerification()" ${data.smsVerified ? '' : 'disabled'}>
                            Complete Verification
                        </button>
                    `;
                    break;
                default:
                    container.innerHTML = '';
            }
        }

        function updateHelperProgress() {
            const progressContainer = document.getElementById('helper-progress');
            progressContainer.innerHTML = helperStepTitles.map((_, idx) => `
                <div class="progress-dot ${idx <= AppState.helperStepIndex ? 'active' : ''}"></div>
            `).join('');
        }

        function saveHelperName(event) {
            event.preventDefault();
            AppState.helperData.firstName = document.getElementById('helper-first').value.trim();
            AppState.helperData.lastName = document.getElementById('helper-last').value.trim();
            persistHelperData();
            goToNextHelperStep();
        }

        function handlePhotoUpload(event) {
            if (!event || !event.target || !event.target.files || !event.target.files[0]) {
                return;
            }
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = () => {
                AppState.helperData.photoDataUrl = reader.result;
                persistHelperData();
                renderHelperStep();
            };
            reader.readAsDataURL(file);
        }

        function saveHelperAddress(event) {
            event.preventDefault();
            AppState.helperData.street = document.getElementById('helper-street').value.trim();
            AppState.helperData.city = document.getElementById('helper-city').value.trim();
            AppState.helperData.province = document.getElementById('helper-province').value.trim();
            AppState.helperData.postal = document.getElementById('helper-postal').value.trim();
            persistHelperData();
            goToNextHelperStep();
        }

        function sendVerificationCode() {
            const phoneInput = document.getElementById('helper-phone').value.trim();
            if (!phoneInput) {
                showToast('Enter a phone number first.', 'warning');
                return;
            }
            const code = Math.floor(100000 + Math.random() * 900000).toString();
            AppState.helperData.phone = phoneInput;
            AppState.helperData.generatedCode = code;
            AppState.helperData.smsVerified = false;
            persistHelperData();
            renderHelperStep();
            showToast(`Simulated SMS code: ${code}`, 'info');
        }

        function verifySmsCode() {
            const entered = document.getElementById('sms-code-input').value.trim();
            AppState.helperData.enteredCode = entered;
            if (entered === AppState.helperData.generatedCode) {
                AppState.helperData.smsVerified = true;
                showToast('Phone verified!', 'success');
                goToNextHelperStep();
            } else {
                showToast('Incorrect code, please try again.', 'warning');
            }
            persistHelperData();
        }

        function goToNextHelperStep() {
            AppState.helperStepIndex = Math.min(helperStepTitles.length - 1, AppState.helperStepIndex + 1);
            renderHelperStep();
        }

        function completeHelperVerification() {
            if (!AppState.helperData.smsVerified) {
                const manualInput = document.getElementById('sms-code-input');
                const entered = manualInput ? manualInput.value.trim() : AppState.helperData.enteredCode;
                if (entered && entered === AppState.helperData.generatedCode) {
                    AppState.helperData.smsVerified = true;
                    AppState.helperData.enteredCode = entered;
                    persistHelperData();
                } else {
                    showToast('Please enter the SMS code and click "Verify Code" before completing verification.', 'warning');
                    return;
                }
            }
            AppState.user.helperVerified = true;
            if (AppState.helperData.photoDataUrl) {
                AppState.user.photoUrl = AppState.helperData.photoDataUrl;
            }
            persistUser();
            showToast('Helper profile verified! Welcome to the team.', 'success');
            updateNavbar();
            renderDashboard();
            determineInitialScreen();
            showScreen(AppState.currentScreen);
        }

        /**
         * Modal & Utility Helpers
         */
        function initializeModalRoot() {
            const overlay = document.getElementById('modal-root');
            if (!overlay) return;
            overlay.addEventListener('click', event => {
                if (event.target === overlay) {
                    closeModal();
                }
            });
        }

        function closeModal() {
            const overlay = document.getElementById('modal-root');
            const panel = document.getElementById('modal-panel');
            if (panel) {
                panel.innerHTML = '';
            }
            if (overlay) {
                overlay.classList.remove('active');
            }
        }

        function showModal(content) {
            const overlay = document.getElementById('modal-root');
            const panel = document.getElementById('modal-panel');
            if (!overlay || !panel) return;
            panel.innerHTML = `
                <button class="modal-close" onclick="closeModal()">&times;</button>
                ${content}
            `;
            overlay.classList.add('active');
        }

        function showToast(message, variant = 'success') {
            const root = document.getElementById('toast-root');
            if (!root) return;
            const toast = document.createElement('div');
            toast.className = `toast ${variant}`;
            toast.textContent = message;
            root.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(-10px)';
                setTimeout(() => toast.remove(), 250);
            }, 3200);
        }

        function triggerSuccessPulse() {
            const pulse = document.getElementById('success-pulse');
            if (!pulse) return;
            pulse.classList.remove('show');
            void pulse.offsetWidth;
            pulse.classList.add('show');
            setTimeout(() => pulse.classList.remove('show'), 600);
        }

        function setLoading(isLoading) {
            const overlay = document.getElementById('loading-overlay');
            if (!overlay) return;
            overlay.style.display = isLoading ? 'flex' : 'none';
        }

        function enhanceDateTimeInputs() {
            const input = document.getElementById('errand-time');
            if (!input) return;
            if (!input.placeholder) {
                input.placeholder = 'Select a date and time';
            }
            const openPicker = () => {
                if (typeof input.showPicker === 'function') {
                    input.showPicker();
                }
            };
            input.addEventListener('focus', openPicker);
            input.addEventListener('click', openPicker);
        }

        function formatCurrency(value = 0) {
            const safeValue = Number.isFinite(value) ? value : 0;
            return new Intl.NumberFormat('en-CA', { style: 'currency', currency: 'CAD' }).format(safeValue);
        }

        function formatDate(dateString) {
            if (!dateString) return 'TBD';
            const date = new Date(dateString);
            if (Number.isNaN(date.getTime())) return dateString;
            return date.toLocaleDateString('en-CA', { month: 'short', day: 'numeric' });
        }

        function formatDateTime(dateString) {
            if (!dateString) return 'TBD';
            const date = new Date(dateString);
            if (Number.isNaN(date.getTime())) return dateString;
            return date.toLocaleString('en-CA', {
                month: 'short',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit'
            });
        }

        function calculateProgress(product) {
            if (!product || !product.targetQuantity) return 0;
            return Math.min(100, Math.round((product.currentQuantity / product.targetQuantity) * 100));
        }

        function renderProgressBar(product) {
            const progress = calculateProgress(product);
            return `
                <div class="progress-bar">
                    <div class="progress-fill" style="width:${progress}%"></div>
                </div>
                <small style="display:block; margin-top:0.35rem; color:#475569;">
                    ${product.currentQuantity}/${product.targetQuantity} committed • ${progress}% funded
                </small>
            `;
        }

        function computeGroupStatus(product) {
            if (!product) return 'open';
            const now = new Date();
            const deadline = new Date(product.deadline);
            const hasMetTarget = product.currentQuantity >= product.targetQuantity;
            if (now > deadline) {
                return hasMetTarget ? 'succeeded' : 'failed';
            }
            if (hasMetTarget) return 'closed';
            return 'open';
        }

        function refreshOrderStatuses() {
            AppState.orders = AppState.orders.map(order => {
                if (order.cancelled) {
                    return { ...order, groupStatus: 'cancelled' };
                }
                const product = findProductById(order.productId);
                return { ...order, groupStatus: computeGroupStatus(product) };
            });
        }

        function renderStatusBadge(status) {
            if (!status) return '';
            const label = status.replace(/_/g, ' ').toUpperCase();
            return `<span class="status-badge status-${status.toLowerCase()}">${label}</span>`;
        }

        function getOrCreateFormMessage(form) {
            if (!form) return null;
            let node = form.querySelector('.form-error');
            if (!node) {
                node = document.createElement('p');
                node.className = 'form-error';
                form.appendChild(node);
            }
            return node;
        }

        function showFormMessage(form, message = '', type = 'error') {
            const node = getOrCreateFormMessage(form);
            if (!node) return;
            node.textContent = message;
            node.style.color = type === 'error' ? '#dc2626' : '#047857';
            node.style.display = message ? 'block' : 'none';
        }

        function generateProductGraphic(title = '', color = '#e2e8f0') {
            const safeTitle = (title || 'Group Buy').substring(0, 24);
            const svg = `
                <svg xmlns="http://www.w3.org/2000/svg" width="400" height="220">
                    <defs>
                        <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:${color};stop-opacity:0.9" />
                            <stop offset="100%" style="stop-color:#ffffff;stop-opacity:0.3" />
                        </linearGradient>
                    </defs>
                    <rect width="400" height="220" rx="24" fill="url(#grad)" />
                    <text x="24" y="120" font-size="32" font-family="Segoe UI, sans-serif" fill="#0f172a" font-weight="600">
                        ${safeTitle}
                    </text>
                </svg>
            `;
            return `data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(svg)))}`;
        }

        function renderProductCover(product) {
            if (product.imageDataUrl) {
                return `<img src="${product.imageDataUrl}" alt="${product.title}" class="card-cover" />`;
            }
            return `<div class="card-cover" style="background:${product.imageColor || '#e2e8f0'};"></div>`;
        }

        function handleCardKey(event, type, id) {
            if (event.key !== 'Enter' && event.key !== ' ') return;
            event.preventDefault();
            if (type === 'product') {
                openProductDetail(id);
            } else if (type === 'errand') {
                openErrandDetail(id);
            }
        }

        /**
         * Group Buy Marketplace
         */
        function renderMarketplaceHighlights() {
            const featuredGroupContainer = document.getElementById('featured-groupbuys');
            if (featuredGroupContainer) {
                const featured = [...AppState.products]
                    .sort((a, b) => new Date(a.deadline) - new Date(b.deadline))
                    .slice(0, 3);
                featuredGroupContainer.innerHTML = featured.length
                    ? featured.map(product => {
                        const progress = calculateProgress(product);
                        return `
                            <div class="card" role="button" tabindex="0"
                                onclick="openProductDetail(${product.id})"
                                onkeypress="handleCardKey(event, 'product', ${product.id})"
                                aria-label="View ${product.title} - ${formatCurrency(product.price)} - ${progress}% funded">
                                <h4>${product.title}</h4>
                                <p style="color:#475569;">${product.description}</p>
                                <div class="card-meta">
                                    <span class="pill info">${product.region}</span>
                                    <span>${formatCurrency(product.price)}</span>
                                    <span>Deadline • ${formatDate(product.deadline)}</span>
                                </div>
                                ${renderProgressBar(product)}
                            </div>
                        `;
                    }).join('')
                    : '<p class="screen-subtitle">No featured group buys yet. Vendors can add products from the dashboard.</p>';
            }

            const featuredErrandContainer = document.getElementById('featured-errands');
            if (featuredErrandContainer) {
                const openErrands = AppState.errands.filter(errand => errand.status === 'open').slice(0, 3);
                featuredErrandContainer.innerHTML = openErrands.length
                    ? openErrands.map(errand => `
                        <div class="card" role="button" tabindex="0"
                            onclick="openErrandDetail(${errand.id})"
                            onkeypress="handleCardKey(event, 'errand', ${errand.id})"
                            aria-label="View ${errand.title} - ${errand.region} - ${formatCurrency(errand.budgetMin)} to ${formatCurrency(errand.budgetMax)}">
                            <h4>${errand.title}</h4>
                            <p style="color:#475569;">${errand.description}</p>
                            <div class="card-meta">
                                <span class="pill info">${errand.region}</span>
                                <span>${formatCurrency(errand.budgetMin)} - ${formatCurrency(errand.budgetMax)}</span>
                                <span>${formatDateTime(errand.preferredTime)}</span>
                            </div>
                        </div>
                    `).join('')
                    : '<p class="screen-subtitle">No errands available - post one to get help fast.</p>';
            }
        }

        function renderGroupBuyList() {
            const container = document.getElementById('groupbuy-list');
            if (!container) return;
            refreshOrderStatuses();

            // Update form values to match current filters
            const searchInput = document.getElementById('groupbuy-search');
            if (searchInput && searchInput.value !== AppState.filters.groupbuys.search) {
                searchInput.value = AppState.filters.groupbuys.search;
            }
            
            const categorySelect = document.getElementById('groupbuy-category');
            if (categorySelect) categorySelect.value = AppState.filters.groupbuys.category;
            
            const priceSelect = document.getElementById('groupbuy-price');
            if (priceSelect) priceSelect.value = AppState.filters.groupbuys.priceRange;
            
            const regionSelect = document.getElementById('groupbuy-region');
            if (regionSelect) regionSelect.value = AppState.filters.groupbuys.region;
            
            const statusSelect = document.getElementById('groupbuy-status');
            if (statusSelect) statusSelect.value = AppState.filters.groupbuys.status;
            
            const sortSelect = document.getElementById('groupbuy-sort');
            if (sortSelect) sortSelect.value = AppState.filters.groupbuys.sort;

            // Get filtered products
            let products = getFilteredProducts();
            
            // Apply sorting
            const { sort } = AppState.filters.groupbuys;
            const sorters = {
                popularity: (a, b) => {
                    const aOrders = AppState.orders.filter(o => o.productId === a.id).length;
                    const bOrders = AppState.orders.filter(o => o.productId === b.id).length;
                    return bOrders - aOrders;
                },
                deadline: (a, b) => new Date(a.deadline) - new Date(b.deadline),
                priceLow: (a, b) => a.price - b.price,
                priceHigh: (a, b) => b.price - a.price,
                progress: (a, b) => calculateProgress(b) - calculateProgress(a),
                newest: (a, b) => new Date(b.createdAt) - new Date(a.createdAt)
            };
            products.sort(sorters[sort] || sorters.popularity);

            // Add popularity indicators and trending badges
            const enhancedProducts = products.map(product => {
                const orderCount = AppState.orders.filter(o => o.productId === product.id).length;
                const progress = calculateProgress(product);
                const daysLeft = Math.ceil((new Date(product.deadline) - new Date()) / (1000 * 60 * 60 * 24));
                
                return {
                    ...product,
                    orderCount,
                    progress,
                    daysLeft,
                    isPopular: orderCount >= 5,
                    isTrending: orderCount >= 3 && daysLeft <= 7,
                    isClosingSoon: daysLeft <= 3 && daysLeft > 0
                };
            });

            container.innerHTML = enhancedProducts.length
                ? enhancedProducts.map(renderEnhancedGroupBuyCard).join('')
                : '<p class="screen-subtitle">No group buys match your filters. Try adjusting your search criteria.</p>';
                
            updateResultsCount('groupbuy');
        }

        function renderEnhancedGroupBuyCard(product) {
            const status = computeGroupStatus(product);
            const progress = calculateProgress(product);
            const category = ProductCategories[product.category] || ProductCategories.other;
            
            let badges = '';
            if (product.isTrending) badges += '<span class="trending-badge">🔥 Trending</span>';
            if (product.isClosingSoon) badges += '<span class="trending-badge">⏰ Closing Soon</span>';
            
            let popularityIndicator = '';
            if (product.orderCount > 0) {
                popularityIndicator = `<div class="popularity-indicator">👥 ${product.orderCount} joined</div>`;
            }

            return `
                <div class="product-card" onclick="openProductDetail(${product.id})">
                    <div class="product-image" style="background: ${product.imageColor || '#3b82f6'};">
                        ${product.imageDataUrl ? `<img src="${product.imageDataUrl}" alt="${product.title}">` : ''}
                        <div class="category-icon">${category.icon}</div>
                    </div>
                    <div class="product-info">
                        <div class="product-header">
                            <h4 class="product-title">${product.title}</h4>
                            ${badges}
                        </div>
                        <p class="product-description">${product.description}</p>
                        <div class="product-meta">
                            <span class="product-region">${product.region}</span>
                            <span class="product-price">$${product.price}</span>
                            <span class="product-deadline">Deadline • ${formatDate(product.deadline)}</span>
                        </div>
                        <div class="product-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progress}%"></div>
                            </div>
                            <span class="progress-text">${product.currentQuantity}/${product.targetQuantity} committed • ${Math.round(progress)}% funded</span>
                        </div>
                        ${popularityIndicator}
                    </div>
                </div>
            `;
        }

        function renderGroupBuyCard(product) {
            const status = computeGroupStatus(product);
            const progress = calculateProgress(product);
            return `
                <div class="card" role="button" tabindex="0"
                    onclick="openProductDetail(${product.id})"
                    onkeypress="handleCardKey(event, 'product', ${product.id})"
                    aria-label="View details for ${product.title} - ${formatCurrency(product.price)} - ${progress}% funded">
                    ${renderProductCover(product)}
                    <h4>${product.title}</h4>
                    <p style="color:#475569;">${product.description}</p>
                    <div class="card-meta">
                        <span class="pill info">${product.region}</span>
                        <span>${formatCurrency(product.price)}</span>
                        <span>Delivery • ${formatDate(product.deliveryDate)}</span>
                        ${renderStatusBadge(status)}
                    </div>
                    ${renderProgressBar(product)}
                </div>
            `;
        }

        function handleGroupBuySearch(event) {
            AppState.filters.groupbuys.search = event.target.value;
            renderGroupBuyList();
            updateResultsCount('groupbuy');
        }

        function handleGroupBuyRegion(event) {
            AppState.filters.groupbuys.region = event.target.value;
            renderGroupBuyList();
            updateResultsCount('groupbuy');
        }

        function handleGroupBuyVendor(event) {
            AppState.filters.groupbuys.vendor = event.target.value;
            renderGroupBuyList();
            updateResultsCount('groupbuy');
        }

        function handleGroupBuySort(event) {
            AppState.filters.groupbuys.sort = event.target.value;
            renderGroupBuyList();
        }

        function handleGroupBuyCategory(event) {
            AppState.filters.groupbuys.category = event.target.value;
            renderGroupBuyList();
            updateResultsCount('groupbuy');
            updateQuickFilters('groupbuy', event.target.value);
        }

        function handleGroupBuyPrice(event) {
            AppState.filters.groupbuys.priceRange = event.target.value;
            renderGroupBuyList();
            updateResultsCount('groupbuy');
        }

        function handleGroupBuyStatus(event) {
            AppState.filters.groupbuys.status = event.target.value;
            renderGroupBuyList();
            updateResultsCount('groupbuy');
        }

        function handleCategoryFilter(category) {
            AppState.filters.groupbuys.category = category;
            const categorySelect = document.getElementById('groupbuy-category');
            if (categorySelect) categorySelect.value = category;
            renderGroupBuyList();
            updateResultsCount('groupbuy');
            updateQuickFilters('groupbuy', category);
        }

        function handleErrandSearch(event) {
            AppState.filters.errands.search = event.target.value;
            renderErrandList();
            updateResultsCount('errand');
        }

        function handleErrandCategory(event) {
            AppState.filters.errands.category = event.target.value;
            renderErrandList();
            updateResultsCount('errand');
            updateQuickFilters('errand', event.target.value);
        }

        function handleErrandPrice(event) {
            AppState.filters.errands.priceRange = event.target.value;
            renderErrandList();
            updateResultsCount('errand');
        }

        function handleErrandCategoryFilter(category) {
            AppState.filters.errands.category = category;
            const categorySelect = document.getElementById('errand-category');
            if (categorySelect) categorySelect.value = category;
            renderErrandList();
            updateResultsCount('errand');
            updateQuickFilters('errand', category);
        }

        function updateQuickFilters(type, activeCategory) {
            const container = document.querySelector(`#screen-${type === 'groupbuy' ? 'groupbuys' : 'errands'} .quick-filters`);
            if (!container) return;
            
            const filters = container.querySelectorAll('.quick-filter');
            filters.forEach(filter => {
                filter.classList.remove('active');
                const filterCategory = filter.onclick.toString().match(/'([^']+)'/)?.[1];
                if (filterCategory === activeCategory) {
                    filter.classList.add('active');
                }
            });
        }

        function updateResultsCount(type) {
            const countElement = document.getElementById(`${type}-results-count`);
            if (!countElement) return;
            
            let items, filteredItems;
            
            if (type === 'groupbuy') {
                items = AppState.products;
                filteredItems = getFilteredProducts();
            } else {
                items = AppState.errands;
                filteredItems = getFilteredErrands();
            }
            
            const total = items.length;
            const filtered = filteredItems.length;
            
            if (filtered === total) {
                countElement.textContent = `${total} ${type === 'groupbuy' ? 'products' : 'errands'} available`;
            } else {
                countElement.textContent = `${filtered} of ${total} ${type === 'groupbuy' ? 'products' : 'errands'} shown`;
            }
        }

        function getFilteredProducts() {
            let products = [...AppState.products];
            const filters = AppState.filters.groupbuys;
            
            // Search filter
            if (filters.search) {
                const searchTerm = filters.search.toLowerCase();
                products = products.filter(p => 
                    p.title.toLowerCase().includes(searchTerm) ||
                    p.description.toLowerCase().includes(searchTerm) ||
                    p.vendor.toLowerCase().includes(searchTerm)
                );
            }
            
            // Category filter
            if (filters.category && filters.category !== 'all') {
                products = products.filter(p => p.category === filters.category);
            }
            
            // Price range filter
            if (filters.priceRange && filters.priceRange !== 'all') {
                const range = PriceRanges[filters.priceRange];
                if (range) {
                    products = products.filter(p => p.price >= range.min && p.price <= range.max);
                }
            }
            
            // Region filter
            if (filters.region && filters.region !== 'All') {
                products = products.filter(p => p.region === filters.region);
            }
            
            // Status filter
            if (filters.status && filters.status !== 'all') {
                products = products.filter(p => {
                    const status = computeGroupStatus(p);
                    switch (filters.status) {
                        case 'open': return status === 'open';
                        case 'closing-soon': 
                            const daysLeft = Math.ceil((new Date(p.deadline) - new Date()) / (1000 * 60 * 60 * 24));
                            return status === 'open' && daysLeft <= 3;
                        case 'almost-full':
                            return status === 'open' && (p.currentQuantity / p.targetQuantity) >= 0.8;
                        case 'new':
                            const daysSinceCreated = Math.ceil((new Date() - new Date(p.createdAt)) / (1000 * 60 * 60 * 24));
                            return daysSinceCreated <= 7;
                        default: return true;
                    }
                });
            }
            
            return products;
        }

        function getFilteredErrands() {
            let errands = [...AppState.errands];
            const filters = AppState.filters.errands;
            
            // Search filter
            if (filters.search) {
                const searchTerm = filters.search.toLowerCase();
                errands = errands.filter(e => 
                    e.title.toLowerCase().includes(searchTerm) ||
                    e.description.toLowerCase().includes(searchTerm) ||
                    e.region.toLowerCase().includes(searchTerm)
                );
            }
            
            // Category filter
            if (filters.category && filters.category !== 'all') {
                errands = errands.filter(e => e.category === filters.category);
            }
            
            // Price range filter
            if (filters.priceRange && filters.priceRange !== 'all') {
                const range = PriceRanges[filters.priceRange];
                if (range) {
                    errands = errands.filter(e => {
                        const budget = e.budget || e.budgetMax || 0;
                        return budget >= range.min && budget <= range.max;
                    });
                }
            }
            
            // Region filter
            if (filters.region && filters.region !== 'All') {
                errands = errands.filter(e => e.region === filters.region);
            }
            
            // Status filter
            if (filters.status && filters.status !== 'all') {
                errands = errands.filter(e => e.status === filters.status);
            }
            
            return errands;
        }

        function findProductById(productId) {
            return AppState.products.find(product => product.id === Number(productId));
        }

        function openProductDetail(productId) {
            const product = findProductById(productId);
            if (!product) return;
            const ordersForProduct = AppState.orders.filter(order => order.productId === product.id);
            const status = computeGroupStatus(product);
            const isVendor = AppState.user && product.ownerEmail === AppState.user.email;
            const productMessages = AppState.messages.filter(msg => msg.productId === product.id).slice(0, 5);
            const messagesHtml = productMessages.length
                ? `
                    <div class="stacked-list" style="margin-top:1rem;">
                        ${productMessages.map(msg => `
                            <div class="list-card">
                                <div>
                                    <strong>${msg.senderName || msg.senderEmail}</strong>
                                    <p style="font-size:0.85rem; color:#64748b;">${formatDateTime(msg.createdAt)}</p>
                                    <p>${msg.body}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `
                : '<p class="screen-subtitle" style="margin-top:0.75rem;">No messages yet. Start a conversation to coordinate details.</p>';
            const content = `
                <h3 class="modal-title">${product.title}</h3>
                <p class="modal-subtitle">${product.description}</p>
                ${renderProductCover(product)}
                <div class="card-meta" style="margin-bottom:1rem;">
                    <span class="pill info">${product.region}</span>
                    <span>${formatCurrency(product.price)}</span>
                    <span>Vendor • ${product.vendor}</span>
                    ${renderStatusBadge(status)}
                </div>
                ${renderProgressBar(product)}
                <ul style="margin-top:1rem; color:#475569; padding-left:1rem;">
                    <li>Deadline: ${formatDate(product.deadline)}</li>
                    <li>Delivery: ${formatDate(product.deliveryDate)}</li>
                    <li>Orders: ${ordersForProduct.length}</li>
                </ul>
                <div class="modal-footer">
                    <button class="btn btn-ghost" onclick="closeModal()">Close</button>
                    ${AppState.user ? `<button class="btn btn-secondary" onclick="openProductMessagesModal(${product.id})">Messages</button>` : ''}
                    <button class="btn btn-primary" onclick="openJoinGroupBuyModal(${product.id})">Join group buy</button>
                </div>
                <div style="margin-top:1.5rem;">
                    <h4>Recent messages</h4>
                    ${messagesHtml}
                </div>
            `;
            showModal(content);
        }

        function openJoinGroupBuyModal(productId) {
            const product = findProductById(productId);
            if (!product) return;
            const status = computeGroupStatus(product);
            if (status !== 'open') {
                showToast('This group buy is no longer accepting orders.', 'warning');
                return;
            }
            if (!AppState.user) {
                showToast('Please log in first so we can attach the order to your account.', 'warning');
                goToScreen('auth');
                return;
            }
            const fieldId = `join-quantity-${product.id}`;
            const noteId = `join-note-${product.id}`;
            const content = `
                <h3 class="modal-title">Join ${product.title}</h3>
                <p class="modal-subtitle">Secure your spot in this community group buy.</p>
                <form onsubmit="submitJoinGroupBuy(event, ${product.id}, '${fieldId}', '${noteId}')">
                    <div class="form-group">
                        <label class="form-label" for="${fieldId}">Quantity</label>
                        <input id="${fieldId}" class="form-input" type="number" min="1" value="1" required />
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="${noteId}">Notes (optional)</label>
                        <textarea id="${noteId}" class="form-textarea" rows="3" placeholder="Pickup preferences, allergies, etc."></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-ghost" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Confirm join</button>
                    </div>
                </form>
            `;
            showModal(content);
        }

        function openProductMessagesModal(productId) {
            const product = findProductById(productId);
            if (!product) return;
            if (!AppState.user) {
                showToast('Please log in to send messages.', 'warning');
                goToScreen('auth');
                return;
            }
            const thread = AppState.messages.filter(msg => msg.productId === product.id);
            const threadHtml = thread.length
                ? `
                    <div class="stacked-list" style="margin-top:1rem;">
                        ${thread.map(msg => `
                            <div class="list-card">
                                <div>
                                    <strong>${msg.senderName || msg.senderEmail}</strong>
                                    <p style="font-size:0.85rem; color:#64748b;">${formatDateTime(msg.createdAt)}</p>
                                    <p>${msg.body}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `
                : '<p class="screen-subtitle" style="margin-top:0.75rem;">No messages yet. Be the first to reach out.</p>';
            const textareaId = `product-message-${product.id}`;
            const content = `
                <h3 class="modal-title">Messages for ${product.title}</h3>
                <p class="modal-subtitle">Use this space to coordinate pickup times, questions, or special requests. (Demo only)</p>
                ${threadHtml}
                <form onsubmit="submitProductMessage(event, ${product.id}, '${textareaId}')">
                    <div class="form-group" style="margin-top:1.25rem;">
                        <label class="form-label" for="${textareaId}">New message</label>
                        <textarea id="${textareaId}" class="form-textarea" rows="3" placeholder="Ask a question or share details..." required></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-ghost" onclick="closeModal()">Close</button>
                        <button type="submit" class="btn btn-primary">Send message</button>
                    </div>
                </form>
            `;
            showModal(content);
        }

        function submitProductMessage(event, productId, fieldId) {
            event.preventDefault();
            if (!AppState.user) {
                showToast('Please log in to send messages.', 'warning');
                goToScreen('auth');
                return;
            }
            const input = document.getElementById(fieldId);
            if (!input) return;
            const body = input.value.trim();
            if (!body) {
                showToast('Please enter a short message.', 'warning');
                return;
            }
            const nowIso = new Date().toISOString();
            const msg = {
                id: Date.now(),
                productId,
                senderEmail: AppState.user.email,
                senderName: AppState.user.name,
                body,
                createdAt: nowIso
            };
            AppState.messages.unshift(msg);
            saveState();
            saveErrandsToBackend();
            openProductMessagesModal(productId);
            showToast('Message sent (demo only).', 'success');
        }

        function submitJoinGroupBuy(event, productId, quantityFieldId, noteFieldId) {
            event.preventDefault();
            const product = findProductById(productId);
            if (!product || !AppState.user) return;
            const quantityInput = document.getElementById(quantityFieldId);
            const noteInput = document.getElementById(noteFieldId);
            const quantity = Number(quantityInput?.value || 1);
            if (!Number.isFinite(quantity) || quantity <= 0) {
                showToast('Enter a valid quantity (1 or more).', 'warning');
                return;
            }
            if (!AppState.user.roles?.includes('customer')) {
                AppState.user.roles = [...new Set([...(AppState.user.roles || []), 'customer'])];
                AppState.selectedRoles = new Set(AppState.user.roles);
            }

            const nowIso = new Date().toISOString();
            const order = {
                id: Date.now(),
                productId: product.id,
                quantity,
                note: noteInput?.value?.trim() || '',
                totalPrice: quantity * product.price,
                customerName: AppState.user.name,
                customerEmail: AppState.user.email,
                vendorEmail: product.ownerEmail,
                status: 'pending',
                createdAt: nowIso,
                updatedAt: nowIso,
                groupStatus: 'open',
                fulfillmentStatus: 'pending',
                cancelled: false
            };
            AppState.orders.push(order);
            product.currentQuantity += quantity;
            
            // Save to backend
            saveOrdersToBackend();
            saveProductsToBackend(); // Update current quantity
            
            refreshOrderStatuses();
            renderGroupBuyList();
            renderMarketplaceHighlights();
            renderDashboard();
            closeModal();
            showToast('Joined group buy! Track it from your dashboard.', 'success');
            triggerSuccessPulse();
        }

        function openEditProductModal(productId) {
            const product = findProductById(productId);
            if (!product || !AppState.user) return;
            if (product.ownerEmail !== AppState.user.email) {
                showToast('Only the vendor who created this product can edit it.', 'warning');
                return;
            }
            const priceId = `edit-price-${product.id}`;
            const descId = `edit-desc-${product.id}`;
            const deadlineId = `edit-deadline-${product.id}`;
            const deliveryId = `edit-delivery-${product.id}`;
            const targetId = `edit-target-${product.id}`;
            const content = `
                <h3 class="modal-title">Edit ${product.title}</h3>
                <p class="modal-subtitle">Update key details for this group buy.</p>
                <form onsubmit="submitEditProduct(event, ${product.id}, '${priceId}', '${descId}', '${deadlineId}', '${deliveryId}', '${targetId}')">
                    <div class="form-group">
                        <label class="form-label" for="${priceId}">Price per unit ($)</label>
                        <input id="${priceId}" class="form-input" type="number" min="1" value="${product.price}" required />
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="${descId}">Description</label>
                        <textarea id="${descId}" class="form-textarea" rows="3" required>${product.description}</textarea>
                    </div>
                    <div class="form-group" style="display:flex; gap:1rem; flex-wrap:wrap;">
                        <div style="flex:1; min-width:180px;">
                            <label class="form-label" for="${deadlineId}">Order deadline</label>
                            <input id="${deadlineId}" class="form-input" type="date" value="${product.deadline}" required />
                        </div>
                        <div style="flex:1; min-width:180px;">
                            <label class="form-label" for="${deliveryId}">Delivery date</label>
                            <input id="${deliveryId}" class="form-input" type="date" value="${product.deliveryDate}" required />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="${targetId}">Target quantity</label>
                        <input id="${targetId}" class="form-input" type="number" min="1" value="${product.targetQuantity}" required />
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-ghost" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save changes</button>
                    </div>
                </form>
            `;
            showModal(content);
        }

        function submitEditProduct(event, productId, priceId, descId, deadlineId, deliveryId, targetId) {
            event.preventDefault();
            const product = findProductById(productId);
            if (!product || !AppState.user) return;
            if (product.ownerEmail !== AppState.user.email) {
                showToast('Only the vendor who created this product can edit it.', 'warning');
                return;
            }
            const price = Number(document.getElementById(priceId)?.value || 0);
            const description = document.getElementById(descId)?.value.trim() || '';
            const deadline = document.getElementById(deadlineId)?.value;
            const deliveryDate = document.getElementById(deliveryId)?.value;
            const targetQuantity = Number(document.getElementById(targetId)?.value || 0);
            if (price <= 0 || targetQuantity <= 0 || !description || !deadline || !deliveryDate) {
                showToast('Please fill out all fields correctly.', 'warning');
                return;
            }
            const deadlineDate = new Date(deadline);
            const deliveryDateObj = new Date(deliveryDate);
            if (deliveryDateObj <= deadlineDate) {
                showToast('Delivery date must be after the order deadline.', 'warning');
                return;
            }
            product.price = price;
            product.description = description;
            product.deadline = deadline;
            product.deliveryDate = deliveryDate;
            product.targetQuantity = targetQuantity;
            saveState();
            saveProductsToBackend();
            renderGroupBuyList();
            renderMarketplaceHighlights();
            renderDashboard();
            closeModal();
            showToast('Product updated.', 'success');
        }

        function openDeleteProductConfirm(productId) {
            const product = findProductById(productId);
            if (!product || !AppState.user) return;
            if (product.ownerEmail !== AppState.user.email) {
                showToast('Only the vendor who created this product can delete it.', 'warning');
                return;
            }
            const content = `
                <h3 class="modal-title">Delete ${product.title}</h3>
                <p class="modal-subtitle">This will remove the product from the marketplace. Existing orders will remain for record-keeping.</p>
                <p class="screen-subtitle" style="margin-top:0.5rem;">Are you sure you want to continue?</p>
                <div class="modal-footer">
                    <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
                    <button class="btn reset-btn" onclick="confirmDeleteProduct(${product.id})">Delete product</button>
                </div>
            `;
            showModal(content);
        }

        function confirmDeleteProduct(productId) {
            const product = findProductById(productId);
            if (!product || !AppState.user) return;
            if (product.ownerEmail !== AppState.user.email) {
                showToast('Only the vendor who created this product can delete it.', 'warning');
                return;
            }
            AppState.products = AppState.products.filter(p => p.id !== product.id);
            saveState();
            saveProductsToBackend();
            renderGroupBuyList();
            renderMarketplaceHighlights();
            renderDashboard();
            closeModal();
            showToast('Product deleted.', 'info');
        }

        function cancelOrder(orderId) {
            const order = AppState.orders.find(item => item.id === Number(orderId));
            if (!order || !AppState.user) return;
            if (order.customerEmail !== AppState.user.email) {
                showToast('You can only cancel your own orders.', 'warning');
                return;
            }
            if (order.groupStatus !== 'open') {
                showToast('This order can no longer be cancelled.', 'warning');
                return;
            }
            const product = findProductById(order.productId);
            const deadline = product ? new Date(product.deadline) : null;
            if (deadline && new Date() > deadline) {
                showToast('Deadline passed — cancellation unavailable.', 'warning');
                return;
            }
            order.cancelled = true;
            order.groupStatus = 'cancelled';
            order.fulfillmentStatus = 'cancelled';
            order.updatedAt = new Date().toISOString();
            if (product) {
                product.currentQuantity = Math.max(0, product.currentQuantity - order.quantity);
            }
            persistOrders();
            refreshOrderStatuses();
            renderGroupBuyList();
            renderMarketplaceHighlights();
            renderDashboard();
            showToast('Order cancelled.', 'info');
        }

        function updateFulfillmentStatus(orderId, status) {
            const order = AppState.orders.find(item => item.id === Number(orderId));
            if (!order || !AppState.user) return;
            const product = findProductById(order.productId);
            if (!product || product.ownerEmail !== AppState.user.email) {
                showToast('Only the vendor can update fulfillment status.', 'warning');
                return;
            }
            if (!FulfillmentStages.includes(status)) return;
            order.fulfillmentStatus = status;
            order.updatedAt = new Date().toISOString();
            persistOrders();
            renderDashboard();
            showToast(`Order marked as ${status.replace(/_/g, ' ')}.`, 'success');
        }

        /**
         * Errand System
         */
        function renderErrandList() {
            const container = document.getElementById('errand-list');
            if (!container) return;

            const regionSelect = document.getElementById('errand-region-filter');
            if (regionSelect) {
                regionSelect.value = AppState.filters.errands.region;
            }
            const statusSelect = document.getElementById('errand-status-filter');
            if (statusSelect) {
                statusSelect.value = AppState.filters.errands.status;
            }
            const sortSelect = document.getElementById('errand-sort');
            if (sortSelect) {
                sortSelect.value = AppState.filters.errands.sort;
            }

            let errands = [...AppState.errands];
            const { region, status, sort } = AppState.filters.errands;
            if (region !== 'All') {
                errands = errands.filter(errand => errand.region === region);
            }
            if (status !== 'all') {
                errands = errands.filter(errand => errand.status === status);
            }

            const sorters = {
                newest: (a, b) => new Date(b.createdAt) - new Date(a.createdAt),
                budgetHigh: (a, b) => (b.budgetMax || 0) - (a.budgetMax || 0),
                budgetLow: (a, b) => (a.budgetMin || 0) - (b.budgetMin || 0)
            };
            errands.sort(sorters[sort] || sorters.newest);

            container.innerHTML = errands.length
                ? errands.map(renderErrandCard).join('')
                : '<p class="screen-subtitle">No errands found for these filters. Try a different region.</p>';
        }

        function renderErrandCard(errand) {
            return `
                <div class="card" role="button" tabindex="0"
                    onclick="openErrandDetail(${errand.id})"
                    onkeypress="handleCardKey(event, 'errand', ${errand.id})"
                    aria-label="View details for ${errand.title} - ${errand.region} - ${formatCurrency(errand.budgetMin)} to ${formatCurrency(errand.budgetMax)}">
                    <h4>${errand.title}</h4>
                    <p style="color:#475569;">${errand.description}</p>
                    <div class="card-meta">
                        <span class="pill info">${errand.region}</span>
                        <span>${formatCurrency(errand.budgetMin)} - ${formatCurrency(errand.budgetMax)}</span>
                        <span>${formatDateTime(errand.preferredTime)}</span>
                        ${renderStatusBadge(errand.status)}
                    </div>
                </div>
            `;
        }

        function handleErrandRegion(event) {
            AppState.filters.errands.region = event.target.value;
            renderErrandList();
        }

        function handleErrandStatus(event) {
            AppState.filters.errands.status = event.target.value;
            renderErrandList();
        }

        function handleErrandSort(event) {
            AppState.filters.errands.sort = event.target.value;
            renderErrandList();
        }

        function requireUser(roleType) {
            if (!AppState.user) {
                showToast('Please log in to continue.', 'warning');
                goToScreen('auth');
                return false;
            }
            if (roleType && !AppState.user.roles?.includes(roleType)) {
                showToast(`This action requires the ${roleType} role. Update your roles in the dashboard.`, 'warning');
                goToScreen('role');
                return false;
            }
            return true;
        }

        function handleCreateErrand(event) {
            event.preventDefault();
            if (!requireUser('customer')) return;
            const form = event.target;
            showFormMessage(form, '');
            const title = document.getElementById('errand-title').value.trim();
            const region = document.getElementById('errand-region').value;
            const description = document.getElementById('errand-description').value.trim();
            const budgetMin = Number(document.getElementById('errand-budget-min').value || 0);
            const budgetMax = Number(document.getElementById('errand-budget-max').value || 0);
            const preferredTime = document.getElementById('errand-time').value;
            const errors = [];
            if (!title) errors.push('Title is required.');
            if (!description) errors.push('Description is required.');
            if (!preferredTime) errors.push('Preferred time is required.');
            if (budgetMin < 0 || budgetMax <= 0 || budgetMax < budgetMin) {
                errors.push('Please set a valid budget range.');
            }
            if (errors.length) {
                showFormMessage(form, errors[0]);
                return;
            }
            const errand = {
                id: Date.now(),
                title,
                region,
                description,
                budget: budgetMax, // Use max budget as the main budget field
                budgetMin,
                budgetMax,
                preferredTime,
                deadline: preferredTime, // Map preferred time to deadline
                status: 'open', // open, matched, in_progress, completed
                requesterName: AppState.user.name,
                requesterEmail: AppState.user.email,
                createdAt: new Date().toISOString(),
                createdByUserId: AppState.user.email,
                assignedHelperEmail: null,
                assignedHelperName: null,
                acceptedHelperId: null
            };
            AppState.errands.unshift(errand);
            
            // Save to backend
            saveErrandsToBackend();
            
            form.reset();
            showFormMessage(form, 'Errand posted! Helpers will be notified.', 'success');
            renderErrandList();
            renderDashboard();
            showToast('Errand created. Helpers can now apply.', 'success');
            triggerSuccessPulse();
        }

        function openErrandDetail(errandId) {
            const errand = AppState.errands.find(item => item.id === Number(errandId));
            if (!errand) return;
            const applications = AppState.applications.filter(app => app.errandId === errand.id);
            const isOwner = AppState.user && errand.requesterEmail === AppState.user.email;
            const isHelper = AppState.user?.roles?.includes('helper');

            const actionButtons = [
                '<button class="btn btn-ghost" onclick="closeModal()">Close</button>'
            ];

            if (isHelper && !isOwner && errand.status === 'open') {
                actionButtons.push(`<button class="btn btn-primary" onclick="openHelperApplyModal(${errand.id})">Apply to help</button>`);
            }

            const isAssignedHelper = AppState.user && errand.assignedHelperEmail === AppState.user.email;
            if (isAssignedHelper && errand.status === 'matched') {
                actionButtons.push(`<button class="btn btn-primary" onclick="markErrandInProgress(${errand.id})">Start task</button>`);
            }
            if (isOwner && errand.status === 'in_progress') {
                actionButtons.push(`<button class="btn btn-primary" onclick="completeErrand(${errand.id})">Mark completed</button>`);
            }

            const ownerActions = isOwner && errand.status === 'open' && applications.length
                ? `
                    <div style="margin-top:1.5rem;">
                        <h4>Helper applications</h4>
                        <div class="stacked-list">
                            ${applications.map(app => `
                                <div class="list-card">
                                    <div>
                                        <strong>${app.helperName}</strong>
                                        <p>${app.message || 'No message provided.'}</p>
                                        <p style="font-size:0.85rem; color:#94a3b8;">Proposed: ${formatCurrency(app.offerAmount || 0)}</p>
                                    </div>
                                    <div style="display:flex; flex-direction:column; gap:0.5rem; align-items:flex-end;">
                                        ${renderStatusBadge(app.status)}
                                        ${app.status === 'pending' ? `
                                            <div style="display:flex; gap:0.5rem;">
                                                <button class="btn btn-primary" onclick="acceptHelperApplication(${app.id})">Accept</button>
                                                <button class="btn btn-ghost" onclick="declineHelperApplication(${app.id})">Decline</button>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `
                : '';

            const helperSummary = errand.assignedHelperName
                ? `<p><strong>Assigned helper:</strong> ${errand.assignedHelperName}</p>`
                : '';

            const content = `
                <h3 class="modal-title">${errand.title}</h3>
                <p class="modal-subtitle">${errand.description}</p>
                <div class="card-meta" style="margin-bottom:1rem;">
                    <span class="pill info">${errand.region}</span>
                    <span>${formatCurrency(errand.budgetMin)} - ${formatCurrency(errand.budgetMax)}</span>
                    <span>${formatDateTime(errand.preferredTime)}</span>
                    ${renderStatusBadge(errand.status)}
                </div>
                <p><strong>Posted by:</strong> ${errand.requesterName}</p>
                ${helperSummary}
                <div class="modal-footer" style="justify-content:flex-end; flex-wrap:wrap; gap:0.5rem;">
                    ${actionButtons.join('')}
                </div>
                ${ownerActions}
            `;
            showModal(content);
        }

        function openHelperApplyModal(errandId) {
            if (!requireUser('helper')) return;
            const errand = AppState.errands.find(item => item.id === Number(errandId));
            if (!errand) return;
            if (errand.status !== 'open') {
                showToast('This errand is no longer accepting helpers.', 'warning');
                return;
            }
            if (errand.requesterEmail === AppState.user.email) {
                showToast('You cannot apply to your own errand.', 'warning');
                return;
            }
            const existingApplication = AppState.applications.find(app =>
                app.errandId === errand.id && app.helperEmail === AppState.user.email
            );
            if (existingApplication) {
                showToast('You have already applied to this errand.', 'info');
                return;
            }
            const offerId = `helper-offer-${errand.id}`;
            const messageId = `helper-message-${errand.id}`;
            const content = `
                <h3 class="modal-title">Apply to ${errand.title}</h3>
                <p class="modal-subtitle">Send a quick note and proposed rate to the customer.</p>
                <form onsubmit="submitHelperApplication(event, ${errand.id}, '${offerId}', '${messageId}')">
                    <div class="form-group">
                        <label class="form-label" for="${offerId}">Proposed amount ($)</label>
                        <input id="${offerId}" type="number" min="0" class="form-input" required />
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="${messageId}">Message</label>
                        <textarea id="${messageId}" class="form-textarea" rows="3" required placeholder="Share availability or experience."></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-ghost" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Submit application</button>
                    </div>
                </form>
            `;
            showModal(content);
        }

        function submitHelperApplication(event, errandId, offerFieldId, messageFieldId) {
            event.preventDefault();
            if (!requireUser('helper')) return;
            const errand = AppState.errands.find(item => item.id === Number(errandId));
            if (!errand) return;
            const offerValue = Number(document.getElementById(offerFieldId)?.value || 0);
            const messageValue = document.getElementById(messageFieldId)?.value.trim();
            if (!messageValue) {
                showToast('Please include a short message.', 'warning');
                return;
            }
            const application = {
                id: Date.now(),
                errandId: errand.id,
                helperUserId: AppState.user.email,
                helperEmail: AppState.user.email,
                helperName: AppState.user.name,
                offerAmount: offerValue,
                message: messageValue,
                status: 'pending', // pending, accepted, declined, withdrawn, in_progress, completed
                createdAt: new Date().toISOString()
            };
            AppState.applications.push(application);
            persistApplications();
            renderDashboard();
            closeModal();
            showToast('Application sent! Track responses on your helper dashboard.', 'success');
        }

        function acceptHelperApplication(applicationId) {
            const application = AppState.applications.find(app => app.id === Number(applicationId));
            if (!application) return;
            const errand = AppState.errands.find(item => item.id === application.errandId);
            if (!errand || errand.requesterEmail !== AppState.user?.email) {
                showToast('Only the errand owner can accept helpers.', 'warning');
                return;
            }
            if (errand.status !== 'open') {
                showToast('This errand is no longer accepting applications.', 'warning');
                return;
            }
            errand.status = 'matched';
            errand.matchedAt = new Date().toISOString();
            errand.assignedHelperEmail = application.helperEmail;
            errand.assignedHelperName = application.helperName;
            errand.acceptedHelperId = application.helperUserId || application.helperEmail;
            AppState.applications = AppState.applications.map(app => app.errandId === errand.id
                ? { ...app, status: app.id === application.id ? 'accepted' : 'declined' }
                : app
            );
            persistErrands();
            persistApplications();
            renderErrandList();
            renderDashboard();
            openErrandDetail(errand.id);
            showToast('Helper accepted. Errand is now matched.', 'success');
        }

        function declineHelperApplication(applicationId) {
            const application = AppState.applications.find(app => app.id === Number(applicationId));
            if (!application) return;
            const errand = AppState.errands.find(item => item.id === application.errandId);
            if (!errand || errand.requesterEmail !== AppState.user?.email) {
                showToast('Only the errand owner can decline helpers.', 'warning');
                return;
            }
            if (application.status !== 'pending') {
                showToast('This application has already been processed.', 'warning');
                return;
            }
            application.status = 'declined';
            persistApplications();
            renderDashboard();
            openErrandDetail(errand.id);
            showToast('Application declined.', 'info');
        }

        function cancelHelperApplication(applicationId) {
            const application = AppState.applications.find(app => app.id === Number(applicationId));
            if (!application || !AppState.user) return;
            if (application.helperEmail !== AppState.user.email) {
                showToast('You can only cancel your own applications.', 'warning');
                return;
            }
            if (application.status !== 'pending') {
                showToast('This application can no longer be cancelled.', 'warning');
                return;
            }
            const errand = AppState.errands.find(item => item.id === application.errandId);
            if (errand && errand.status !== 'open') {
                showToast('This errand is no longer accepting applications.', 'warning');
                return;
            }
            application.status = 'withdrawn';
            persistApplications();
            renderDashboard();
            showToast('Application withdrawn.', 'info');
        }

        function markErrandInProgress(errandId) {
            const errand = AppState.errands.find(item => item.id === Number(errandId));
            if (!errand || !AppState.user) return;
            if (errand.assignedHelperEmail !== AppState.user.email) {
                showToast('Only the assigned helper can start this errand.', 'warning');
                return;
            }
            if (errand.status !== 'matched') {
                showToast('This errand is already in progress or completed.', 'warning');
                return;
            }
            errand.status = 'in_progress';
            errand.inProgressAt = new Date().toISOString();
            // Update accepted application to in_progress for this helper
            AppState.applications = AppState.applications.map(app => {
                if (app.errandId === errand.id &&
                    app.helperEmail === AppState.user.email &&
                    app.status === 'accepted') {
                    return { ...app, status: 'in_progress' };
                }
                return app;
            });
            persistErrands();
            persistApplications();
            renderErrandList();
            renderDashboard();
            openErrandDetail(errand.id);
            showToast('Task marked as in progress.', 'info');
        }

        function completeErrand(errandId) {
            const errand = AppState.errands.find(item => item.id === Number(errandId));
            if (!errand || !AppState.user) return;
            if (errand.requesterEmail !== AppState.user.email) {
                showToast('Only the customer can mark completion.', 'warning');
                return;
            }
            if (errand.status !== 'in_progress') {
                showToast('Errand is not in progress yet.', 'warning');
                return;
            }
            errand.status = 'completed';
            errand.completedAt = new Date().toISOString();
            // Mark accepted application as completed for consistency
            AppState.applications = AppState.applications.map(app => {
                if (app.errandId === errand.id &&
                    app.helperEmail === errand.assignedHelperEmail &&
                    ['accepted', 'in_progress'].includes(app.status)) {
                    return { ...app, status: 'completed' };
                }
                return app;
            });
            persistErrands();
            persistApplications();
            renderErrandList();
            renderDashboard();
            openErrandDetail(errand.id);
            showToast('Errand completed! Thanks for supporting your community.', 'success');
        }

        /**
         * SVG Template Selection
         */
        function selectSvgTemplate(button, templateName) {
            document.querySelectorAll('.svg-template-btn').forEach(btn => {
                btn.classList.remove('selected');
                btn.setAttribute('aria-pressed', 'false');
            });
            button.classList.add('selected');
            button.setAttribute('aria-pressed', 'true');
            const templateInput = document.getElementById('vendor-product-template');
            if (templateInput) {
                templateInput.value = templateName;
            }
            const imageInput = document.querySelector('[name="vendor-product-image"]');
            if (imageInput) {
                imageInput.value = '';
            }
        }

        /**
         * Vendor Product Management
         */
        function handleAddProduct(event) {
            event.preventDefault();
            if (!requireUser('vendor')) return;
            const form = event.target;
            showFormMessage(form, '');
            const title = form.querySelector('[name="vendor-product-title"]').value.trim();
            const price = Number(form.querySelector('[name="vendor-product-price"]').value || 0);
            const region = form.querySelector('[name="vendor-product-region"]').value;
            const description = form.querySelector('[name="vendor-product-description"]').value.trim();
            const deadline = form.querySelector('[name="vendor-product-deadline"]').value;
            const deliveryDate = form.querySelector('[name="vendor-product-delivery"]').value;
            const targetQuantity = Number(form.querySelector('[name="vendor-product-target"]').value || 10);
            const imageInput = form.querySelector('[name="vendor-product-image"]');
            const file = imageInput?.files?.[0] || null;
            const templateInput = form.querySelector('[name="vendor-product-template"]');
            const selectedTemplate = templateInput?.value || '';
            const errors = [];
            if (!title) errors.push('Product title is required.');
            if (!description) errors.push('Description is required.');
            if (!deadline) errors.push('Order deadline is required.');
            if (!deliveryDate) errors.push('Delivery date is required.');
            if (price <= 0) errors.push('Price must be greater than zero.');
            if (targetQuantity < 5) errors.push('Target quantity must be at least 5.');
            const deadlineDate = new Date(deadline);
            const deliveryDateObj = new Date(deliveryDate);
            if (deliveryDateObj <= deadlineDate) {
                errors.push('Delivery date must be after the order deadline.');
            }
            if (errors.length) {
                showFormMessage(form, errors[0]);
                return;
            }

            const templateColors = {
                gradient: ['#38bdf8', '#7c3aed'],
                food: ['#f87171', '#fb923c'],
                nature: ['#10b981', '#34d399'],
                premium: ['#facc15', '#fbbf24']
            };
            const palette = ['#38bdf8', '#fb923c', '#facc15', '#a5b4fc', '#f87171', '#10b981'];
            const templateColor = selectedTemplate && templateColors[selectedTemplate]
                ? templateColors[selectedTemplate][0]
                : palette[Math.floor(Math.random() * palette.length)];
            
            const finalize = (imageDataUrl) => {
                let finalImage = imageDataUrl;
                if (!finalImage && selectedTemplate && templateColors[selectedTemplate]) {
                    finalImage = generateProductGraphic(title, templateColors[selectedTemplate][0]);
                } else if (!finalImage) {
                    finalImage = generateProductGraphic(title, templateColor);
                }
                
                const newProduct = {
                    id: Date.now(),
                    title,
                    price,
                    region,
                    description,
                    deadline,
                    deliveryDate,
                    vendor: AppState.user.name,
                    ownerEmail: AppState.user.email,
                    targetQuantity,
                    currentQuantity: 0,
                    imageColor: templateColor,
                    imageDataUrl: finalImage,
                    createdAt: new Date().toISOString()
                };
                AppState.products.unshift(newProduct);
                saveState();
                saveProductsToBackend();
                form.reset();
                document.querySelectorAll('.svg-template-btn').forEach(btn => btn.classList.remove('selected'));
                if (templateInput) templateInput.value = '';
                showFormMessage(form, 'Product created! Share it with your community.', 'success');
                showToast('Product published to the marketplace.', 'success');
                triggerSuccessPulse();
                renderGroupBuyList();
                renderMarketplaceHighlights();
                renderDashboard();
            };

            if (file) {
                const reader = new FileReader();
                reader.onload = () => finalize(reader.result);
                reader.onerror = () => {
                    showFormMessage(form, 'Could not read the image file. Please try again.');
                };
                reader.readAsDataURL(file);
            } else {
                finalize(null);
            }
        }

        /**
         * Dashboard
         */
        function renderDashboard() {
            const title = document.getElementById('dashboard-title');
            const subtitle = document.getElementById('dashboard-subtitle');
            const content = document.getElementById('dashboard-content');
            if (!AppState.user || !content) return;
            refreshOrderStatuses();

            title.textContent = `Welcome, ${AppState.user.name}`;
            const roles = AppState.user.roles || [];
            if (!roles.length) {
                subtitle.textContent = 'Select a role to unlock personalized tools.';
            } else if (roles.includes('helper')) {
                subtitle.textContent = 'Track tasks, payouts, and requests in one place.';
            } else if (roles.includes('vendor')) {
                subtitle.textContent = 'Launch new group buys and manage customers.';
            } else {
                subtitle.textContent = 'Browse group buys, errands, and savings.';
            }

            const sections = [];
            sections.push(renderAccountSummary(roles));

            const hasCustomerData = roles.includes('customer')
                || AppState.orders.some(order => order.customerEmail === AppState.user.email)
                || AppState.errands.some(errand => errand.requesterEmail === AppState.user.email);
            if (hasCustomerData) {
                sections.push(renderCustomerDashboard());
            }

            const hasHelperData = roles.includes('helper')
                || AppState.errands.some(errand => errand.assignedHelperEmail === AppState.user.email);
            if (hasHelperData) {
                sections.push(renderHelperDashboard());
            }

            const hasVendorData = roles.includes('vendor')
                || AppState.products.some(product => product.ownerEmail === AppState.user.email)
                || AppState.orders.some(order => order.vendorEmail === AppState.user.email);
            if (hasVendorData) {
                sections.push(renderVendorDashboard());
            }

            content.innerHTML = sections.join('') || '<p class="screen-subtitle">Select a role to unlock personalized dashboards.</p>';
        }

        function renderAccountSummary(roles) {
            const roleBadges = roles.length
                ? roles.map(role => `<span class="role-badge ${role === 'helper' ? 'helper' : ''}">${role.toUpperCase()}</span>`).join(' ')
                : '<span class="pill">No roles selected</span>';
            const helperStatus = roles.includes('helper')
                ? `<p><strong>Helper status:</strong> ${AppState.user.helperVerified ? 'Verified ✅' : 'Pending verification'}</p>`
                : '';
            return `
                <div class="view-content" style="margin-bottom:1.5rem;">
                    <h3>Your account</h3>
                    <p><strong>Roles:</strong> ${roleBadges}</p>
                    ${helperStatus}
                    <div class="view-actions" style="margin-top:1rem;">
                        <button class="btn btn-primary" onclick="goToScreen('role')">Edit roles</button>
                        ${roles.includes('helper') && !AppState.user.helperVerified ? '<button class="btn btn-secondary" onclick="goToScreen(\'helper\')">Finish helper verification</button>' : ''}
                </div>
                </div>
            `;
        }

        function renderCustomerDashboard() {
            const metrics = AnalyticsEngine.getCustomerMetrics(AppState.user.email);
            const myOrders = AppState.orders.filter(order => order.customerEmail === AppState.user.email);
            const myErrands = AppState.errands.filter(errand => errand.requesterEmail === AppState.user.email);

            const ordersHtml = myOrders.length
                ? myOrders.map(order => {
                    const product = findProductById(order.productId);
                    const canCancel = order.groupStatus === 'open' && order.fulfillmentStatus === 'pending';
                    const deliveryInfo = product?.deliveryDate
                        ? `<p style="font-size:0.85rem; color:#64748b; margin-top:0.25rem;">📦 Delivery: ${formatDate(product.deliveryDate)}</p>`
                        : '';
                    return `
                        <div class="list-card">
                            <div>
                                <strong>${product?.title || 'Unknown product'}</strong>
                                <p>${order.quantity} × ${formatCurrency(product?.price || 0)} — Ordered ${formatDate(order.createdAt)}</p>
                                ${deliveryInfo}
                                <div style="display:flex; flex-wrap:wrap; gap:0.35rem; margin-top:0.4rem;">
                                    ${renderStatusBadge(order.groupStatus)}
                                    ${renderStatusBadge(order.fulfillmentStatus)}
                                </div>
                            </div>
                            <div style="display:flex; flex-direction:column; gap:0.35rem; align-items:flex-end;">
                                <span class="badge info">${formatCurrency(order.total)}</span>
                                ${canCancel ? `<button class="btn btn-ghost" onclick="cancelOrder(${order.id})">Cancel</button>` : ''}
                            </div>
                        </div>
                    `;
                }).join('')
                : '<p class="screen-subtitle">You have not joined any group buys yet.</p>';

            const errandsHtml = myErrands.length
                ? myErrands.map(errand => {
                    const canComplete = errand.status === 'in_progress';
                    const helperChip = errand.assignedHelperName
                        ? `<span class="badge info">Helper • ${errand.assignedHelperName}</span>`
                        : '';
                    const applications = AppState.applications.filter(app => app.errandId === errand.id);
                    const pendingCount = applications.filter(app => app.status === 'pending').length;
                    const hasApplications = pendingCount > 0 && errand.status === 'open';
                    return `
                        <div class="list-card" style="cursor:pointer;" onclick="openErrandDetail(${errand.id})" role="button" tabindex="0" onkeypress="handleCardKey(event, 'errand', ${errand.id})">
                            <div style="flex:1;">
                                <strong>${errand.title}</strong>
                                <p>${errand.region} • ${formatDateTime(errand.preferredTime)}</p>
                                <div style="display:flex; flex-wrap:wrap; gap:0.35rem; margin-top:0.4rem;">
                                    ${renderStatusBadge(errand.status)}
                                    ${helperChip}
                                    ${hasApplications ? `<span class="badge info" style="background:#fef3c7; color:#b45309;">${pendingCount} application${pendingCount > 1 ? 's' : ''}</span>` : ''}
                                </div>
                            </div>
                            <div style="display:flex; flex-direction:column; gap:0.35rem; align-items:flex-end;">
                                ${canComplete ? `<button class="btn btn-primary" onclick="event.stopPropagation(); completeErrand(${errand.id})">Mark completed</button>` : ''}
                                ${hasApplications ? `<button class="btn btn-secondary" onclick="event.stopPropagation(); openErrandDetail(${errand.id})">View applications</button>` : ''}
                            </div>
                        </div>
                    `;
                }).join('')
                : '<p class="screen-subtitle">No errands posted yet. Use the form on the errand page to create one.</p>';

            // Analytics Dashboard
            const analyticsHtml = `
                <div class="analytics-dashboard">
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Your Savings & Activity</h3>
                            <span class="chart-period">Your performance</span>
                        </div>
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <span class="metric-value">$${metrics.totalSavings.toFixed(2)}</span>
                                <div class="metric-label">Total Savings</div>
                                <div class="metric-change positive">
                                    ${metrics.savingsRate.toFixed(1)}% savings rate
                                </div>
                            </div>
                            <div class="metric-card">
                                <span class="metric-value">$${metrics.totalSpent.toFixed(2)}</span>
                                <div class="metric-label">Total Spent</div>
                                <div class="metric-change neutral">
                                    $${metrics.monthlySpent.toFixed(2)} this month
                                </div>
                            </div>
                            <div class="metric-card">
                                <span class="metric-value">${metrics.totalOrders}</span>
                                <div class="metric-label">Group Buy Orders</div>
                                <div class="metric-change neutral">
                                    $${metrics.avgOrderValue.toFixed(2)} avg order
                                </div>
                            </div>
                            <div class="metric-card">
                                <span class="metric-value">${metrics.groupBuyParticipation.toFixed(1)}%</span>
                                <div class="metric-label">Group Buy Rate</div>
                                <div class="metric-change neutral">vs individual purchases</div>
                            </div>
                        </div>
                    </div>
                    
                    ${renderCustomerSpendingChart(metrics.spendingTrend)}
                    ${renderCustomerCategoryChart(metrics.categorySpending)}
                    ${renderCustomerInsights(metrics)}
                </div>
            `;

            return analyticsHtml + `
                <div class="view-content">
                    <h3>My Group Buys</h3>
                    ${ordersHtml}
                </div>
                <div class="view-content">
                    <h3>My Errands</h3>
                    ${errandsHtml}
                </div>
            `;
        }

        function renderHelperDashboard() {
            const metrics = AnalyticsEngine.getHelperMetrics(AppState.user.email);
            const myApplications = AppState.applications.filter(app => app.helperEmail === AppState.user.email);
            // Active tasks are derived from accepted/in_progress/completed applications
            const activeTaskApplications = AppState.applications.filter(app =>
                app.helperEmail === AppState.user.email &&
                ['accepted', 'in_progress', 'completed'].includes(app.status)
            );
            const myTasks = activeTaskApplications
                .map(app => AppState.errands.find(errand => errand.id === app.errandId))
                .filter(Boolean);

            const applicationsHtml = myApplications.length
                ? myApplications.map(app => {
                    const errand = AppState.errands.find(item => item.id === app.errandId);
                    const canCancel = app.status === 'pending' && errand && errand.status === 'open';
                    return `
                        <div class="list-card" style="cursor:pointer;" onclick="openErrandDetail(${app.errandId})" role="button" tabindex="0" onkeypress="if(event.key==='Enter') openErrandDetail(${app.errandId})">
                            <div style="flex:1;">
                                <strong>${errand?.title || 'Errand removed'}</strong>
                                <p>${formatDate(app.createdAt)} • Offer ${formatCurrency(app.offerAmount || 0)}</p>
                                ${app.message ? `<p style="font-size:0.85rem; color:#64748b; margin-top:0.25rem;">${app.message.substring(0, 60)}${app.message.length > 60 ? '...' : ''}</p>` : ''}
                            </div>
                            <div style="display:flex; flex-direction:column; gap:0.35rem; align-items:flex-end;">
                                ${renderStatusBadge(app.status)}
                                ${canCancel ? `<button class="btn btn-ghost" onclick="event.stopPropagation(); cancelHelperApplication(${app.id})">Withdraw</button>` : ''}
                            </div>
                        </div>
                    `;
                }).join('')
                : '<p class="screen-subtitle">Apply to errands to see updates here.</p>';

            const tasksHtml = myTasks.length
                ? myTasks.map(task => `
                    <div class="list-card">
                        <div>
                            <strong>${task.title}</strong>
                            <p>${task.region} • ${formatDateTime(task.preferredTime)}</p>
                        </div>
                        <div style="display:flex; flex-direction:column; gap:0.35rem; align-items:flex-end;">
                            ${renderStatusBadge(task.status)}
                            ${task.status === 'matched'
                                ? `<button class="btn btn-primary" onclick="markErrandInProgress(${task.id})">Start task</button>`
                                : ''}
                        </div>
                    </div>
                `).join('')
                : '<p class="screen-subtitle">No active tasks. Apply to open errands to get assigned.</p>';

            // Analytics Dashboard
            const analyticsHtml = `
                <div class="analytics-dashboard">
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Helper Performance Overview</h3>
                            <span class="chart-period">Your statistics</span>
                        </div>
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <span class="metric-value">$${metrics.totalEarnings.toFixed(2)}</span>
                                <div class="metric-label">Total Earnings</div>
                                <div class="metric-change ${metrics.monthlyEarnings > 0 ? 'positive' : 'neutral'}">
                                    $${metrics.monthlyEarnings.toFixed(2)} this month
                                </div>
                            </div>
                            <div class="metric-card">
                                <span class="metric-value">${metrics.completedErrands}</span>
                                <div class="metric-label">Completed Errands</div>
                                <div class="metric-change neutral">
                                    $${metrics.avgEarningsPerErrand.toFixed(2)} avg per errand
                                </div>
                            </div>
                            <div class="metric-card">
                                <span class="metric-value">${metrics.acceptanceRate.toFixed(1)}%</span>
                                <div class="metric-label">Acceptance Rate</div>
                                <div class="metric-change neutral">${metrics.acceptedApplications}/${metrics.totalApplications} applications</div>
                            </div>
                            <div class="metric-card">
                                <span class="metric-value">${metrics.completionRate.toFixed(1)}%</span>
                                <div class="metric-label">Completion Rate</div>
                                <div class="metric-change neutral">Tasks completed successfully</div>
                            </div>
                        </div>
                    </div>
                    
                    ${renderHelperEarningsChart(metrics.earningsTrend)}
                    ${renderHelperCategoryChart(metrics.categoryBreakdown)}
                    ${renderHelperInsights(metrics)}
                </div>
            `;

            return analyticsHtml + `
                <div class="view-content">
                    <h3>My Applications</h3>
                    ${applicationsHtml}
                </div>
                <div class="view-content">
                    <h3>My Active Tasks</h3>
                    ${tasksHtml}
                </div>
            `;
        }

        function renderProfile() {
            const profileContent = document.getElementById('profile-content');
            if (!profileContent || !AppState.user) return;

            const user = AppState.user;
            const roles = user.roles || [];
            
            profileContent.innerHTML = `
                <div class="view-content">
                    <div class="profile-header">
                        <div class="profile-avatar">
                            <div class="avatar-circle">
                                ${user.name ? user.name.charAt(0).toUpperCase() : 'U'}
                            </div>
                        </div>
                        <div class="profile-info">
                            <h3>${user.name || 'User'}</h3>
                            <p class="profile-email">${user.email}</p>
                            <div class="profile-roles">
                                ${roles.map(role => `<span class="role-badge role-${role.toLowerCase()}">${role}</span>`).join('')}
                                ${user.helperVerified ? '<span class="verification-badge">Verified ✓</span>' : ''}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="view-content">
                    <h3>Account Settings</h3>
                    <div class="settings-list">
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-title">Display Name</div>
                                <div class="setting-description">${user.name || 'Not set'}</div>
                            </div>
                            <button class="btn btn-ghost" onclick="editDisplayName()">Edit</button>
                        </div>
                        
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-title">Email Address</div>
                                <div class="setting-description">${user.email}</div>
                            </div>
                            <button class="btn btn-ghost" onclick="editEmail()">Change</button>
                        </div>
                        
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-title">User Roles</div>
                                <div class="setting-description">${roles.join(', ')}</div>
                            </div>
                            <button class="btn btn-ghost" onclick="editRoles()">Manage</button>
                        </div>
                        
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-title">Language</div>
                                <div class="setting-description">${currentLanguage === 'ko' ? '한국어 (Korean)' : 'English'}</div>
                            </div>
                            <button class="btn btn-ghost" onclick="toggleLanguage()">Switch</button>
                        </div>
                    </div>
                </div>

                ${roles.includes('helper') ? `
                <div class="view-content">
                    <h3>Helper Profile</h3>
                    <div class="helper-profile-card">
                        <div class="helper-status">
                            <span class="status-indicator ${user.helperVerified ? 'verified' : 'pending'}">
                                ${user.helperVerified ? '✓ Verified' : '⏳ Pending Verification'}
                            </span>
                        </div>
                        ${user.helperData ? `
                            <div class="helper-details">
                                <p><strong>Phone:</strong> ${user.helperData.phone || 'Not provided'}</p>
                                <p><strong>Address:</strong> ${user.helperData.address || 'Not provided'}</p>
                                <p><strong>ID Verified:</strong> ${user.helperData.idVerified ? 'Yes' : 'No'}</p>
                            </div>
                        ` : ''}
                        <button class="btn btn-primary" onclick="goToScreen('helper')">Update Helper Profile</button>
                    </div>
                </div>
                ` : ''}

                <div class="view-content">
                    <h3>Privacy & Security</h3>
                    <div class="settings-list">
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-title">Password</div>
                                <div class="setting-description">Change your account password</div>
                            </div>
                            <button class="btn btn-ghost" onclick="changePassword()">Change</button>
                        </div>
                        
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-title">Data Export</div>
                                <div class="setting-description">Download your account data</div>
                            </div>
                            <button class="btn btn-ghost" onclick="exportData()">Export</button>
                        </div>
                    </div>
                </div>

                <div class="view-content">
                    <h3>Account Actions</h3>
                    <div class="action-buttons">
                        <button class="btn reset-btn" onclick="resetApp()">Reset App Data</button>
                        <button class="btn btn-danger" onclick="logout()">Sign Out</button>
                    </div>
                </div>
            `;
        }

        // Profile action functions
        function editDisplayName() {
            const newName = prompt('Enter your display name:', AppState.user.name || '');
            if (newName && newName.trim()) {
                AppState.user.name = newName.trim();
                persistUser(AppState.user);
                renderProfile();
                showToast('Display name updated successfully');
            }
        }

        function editEmail() {
            showToast('Email changes require re-authentication. Please sign out and create a new account with your preferred email.');
        }

        function editRoles() {
            goToScreen('role');
        }

        function changePassword() {
            showToast('Password changes are handled through your authentication provider. Please sign out and use "Forgot Password" if needed.');
        }

        function exportData() {
            const data = {
                user: AppState.user,
                orders: AppState.orders.filter(o => o.customerEmail === AppState.user.email),
                errands: AppState.errands.filter(e => e.requesterEmail === AppState.user.email),
                applications: AppState.applications.filter(a => a.helperEmail === AppState.user.email),
                products: AppState.products.filter(p => p.ownerEmail === AppState.user.email)
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `korean-commerce-data-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Data exported successfully');
        }

        function renderVendorDashboard() {
            const metrics = AnalyticsEngine.getVendorMetrics(AppState.user.email);
            const myProducts = AppState.products.filter(product => product.ownerEmail === AppState.user.email);
            const myOrders = AppState.orders.filter(order => {
                const product = findProductById(order.productId);
                return product && product.ownerEmail === AppState.user.email;
            });

            const productsHtml = myProducts.length
                ? myProducts.map(product => `
                    <div class="list-card">
                        <div>
                            <strong>${product.title}</strong>
                            <p>${product.region} • ${calculateProgress(product)}% funded</p>
                        </div>
                        <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
                            <button class="btn btn-secondary" onclick="openProductDetail(${product.id})">View</button>
                            <button class="btn btn-ghost" onclick="openEditProductModal(${product.id})">Edit</button>
                            <button class="btn reset-btn" onclick="openDeleteProductConfirm(${product.id})">Delete</button>
                        </div>
                    </div>
                `).join('')
                : '<p class="screen-subtitle">No products yet. Add one using the form.</p>';

            const vendorOrdersAll = myOrders.filter(order => order.groupStatus !== 'cancelled');
            const voFilters = AppState.filters.vendorOrders || { status: 'all', search: '' };
            const searchLower = (voFilters.search || '').trim().toLowerCase();
            const vendorOrders = vendorOrdersAll.filter(order => {
                const statusMatch = voFilters.status === 'all' || order.fulfillmentStatus === voFilters.status;
                const nameMatch = !searchLower || (order.customerName || '').toLowerCase().includes(searchLower);
                return statusMatch && nameMatch;
            });
            const totalSales = vendorOrders.reduce((sum, order) => sum + (order.total || 0), 0);
            const platformFee = totalSales * 0.15;
            const netIncome = totalSales - platformFee;

            const groupedOrders = vendorOrders.reduce((acc, order) => {
                const key = order.productId;
                if (!acc[key]) acc[key] = [];
                acc[key].push(order);
                return acc;
            }, {});

            const groupedHtml = Object.keys(groupedOrders).length
                ? Object.entries(groupedOrders).map(([productId, orders]) => {
                    const product = findProductById(productId);
                    const orderRows = orders.map(order => {
                        const options = FulfillmentStages.map(stage => `
                            <option value="${stage}" ${order.fulfillmentStatus === stage ? 'selected' : ''}>${stage.replace(/_/g, ' ')}</option>
                        `).join('');
                        return `
                            <div class="list-card">
                                <div>
                                    <strong>${order.customerName}</strong>
                                    <p>${order.quantity} × ${formatCurrency(product?.price || 0)} — ${formatDate(order.createdAt)}</p>
                                    <div style="display:flex; flex-wrap:wrap; gap:0.35rem; margin-top:0.35rem;">
                                        ${renderStatusBadge(order.groupStatus)}
                                        ${renderStatusBadge(order.fulfillmentStatus)}
                                    </div>
                                </div>
                                <div>
                                    <select class="form-select" onchange="updateFulfillmentStatus(${order.id}, this.value)">
                                        ${options}
                                    </select>
                                </div>
                            </div>
                        `;
                    }).join('');
                    return `
                        <div style="margin-bottom:1.25rem;">
                            <h4>${product?.title || 'Product'}</h4>
                            <div class="stacked-list">
                                ${orderRows}
                            </div>
                        </div>
                    `;
                }).join('')
                : '<p class="screen-subtitle">No orders yet. Share your group buy link to collect pledges.</p>';

            // Analytics Dashboard
            const analyticsHtml = `
                <div class="analytics-dashboard">
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Vendor Analytics Overview</h3>
                            <span class="chart-period">Performance metrics</span>
                        </div>
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <span class="metric-value">$${metrics.totalRevenue.toFixed(2)}</span>
                                <div class="metric-label">Total Revenue</div>
                                <div class="metric-change ${metrics.monthlyRevenue > 0 ? 'positive' : 'neutral'}">
                                    ${metrics.monthlyRevenue > 0 ? '+' : ''}$${metrics.monthlyRevenue.toFixed(2)} this month
                                </div>
                            </div>
                            <div class="metric-card">
                                <span class="metric-value">${metrics.totalOrders}</span>
                                <div class="metric-label">Total Orders</div>
                                <div class="metric-change ${metrics.recentOrders > 0 ? 'positive' : 'neutral'}">
                                    ${metrics.recentOrders} recent orders
                                </div>
                            </div>
                            <div class="metric-card">
                                <span class="metric-value">${metrics.conversionRate.toFixed(1)}%</span>
                                <div class="metric-label">Conversion Rate</div>
                                <div class="metric-change neutral">Views to orders</div>
                            </div>
                            <div class="metric-card">
                                <span class="metric-value">${metrics.successRate.toFixed(1)}%</span>
                                <div class="metric-label">Success Rate</div>
                                <div class="metric-change neutral">Products reaching target</div>
                            </div>
                        </div>
                    </div>
                    
                    ${renderRevenueChart(metrics.monthlyTrend)}
                    ${renderTopProductsChart(metrics.topProducts)}
                    ${renderVendorInsights(metrics)}
                </div>
            `;

            return analyticsHtml + `
                <div class="view-content">
                    <h3>Revenue snapshot</h3>
                    <p><strong>Total sales:</strong> ${formatCurrency(totalSales)}</p>
                    <p><strong>Platform fee (15%):</strong> ${formatCurrency(platformFee)}</p>
                    <p><strong>Income after fees:</strong> ${formatCurrency(netIncome)}</p>
                </div>
                <div class="view-content">
                    <h3>My Products</h3>
                    ${productsHtml}
                </div>
                <div class="view-content">
                    <h3>Add Product</h3>
                    <form onsubmit="handleAddProduct(event)">
                        <div class="form-group">
                            <label class="form-label">Title</label>
                            <input class="form-input" name="vendor-product-title" required placeholder="e.g., Lunar New Year Snack Bundle" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Region</label>
                            <select class="form-select" name="vendor-product-region" required>
                                <option value="Toronto">Toronto</option>
                                <option value="Hamilton">Hamilton</option>
                                <option value="Niagara">Niagara</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Price per unit ($)</label>
                            <input type="number" class="form-input" name="vendor-product-price" required min="1" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <textarea class="form-textarea" name="vendor-product-description" rows="3" required></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Cover image (optional)</label>
                            <input type="file" class="form-input" name="vendor-product-image" accept="image/*" aria-label="Upload product image" />
                            <p class="screen-subtitle" style="margin-top:0.35rem;">Upload a photo or choose a template below.</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Or choose a template</label>
                            <div style="display:grid; grid-template-columns:repeat(auto-fill,minmax(100px,1fr)); gap:0.75rem; margin-top:0.5rem;">
                                <button type="button" class="svg-template-btn" data-template="gradient" onclick="selectSvgTemplate(this, 'gradient')" aria-label="Select gradient template">
                                    <div style="width:100%; height:60px; background:linear-gradient(135deg,#38bdf8,#7c3aed); border-radius:8px;"></div>
                                    <span style="font-size:0.75rem; margin-top:0.25rem;">Gradient</span>
                                </button>
                                <button type="button" class="svg-template-btn" data-template="food" onclick="selectSvgTemplate(this, 'food')" aria-label="Select food template">
                                    <div style="width:100%; height:60px; background:linear-gradient(135deg,#f87171,#fb923c); border-radius:8px;"></div>
                                    <span style="font-size:0.75rem; margin-top:0.25rem;">Food</span>
                                </button>
                                <button type="button" class="svg-template-btn" data-template="nature" onclick="selectSvgTemplate(this, 'nature')" aria-label="Select nature template">
                                    <div style="width:100%; height:60px; background:linear-gradient(135deg,#10b981,#34d399); border-radius:8px;"></div>
                                    <span style="font-size:0.75rem; margin-top:0.25rem;">Nature</span>
                                </button>
                                <button type="button" class="svg-template-btn" data-template="premium" onclick="selectSvgTemplate(this, 'premium')" aria-label="Select premium template">
                                    <div style="width:100%; height:60px; background:linear-gradient(135deg,#facc15,#fbbf24); border-radius:8px;"></div>
                                    <span style="font-size:0.75rem; margin-top:0.25rem;">Premium</span>
                                </button>
                            </div>
                            <input type="hidden" name="vendor-product-template" id="vendor-product-template" value="" />
                        </div>
                        <div class="form-group" style="display:flex; gap:1rem; flex-wrap:wrap;">
                            <div style="flex:1; min-width:180px;">
                                <label class="form-label">Order deadline</label>
                                <input type="date" class="form-input" name="vendor-product-deadline" required />
                            </div>
                            <div style="flex:1; min-width:180px;">
                                <label class="form-label">Delivery date</label>
                                <input type="date" class="form-input" name="vendor-product-delivery" required />
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Target quantity</label>
                            <input type="number" class="form-input" name="vendor-product-target" min="5" value="20" required />
                        </div>
                        <button class="primary-cta" style="width:100%;">Create group buy</button>
                    </form>
                </div>
                <div class="view-content">
                    <div class="view-header">
                        <h3>My Orders</h3>
                        <div class="filter-bar" style="margin-bottom:0;">
                            <select id="vendor-order-status" class="form-select" onchange="handleVendorOrderStatus(event)">
                                <option value="all">All statuses</option>
                                <option value="pending">Pending</option>
                                <option value="confirmed">Confirmed</option>
                                <option value="prepared">Prepared</option>
                                <option value="delivered">Delivered</option>
                            </select>
                            <input id="vendor-order-search" class="form-input" type="text" placeholder="Search by customer name" oninput="handleVendorOrderSearch(event)" />
                        </div>
                    </div>
                    ${groupedHtml}
                </div>
            `;
        }

        /**
         * Logout
         */
        function logout() {
            (async () => {
                try {
                    if (supabaseClient) {
                        await supabaseClient.auth.signOut();
                    }
                } catch (e) {
                    console.error('Supabase sign-out error', e);
                }
            AppState.user = null;
                AppState.loginMethod = null;
            AppState.selectedRoles = new Set();
            AppState.helperStepIndex = 0;
                AppState.helperData = createHelperData();
                saveState();
            updateNavbar();
            goToScreen('start');
            })();
        }

        /**
         * Global exposure for inline handlers
         */
        window.goToScreen = goToScreen;
        window.handleEmailSignUp = handleEmailSignUp;
        window.handleStreamlinedSignUp = handleStreamlinedSignUp;
        window.toggleAuthMode = toggleAuthMode;
        window.skipLoginForTesting = skipLoginForTesting;
        window.handleFabClick = handleFabClick;
        window.handleCategoryFilter = handleCategoryFilter;
        window.handleGroupBuyCategory = handleGroupBuyCategory;
        window.handleGroupBuyPrice = handleGroupBuyPrice;
        window.handleGroupBuyStatus = handleGroupBuyStatus;
        window.handleErrandSearch = handleErrandSearch;
        window.handleErrandCategory = handleErrandCategory;
        window.handleErrandPrice = handleErrandPrice;
        window.handleErrandCategoryFilter = handleErrandCategoryFilter;
        window.setLanguage = setLanguage;
        window.t = t;
        window.toggleRole = toggleRole;
        window.continueAfterRole = continueAfterRole;
        window.saveHelperName = saveHelperName;
        window.handlePhotoUpload = handlePhotoUpload;
        window.saveHelperAddress = saveHelperAddress;
        window.sendVerificationCode = sendVerificationCode;
        window.verifySmsCode = verifySmsCode;
        window.completeHelperVerification = completeHelperVerification;
        window.handleGroupBuySearch = handleGroupBuySearch;
        window.handleGroupBuyRegion = handleGroupBuyRegion;
        window.handleGroupBuySort = handleGroupBuySort;
        window.openProductDetail = openProductDetail;
        window.openJoinGroupBuyModal = openJoinGroupBuyModal;
        window.submitJoinGroupBuy = submitJoinGroupBuy;
        window.openProductMessagesModal = openProductMessagesModal;
        window.submitProductMessage = submitProductMessage;
        window.handleCreateErrand = handleCreateErrand;
        window.handleErrandRegion = handleErrandRegion;
        window.handleErrandStatus = handleErrandStatus;
        window.handleErrandSort = handleErrandSort;
        window.openErrandDetail = openErrandDetail;
        window.openHelperApplyModal = openHelperApplyModal;
        window.submitHelperApplication = submitHelperApplication;
        window.acceptHelperApplication = acceptHelperApplication;
        window.declineHelperApplication = declineHelperApplication;
        window.cancelHelperApplication = cancelHelperApplication;
        window.markErrandInProgress = markErrandInProgress;
        window.completeErrand = completeErrand;
        window.handleAddProduct = handleAddProduct;
        window.selectSvgTemplate = selectSvgTemplate;
        window.cancelOrder = cancelOrder;
        window.updateFulfillmentStatus = updateFulfillmentStatus;
        window.resetApp = resetApp;
        window.confirmResetApp = confirmResetApp;
        window.closeModal = closeModal;
        window.handleCardKey = handleCardKey;
        window.logout = logout;

        document.addEventListener('DOMContentLoaded', () => { initApp(); });
    </script>
</body>
</html>

Non‑functional buttons/features